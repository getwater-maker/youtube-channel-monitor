<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë™ì˜ìƒ â†’ MP3 ì¶”ì¶œê¸°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 1.8em;
            color: #00d9ff;
            text-shadow: 0 0 10px rgba(0, 217, 255, 0.3);
        }

        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 25px;
            font-size: 0.9em;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-title {
            font-size: 1.1em;
            margin-bottom: 15px;
            color: #00d9ff;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ë“œë¡­ì¡´ */
        .dropzone {
            border: 2px dashed rgba(0, 217, 255, 0.4);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(0, 217, 255, 0.05);
        }

        .dropzone:hover, .dropzone.drag-over {
            border-color: #00d9ff;
            background: rgba(0, 217, 255, 0.1);
        }

        .dropzone-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .dropzone-text {
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .dropzone-hint {
            font-size: 0.85em;
            color: #888;
        }

        #fileInput {
            display: none;
        }

        /* íŒŒì¼ ë¦¬ìŠ¤íŠ¸ */
        .file-list {
            margin-top: 15px;
            max-height: 250px;
            overflow-y: auto;
        }

        .file-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .file-item:last-child {
            margin-bottom: 0;
        }

        .file-icon {
            font-size: 1.5em;
        }

        .file-info {
            flex: 1;
            min-width: 0;
        }

        .file-name {
            font-size: 0.95em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-size {
            font-size: 0.8em;
            color: #888;
        }

        .file-status {
            font-size: 0.85em;
            padding: 4px 10px;
            border-radius: 20px;
            white-space: nowrap;
        }

        .file-status.waiting {
            background: rgba(255, 255, 255, 0.1);
            color: #888;
        }

        .file-status.processing {
            background: rgba(255, 204, 0, 0.2);
            color: #ffcc00;
        }

        .file-status.done {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        .file-status.error {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }

        .file-remove {
            color: #ff6b6b;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background 0.2s;
        }

        .file-remove:hover {
            background: rgba(255, 107, 107, 0.2);
        }

        .file-download {
            color: #00ff88;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            text-decoration: none;
            transition: background 0.2s;
        }

        .file-download:hover {
            background: rgba(0, 255, 136, 0.2);
        }

        /* ì„¤ì • */
        .settings-row {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .setting-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .setting-item label {
            font-size: 0.95em;
        }

        select {
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 0.95em;
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: #00d9ff;
        }

        /* ë²„íŠ¼ */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00d9ff 0%, #0099cc 100%);
            color: #000;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 217, 255, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            color: #000;
            font-size: 1.1em;
            padding: 15px 40px;
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 255, 136, 0.4);
        }

        .btn:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .action-section {
            text-align: center;
            margin-top: 20px;
        }

        /* ì§„í–‰ ìƒí™© */
        .progress-container {
            margin-top: 15px;
            display: none;
        }

        .progress-container.active {
            display: block;
        }

        .progress-bar-bg {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            height: 25px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00d9ff 0%, #00ff88 100%);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85em;
            font-weight: bold;
            color: #000;
        }

        .progress-text {
            margin-top: 10px;
            font-size: 0.9em;
            color: #888;
            text-align: center;
        }

        /* ë¡œë”© */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(0, 217, 255, 0.2);
            border-top-color: #00d9ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            font-size: 1.1em;
        }

        .loading-hint {
            margin-top: 10px;
            font-size: 0.85em;
            color: #888;
        }

        /* ì•Œë¦¼ */
        .notice {
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 15px;
            font-size: 0.9em;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .notice-icon {
            font-size: 1.2em;
        }

        /* ìŠ¤í¬ë¡¤ë°” */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 217, 255, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 217, 255, 0.7);
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 600px) {
            h1 {
                font-size: 1.4em;
            }
            
            .dropzone {
                padding: 30px 15px;
            }
            
            .dropzone-icon {
                font-size: 2.5em;
            }
            
            .settings-row {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .btn-success {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">FFmpeg ë¡œë”© ì¤‘...</div>
        <div class="loading-hint">ì²˜ìŒ ì‹¤í–‰ ì‹œ ì•½ê°„ì˜ ì‹œê°„ì´ ì†Œìš”ë©ë‹ˆë‹¤</div>
    </div>

    <div class="container">
        <h1>ğŸ¬ ë™ì˜ìƒ â†’ MP3 ì¶”ì¶œê¸°</h1>
        <p class="subtitle">ë¸Œë¼ìš°ì €ì—ì„œ ë°”ë¡œ ë³€í™˜ Â· ì„¤ì¹˜ ë¶ˆí•„ìš” Â· íŒŒì¼ì´ ì„œë²„ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŒ</p>

        <div class="notice">
            <span class="notice-icon">ğŸ’¡</span>
            <span>ëª¨ë“  ë³€í™˜ì€ ë¸Œë¼ìš°ì € ë‚´ì—ì„œ ì²˜ë¦¬ë˜ë©°, íŒŒì¼ì´ ì™¸ë¶€ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ëŒ€ìš©ëŸ‰ íŒŒì¼ì€ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
        </div>

        <!-- íŒŒì¼ ì„ íƒ -->
        <div class="card">
            <div class="card-title">ğŸ“ íŒŒì¼ ì„ íƒ</div>
            <div class="dropzone" id="dropzone">
                <div class="dropzone-icon">ğŸ“‚</div>
                <div class="dropzone-text">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</div>
                <div class="dropzone-hint">MP4, AVI, MKV, MOV, WebM ë“± ì§€ì›</div>
            </div>
            <input type="file" id="fileInput" multiple accept="video/*,.mp4,.avi,.mkv,.mov,.wmv,.flv,.webm,.m4v,.mpeg,.mpg,.3gp">
            
            <div class="file-list" id="fileList"></div>
        </div>

        <!-- ì„¤ì • -->
        <div class="card">
            <div class="card-title">âš™ï¸ ì„¤ì •</div>
            <div class="settings-row">
                <div class="setting-item">
                    <label for="bitrate">ë¹„íŠ¸ë ˆì´íŠ¸:</label>
                    <select id="bitrate">
                        <option value="128">128 kbps</option>
                        <option value="192" selected>192 kbps</option>
                        <option value="256">256 kbps</option>
                        <option value="320">320 kbps</option>
                    </select>
                </div>
            </div>

            <!-- ì§„í–‰ ìƒí™© -->
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar-bg">
                    <div class="progress-bar" id="progressBar">0%</div>
                </div>
                <div class="progress-text" id="progressText">ì¤€ë¹„ ì¤‘...</div>
            </div>
        </div>

        <!-- ì‹¤í–‰ ë²„íŠ¼ -->
        <div class="action-section">
            <button class="btn btn-success" id="convertBtn" disabled>
                ğŸš€ MP3 ì¶”ì¶œ ì‹œì‘
            </button>
        </div>
    </div>

    <!-- FFmpeg.wasm -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.js"></script>
    <script src="https://unpkg.com/@ffmpeg/util@0.12.1/dist/umd/index.js"></script>
    
    <script>
        const { FFmpeg } = FFmpegWASM;
        const { fetchFile } = FFmpegUtil;

        let ffmpeg = null;
        let files = [];
        let isProcessing = false;

        // DOM ìš”ì†Œ
        const loadingOverlay = document.getElementById('loadingOverlay');
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const convertBtn = document.getElementById('convertBtn');
        const bitrateSelect = document.getElementById('bitrate');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');

        // FFmpeg ì´ˆê¸°í™”
        async function initFFmpeg() {
            ffmpeg = new FFmpeg();
            
            ffmpeg.on('log', ({ message }) => {
                console.log(message);
            });

            ffmpeg.on('progress', ({ progress }) => {
                const percent = Math.round(progress * 100);
                progressBar.style.width = percent + '%';
                progressBar.textContent = percent + '%';
            });

            try {
                await ffmpeg.load({
                    coreURL: 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.js',
                    wasmURL: 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.wasm',
                });
                loadingOverlay.classList.add('hidden');
                console.log('FFmpeg ë¡œë“œ ì™„ë£Œ');
            } catch (error) {
                console.error('FFmpeg ë¡œë“œ ì‹¤íŒ¨:', error);
                loadingOverlay.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 3em; margin-bottom: 20px;">âŒ</div>
                        <div style="font-size: 1.2em; margin-bottom: 10px;">FFmpeg ë¡œë“œ ì‹¤íŒ¨</div>
                        <div style="color: #888; font-size: 0.9em;">ë¸Œë¼ìš°ì €ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ë‹¤ë¥¸ ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.</div>
                        <div style="color: #666; font-size: 0.8em; margin-top: 15px;">Chrome, Edge, Firefox ìµœì‹  ë²„ì „ ê¶Œì¥</div>
                    </div>
                `;
            }
        }

        // íŒŒì¼ í¬ê¸° í¬ë§·
        function formatSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // íŒŒì¼ëª…ì—ì„œ í™•ì¥ì ì œê±°
        function removeExtension(filename) {
            return filename.replace(/\.[^/.]+$/, '');
        }

        // íŒŒì¼ ëª©ë¡ ë Œë”ë§
        function renderFileList() {
            if (files.length === 0) {
                fileList.innerHTML = '';
                convertBtn.disabled = true;
                return;
            }

            fileList.innerHTML = files.map((file, index) => `
                <div class="file-item" data-index="${index}">
                    <span class="file-icon">ğŸ¬</span>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${formatSize(file.size)}</div>
                    </div>
                    <span class="file-status ${file.status}">${getStatusText(file.status)}</span>
                    ${file.status === 'done' && file.downloadUrl ? 
                        `<a class="file-download" href="${file.downloadUrl}" download="${file.outputName}">ğŸ’¾ ì €ì¥</a>` : 
                        `<span class="file-remove" onclick="removeFile(${index})">âœ•</span>`
                    }
                </div>
            `).join('');

            convertBtn.disabled = isProcessing || files.every(f => f.status === 'done');
        }

        // ìƒíƒœ í…ìŠ¤íŠ¸
        function getStatusText(status) {
            switch (status) {
                case 'waiting': return 'ëŒ€ê¸° ì¤‘';
                case 'processing': return 'ë³€í™˜ ì¤‘...';
                case 'done': return 'ì™„ë£Œ âœ“';
                case 'error': return 'ì˜¤ë¥˜';
                default: return '';
            }
        }

        // íŒŒì¼ ì¶”ê°€
        function addFiles(newFiles) {
            for (const file of newFiles) {
                // ì¤‘ë³µ ì²´í¬
                if (files.some(f => f.name === file.name && f.size === file.size)) {
                    continue;
                }
                
                files.push({
                    file: file,
                    name: file.name,
                    size: file.size,
                    status: 'waiting',
                    downloadUrl: null,
                    outputName: removeExtension(file.name) + '.mp3'
                });
            }
            renderFileList();
        }

        // íŒŒì¼ ì œê±°
        function removeFile(index) {
            if (files[index].downloadUrl) {
                URL.revokeObjectURL(files[index].downloadUrl);
            }
            files.splice(index, 1);
            renderFileList();
        }

        // ë³€í™˜ ì‹¤í–‰
        async function convertFiles() {
            if (isProcessing || !ffmpeg) return;
            
            isProcessing = true;
            convertBtn.disabled = true;
            progressContainer.classList.add('active');

            const bitrate = bitrateSelect.value;
            const waitingFiles = files.filter(f => f.status === 'waiting');
            
            for (let i = 0; i < waitingFiles.length; i++) {
                const fileObj = waitingFiles[i];
                const index = files.indexOf(fileObj);
                
                progressText.textContent = `${i + 1}/${waitingFiles.length} - ${fileObj.name} ë³€í™˜ ì¤‘...`;
                progressBar.style.width = '0%';
                progressBar.textContent = '0%';
                
                fileObj.status = 'processing';
                renderFileList();

                try {
                    const inputName = 'input_' + Date.now() + '_' + fileObj.name;
                    const outputName = 'output_' + Date.now() + '.mp3';

                    // íŒŒì¼ ì“°ê¸°
                    await ffmpeg.writeFile(inputName, await fetchFile(fileObj.file));

                    // ë³€í™˜ ì‹¤í–‰
                    await ffmpeg.exec([
                        '-i', inputName,
                        '-vn',
                        '-acodec', 'libmp3lame',
                        '-ab', bitrate + 'k',
                        '-ar', '44100',
                        outputName
                    ]);

                    // ê²°ê³¼ ì½ê¸°
                    const data = await ffmpeg.readFile(outputName);
                    const blob = new Blob([data.buffer], { type: 'audio/mp3' });
                    
                    fileObj.downloadUrl = URL.createObjectURL(blob);
                    fileObj.status = 'done';

                    // ì •ë¦¬
                    await ffmpeg.deleteFile(inputName);
                    await ffmpeg.deleteFile(outputName);

                } catch (error) {
                    console.error('ë³€í™˜ ì˜¤ë¥˜:', error);
                    fileObj.status = 'error';
                }

                renderFileList();
            }

            progressText.textContent = 'ì™„ë£Œ!';
            progressBar.style.width = '100%';
            progressBar.textContent = '100%';
            
            isProcessing = false;
            convertBtn.disabled = files.every(f => f.status === 'done');

            // 3ì´ˆ í›„ ì§„í–‰ ë°” ìˆ¨ê¹€
            setTimeout(() => {
                if (!isProcessing) {
                    progressContainer.classList.remove('active');
                }
            }, 3000);
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        dropzone.addEventListener('click', () => fileInput.click());

        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('drag-over');
        });

        dropzone.addEventListener('dragleave', () => {
            dropzone.classList.remove('drag-over');
        });

        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('drag-over');
            addFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            addFiles(e.target.files);
            fileInput.value = '';
        });

        convertBtn.addEventListener('click', convertFiles);

        // ì´ˆê¸°í™”
        initFFmpeg();
    </script>
</body>
</html>
