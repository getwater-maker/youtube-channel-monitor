<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>로이가 만든 유튜브 채널 모니터</title>
  <link rel="icon" href="favicon.svg" />
  
  <!-- 외부 라이브러리 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.45/moment-timezone-with-data.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.js"></script>

  <style>
    :root {
      --brand: #c4302b;
      --brand-hover: #a02622;
      --gradient-brand: linear-gradient(135deg, #c4302b, #a02622);
      --glass-bg: rgba(255, 255, 255, 0.05);
      --border: #4a5568;
      --card: #2d3748;
      --text: #e4e6ea;
      --muted: #a0aec0;
      --bg: #1a1a1a;
    }

    .light {
      --glass-bg: rgba(0, 0, 0, 0.05);
      --border: #dee2e6;
      --card: #ffffff;
      --text: #333333;
      --muted: #6c757d;
      --bg: #f8f9fa;
    }

    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }

    .container { 
      max-width: 1400px; 
      margin: 0 auto; 
      padding: 20px; 
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 16px;
      margin-bottom: 24px;
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      width: 32px;
      height: 32px;
      border-radius: 8px;
    }

    .logo-section h1 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 800;
      background: var(--gradient-brand);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .nav-buttons {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .three-col { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); 
      gap: 24px; 
    }

    .col { 
      background: var(--card); 
      border-radius: 16px; 
      padding: 20px; 
      border: 2px solid var(--border); 
    }

    .col-head { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 16px;
      cursor: move;
    }

    .col-head h2 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 700;
    }

    .col-actions { 
      display: flex; 
      gap: 8px; 
      align-items: center; 
      flex-wrap: wrap; 
    }

    .btn { 
      padding: 8px 16px; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      font-weight: 600; 
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
      font-size: 14px;
    }

    .btn-primary { 
      background: var(--gradient-brand); 
      color: white; 
      box-shadow: 0 4px 15px rgba(196, 48, 43, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(196, 48, 43, 0.4);
    }

    .btn-secondary { 
      background: var(--glass-bg); 
      color: var(--text); 
      border: 2px solid var(--border); 
    }

    .btn-secondary:hover {
      background: var(--border);
      border-color: var(--brand);
      transform: translateY(-1px);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ff4757, #c44569);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
    }

    .btn-danger:hover {
      background: linear-gradient(135deg, #ff3742, #b73e56);
      transform: translateY(-1px);
    }

    .sort-row {
      padding: 12px 16px;
      background: var(--glass-bg);
      border-radius: 8px;
      margin-bottom: 16px;
      border: 1px solid var(--border);
    }

    .sort-row label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      color: var(--text);
      font-size: 14px;
    }

    .sort-row select {
      padding: 6px 12px;
      border: 2px solid var(--border);
      border-radius: 6px;
      background: var(--card);
      color: var(--text);
      font-weight: 600;
      cursor: pointer;
    }

    .empty-state { 
      text-align: center; 
      padding: 60px 20px; 
      color: var(--muted);
      background: var(--glass-bg);
      border-radius: 16px;
      border: 2px dashed var(--border);
      margin: 20px 0;
    }

    .empty-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.6;
    }

    .empty-state .muted {
      font-size: 16px;
      margin-bottom: 20px;
      color: var(--muted);
    }

    .channel-card {
      display: flex;
      gap: 16px;
      align-items: center;
      padding: 16px;
      border: 2px solid var(--border);
      border-radius: 12px;
      margin-bottom: 12px;
      background: var(--card);
      transition: all 0.3s;
    }

    .channel-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      border-color: var(--brand);
    }

    .channel-thumb {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      object-fit: cover;
      border: 2px solid var(--border);
    }

    .channel-meta {
      flex: 1;
    }

    .channel-meta h3 {
      margin: 0 0 8px 0;
      font-size: 1.1rem;
      font-weight: 700;
    }

    .channel-meta h3 a {
      color: var(--text);
      text-decoration: none;
    }

    .channel-meta .row {
      display: flex;
      gap: 16px;
      margin-bottom: 8px;
      flex-wrap: wrap;
      font-size: 13px;
      color: var(--muted);
    }

    .channel-meta .row strong {
      color: var(--text);
      font-weight: 700;
    }

    .channel-meta .latest {
      font-size: 12px;
      color: var(--muted);
    }

    .channel-actions {
      display: flex;
      gap: 8px;
    }

    .channel-insights {
      width: 100%;
      margin-top: 12px;
      padding: 12px;
      background: var(--glass-bg);
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .insights {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 8px;
      font-size: 11px;
    }

    .insights > div {
      display: flex;
      justify-content: space-between;
      padding: 4px 6px;
      background: var(--card);
      border-radius: 4px;
    }

    .insights .k {
      color: var(--muted);
      font-weight: 500;
    }

    .insights .v {
      font-weight: 700;
      color: var(--text);
    }

    .insights .v.positive { color: #1db954; }
    .insights .v.negative { color: #c4302b; }
    .insights .v.neutral { color: var(--text); }

    .video-card {
      border: 2px solid var(--border);
      border-radius: 12px;
      margin-bottom: 12px;
      background: var(--card);
      overflow: hidden;
      transition: all 0.3s;
    }

    .video-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      border-color: var(--brand);
    }

    .video-link {
      display: block;
      padding: 12px;
      text-decoration: none;
      color: inherit;
    }

    .thumb-wrap {
      position: relative;
      margin-bottom: 8px;
    }

    .thumb {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
    }

    .v-title {
      font-weight: 700;
      font-size: 14px;
      line-height: 1.4;
      margin-bottom: 8px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .v-meta {
      font-size: 12px;
      color: var(--muted);
    }

    .v-meta-top {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .v-meta-bottom {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .mutant-badge {
      background: linear-gradient(135deg, #ffa502, #ff6348);
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 700;
    }

    .mutant-indicator {
      color: var(--muted);
      font-size: 10px;
    }

    .video-done-checkbox {
      font-size: 10px;
      cursor: pointer;
    }

    .keywords {
      margin-bottom: 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .kw {
      background: var(--glass-bg);
      color: var(--text);
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      border: 1px solid var(--border);
    }

    .pagination { 
      display: flex; 
      gap: 8px; 
      justify-content: center; 
      margin-top: 16px; 
      flex-wrap: wrap;
    }

    .page-btn { 
      padding: 8px 12px; 
      border: 2px solid var(--border); 
      background: var(--card); 
      color: var(--text);
      border-radius: 8px; 
      cursor: pointer;
      font-weight: 600;
      min-width: 40px;
      transition: all 0.3s;
    }

    .page-btn:hover {
      background: var(--glass-bg);
      border-color: var(--brand);
      transform: translateY(-1px);
    }

    .page-btn.active { 
      background: var(--gradient-brand); 
      color: white; 
      border-color: var(--brand);
      box-shadow: 0 4px 12px rgba(196, 48, 43, 0.3);
    }

    .modal { 
      display: none; 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.7); 
      z-index: 1000; 
      align-items: center; 
      justify-content: center; 
    }

    .modal-content { 
      background: var(--card); 
      color: var(--text);
      padding: 24px; 
      border-radius: 16px; 
      max-width: 500px; 
      width: 90%; 
      max-height: 80vh; 
      overflow-y: auto;
      border: 2px solid var(--border);
    }

    .modal-large { 
      max-width: 800px; 
    }

    .close { 
      float: right; 
      font-size: 24px; 
      cursor: pointer; 
      color: var(--muted);
    }

    .close:hover {
      color: var(--brand);
    }

    .modal-description {
      color: var(--muted);
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .input-group {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .input-group input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: 8px;
      background: var(--card);
      color: var(--text);
      font-size: 14px;
    }

    .input-group input:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(196, 48, 43, 0.1);
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .add-tabs {
      display: flex;
      border-bottom: 2px solid var(--border);
      margin-bottom: 20px;
    }

    .add-tab {
      padding: 12px 20px;
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-weight: 600;
      border-bottom: 2px solid transparent;
      transition: all 0.3s;
    }

    .add-tab.active {
      color: var(--brand);
      border-bottom-color: var(--brand);
    }

    .add-tab-content {
      display: none;
    }

    .add-tab-content.active {
      display: block;
    }

    .examples {
      margin-top: 20px;
      padding: 16px;
      background: var(--glass-bg);
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .examples h4 {
      margin: 0 0 12px 0;
      color: var(--text);
      font-size: 14px;
    }

    .examples ul {
      margin: 0;
      padding-left: 20px;
    }

    .examples li {
      margin-bottom: 8px;
      font-size: 13px;
      color: var(--muted);
    }

    .examples code {
      background: var(--card);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
      color: var(--brand);
      border: 1px solid var(--border);
    }

    .date-range {
      display: flex;
      gap: 4px;
    }

    .date-range button {
      padding: 6px 12px;
      border: 2px solid var(--border);
      background: var(--card);
      color: var(--text);
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s;
    }

    .date-range button:hover {
      border-color: var(--brand);
    }

    .date-range button.active {
      background: var(--gradient-brand);
      color: white;
      border-color: var(--brand);
    }

    .channel-count-wrapper {
      font-weight: 600;
      color: var(--text);
      background: var(--glass-bg);
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      font-size: 14px;
    }

    .channel-count-wrapper #channel-count {
      color: var(--brand);
      font-weight: 700;
    }

    #toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      pointer-events: none;
      max-width: 400px;
    }

    .loading-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border);
      border-top: 3px solid var(--brand);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 16px;
        text-align: center;
      }
      
      .nav-buttons {
        width: 100%;
        justify-content: center;
        flex-wrap: wrap;
      }
      
      .three-col {
        grid-template-columns: 1fr;
      }
      
      .col-actions {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }
      
      .channel-card {
        flex-direction: column;
        text-align: center;
      }
      
      .channel-meta .row {
        justify-content: center;
      }
    }
  </style>
</head>

<body class="dark">
  <div class="container">
    <header>
      <div class="header-content">
        <div class="logo-section">
          <div style="width: 32px; height: 32px; background: var(--gradient-brand); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800;">Y</div>
          <h1>유튜브 채널 모니터</h1>
        </div>
        <nav class="nav-buttons">
          <button id="btn-analyze" class="btn btn-primary">📊 채널 분석</button>
          <button id="btn-toggle-theme" class="btn btn-secondary">라이트 모드</button>
          <button id="btn-api" class="btn btn-secondary">🔑 API 키</button>
        </nav>
      </div>
    </header>

    <main id="main-content" class="three-col">
      <!-- 채널 섹션 -->
      <section class="col" data-col="channels">
        <div class="col-head" draggable="true">
          <h2>📺 채널 관리</h2>
          <div class="col-actions">
            <button id="btn-add-channel" class="btn btn-primary">+ 채널 추가</button> 
            <button id="btn-export-channels" class="btn btn-secondary">📥 내보내기</button> 
            <button id="btn-import-channels" class="btn btn-secondary">📤 가져오기</button> 
            <input type="file" id="file-import-channels" accept="application/json" style="display:none" />
            <span class="channel-count-wrapper">등록: <span id="channel-count">0</span>개</span>
          </div>
        </div>
        <div class="sort-row">
          <label for="sort-channels">정렬:
            <select id="sort-channels">
              <option value="subscribers" selected>구독자수</option>
              <option value="videos">영상갯수</option>
              <option value="latest">최근업로드</option>
            </select>
          </label>
        </div>
        <div id="channel-list" class="channel-list">
          <div class="empty-state">
            <div class="empty-icon">📺</div>
            <p class="muted">채널을 추가하여 시작하세요</p>
            <button class="btn btn-primary" onclick="document.getElementById('btn-add-channel').click()">첫 채널 추가하기</button>
          </div>
        </div>
        <div id="channel-pagination" class="pagination"></div>
      </section>

      <!-- 돌연변이 영상 섹션 -->
      <section class="col" data-col="mutant">
        <div class="col-head" draggable="true">
          <h2>🚀 돌연변이 영상</h2>
          <div class="col-actions">
            <div class="date-range">
              <button data-period="1m">1개월</button>
              <button data-period="3m">3개월</button>
              <button class="active" data-period="6m">6개월</button>
              <button data-period="all">전체</button>
            </div>
          </div>
        </div>
        <div class="sort-row">
          <label for="sort-mutant">정렬:
            <select id="sort-mutant">
              <option value="mutantIndex" selected>돌연변이지수</option>
              <option value="views">조회수</option>
              <option value="subscribers">구독자수</option>
              <option value="latest">최근업로드</option>
            </select>
          </label>
        </div>
        <div id="mutant-keywords" class="keywords"></div>
        <div id="mutant-list" class="video-list">
          <div class="empty-state">
            <div class="empty-icon">🚀</div>
            <p class="muted">채널을 추가하여 영상을 분석해주세요</p>
          </div>
        </div>
        <div id="mutant-pagination" class="pagination"></div>
      </section>

      <!-- 최신 영상 섹션 -->
      <section class="col" data-col="latest">
        <div class="col-head" draggable="true">
          <h2>📱 최신 영상</h2>
        </div>
        <div class="sort-row">
          <label for="sort-latest">정렬:
            <select id="sort-latest">
              <option value="views" selected>조회수</option>
              <option value="subscribers">구독자수</option>
              <option value="latest">최근업로드</option>
              <option value="mutantIndex">돌연변이지수</option>
            </select>
          </label>
        </div>
        <div id="latest-keywords" class="keywords"></div>
        <div id="latest-list" class="video-list">
          <div class="empty-state">
            <div class="empty-icon">📱</div>
            <p class="muted">채널을 추가하여 영상을 분석해주세요</p>
          </div>
        </div>
        <div id="latest-pagination" class="pagination"></div>
      </section>
    </main>
  </div>

  <!-- API 키 모달 -->
  <div id="modal-api" class="modal">
    <div class="modal-content">
      <span class="close" data-close="modal-api">&times;</span>
      <h3>🔑 YouTube API 키 설정</h3>
      <p class="modal-description">
        YouTube Data API v3 키를 입력하세요. 
        <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color: var(--brand);">Google Cloud Console</a>에서 발급받을 수 있습니다.
      </p>
      
      <div class="api-input-section">
        <div id="api-inputs"></div>
      </div>
      
      <div class="modal-actions">
        <button id="api-save" class="btn btn-primary">💾 저장</button>
        <button id="api-test" class="btn btn-secondary">🧪 테스트</button>
      </div>
      <div id="api-test-result" style="margin-top: 16px; padding: 12px; border-radius: 8px;"></div>
    </div>
  </div>

  <!-- 채널 추가 모달 -->
  <div id="modal-add" class="modal">
    <div class="modal-content modal-large">
      <span class="close" data-close="modal-add">&times;</span>
      <h3>📺 채널 추가</h3>
      
      <!-- 탭 메뉴 -->
      <div class="add-tabs">
        <button class="add-tab active" data-add-tab="url">URL/ID 직접 입력</button>
      </div>
      
      <!-- URL 직접 입력 -->
      <div id="add-tab-url" class="add-tab-content active">
        <div class="input-group">
          <input type="text" id="url-input" placeholder="채널 URL, ID, @핸들, 영상 URL 등을 입력하세요" />
          <button id="btn-url-add" class="btn btn-primary">추가</button>
        </div>
        <div id="url-result"></div>
        <div class="examples">
          <h4>입력 예시:</h4>
          <ul>
            <li>채널 ID: <code>UC_x5XG1OV2P6uZZ5FSM9Ttw</code></li>
            <li>채널 URL: <code>https://youtube.com/channel/UC_x5XG1OV2P6uZZ5FSM9Ttw</code></li>
            <li>핸들: <code>@GoogleDevelopers</code></li>
            <li>영상 URL: <code>https://youtube.com/watch?v=dQw4w9WgXcQ</code></li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- 분석 모달 -->
  <div id="modal-analyze" class="modal">
    <div class="modal-content">
      <span class="close" data-close="modal-analyze">&times;</span>
      <h3>📊 채널 분석</h3>
      <p class="modal-description">분석할 채널을 선택하세요. 심층 분석에는 시간이 소요될 수 있습니다.</p>
      <div id="analyze-channel-list" class="analyze-list"></div>
    </div>
  </div>

  <script>
    // 전역 설정 및 상태
    window.CONFIG = {
      API_BASE: 'https://www.googleapis.com/youtube/v3/',
      PAGINATION: {
        CHANNELS: 8,
        VIDEOS: 5
      },
      TIMEOUT: 30000,
      MUTANT_THRESHOLD: 2.0
    };

    window.state = {
      currentMutantPeriod: '6m',
      currentView: 'home',
      currentPage: {
        channels: 1,
        mutant: 1,
        latest: 1
      }
    };

    // API 키 관리
    window.apiKeys = JSON.parse(localStorage.getItem('youtubeApiKeys') || '[]');
    window.keyIdx = 0;

    // 유틸리티 함수들
    window.qs = function(selector, scope = document) {
      try {
        if (selector.startsWith('#')) {
          return scope.getElementById ? scope.getElementById(selector.slice(1)) : scope.querySelector(selector);
        }
        return scope.querySelector(selector);
      } catch (e) {
        console.warn(`Element '${selector}' not found:`, e);
        return null;
      }
    };

    window.fmt = function(n) {
      if (!n && n !== 0) return '0';
      const num = parseInt(n.toString().replace(/,/g, ''), 10);
      if (isNaN(num)) return '0';
      return num.toLocaleString('ko-KR');
    };

    window.toast = function(msg, type = 'info', duration = 3000) {
      console.log('[TOAST]', msg);
      
      let container = document.getElementById('toast-container');
      if (!container) {
        container = document.createElement('div');
        container.id = 'toast-container';
        container.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          z-index: 10000;
          pointer-events: none;
          max-width: 400px;
        `;
        document.body.appendChild(container);
      }
      
      const toastEl = document.createElement('div');
      const typeConfig = {
        success: { icon: '✅', color: '#1db954' },
        error: { icon: '❌', color: '#c4302b' },
        warning: { icon: '⚠️', color: '#ffa502' },
        info: { icon: 'ℹ️', color: '#667eea' }
      };
      
      const config = typeConfig[type] || typeConfig.info;
      
      toastEl.innerHTML = `
        <div style="
          display: flex; 
          align-items: center; 
          gap: 12px;
          background: var(--card);
          color: var(--text);
          border: 2px solid ${config.color};
          border-radius: 12px;
          padding: 16px 20px;
          margin-bottom: 12px;
          font-size: 14px;
          font-weight: 600;
          box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
          transform: translateX(100%);
          transition: transform 0.3s ease;
          pointer-events: auto;
          cursor: pointer;
        ">
          <span style="font-size: 16px;">${config.icon}</span>
          <span>${msg}</span>
        </div>
      `;
      
      container.appendChild(toastEl);
      
      setTimeout(() => {
        toastEl.style.transform = 'translateX(0)';
      }, 10);
      
      const remove = () => {
        toastEl.style.transform = 'translateX(100%)';
        setTimeout(() => {
          if (toastEl.parentNode) {
            toastEl.parentNode.removeChild(toastEl);
          }
        }, 300);
      };
      
      setTimeout(remove, duration);
      toastEl.onclick = remove;
    };

    window.truncateText = function(text, maxLength = 30) {
      if (!text) return '';
      return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    };

    window.extractKeywords = function(text) {
      if (!text) return [];
      
      const stopWords = new Set([
        '그리고', '하지만', '그러나', '또한', '이제', '그때', '이것', '저것', '여기', '거기',
        '이런', '저런', '같은', '다른', '새로운', '오래된', '큰', '작은', '좋은', '나쁜',
        '많은', '적은', '빠른', '느린', '쉬운', '어려운', '중요한', '필요한', '가능한'
      ]);

      const words = text
        .replace(/[^\w\s가-힣]/g, ' ')
        .split(/\s+/)
        .filter(w => w.length >= 2 && !stopWords.has(w) && !/^\d+$/.test(w))
        .map(w => w.toLowerCase());

      const freq = {};
      words.forEach(w => freq[w] = (freq[w] || 0) + 1);

      return Object.entries(freq)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 20);
    };

    window.seconds = function(iso) {
      if (!iso) return 0;
      const match = iso.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
      if (!match) return 0;
      const h = parseInt(match[1] || '0', 10);
      const m = parseInt(match[2] || '0', 10);
      const s = parseInt(match[3] || '0', 10);
      return h * 3600 + m * 60 + s;
    };

    // API 키 관리 함수
    window.setApiKeys = function(keys) {
      window.apiKeys = keys.filter(Boolean);
      window.keyIdx = 0;
      localStorage.setItem('youtubeApiKeys', JSON.stringify(window.apiKeys));
    };

    window.nextKey = function() { 
      if (window.apiKeys.length > 1) window.keyIdx = (window.keyIdx + 1) % window.apiKeys.length; 
    };

    window.hasKeys = function() { 
      return window.apiKeys.length > 0; 
    };

    // IndexedDB 관리
    window.db = null;

    function openDB() { 
      return new Promise((res, rej) => { 
        if (window.db) return res(window.db); 
        const r = indexedDB.open('myChannelDB', 4);
        
        r.onupgradeneeded = e => { 
          window.db = e.target.result;
          if (!window.db.objectStoreNames.contains('my_channels')) {
            window.db.createObjectStore('my_channels', { keyPath: 'id' });
          }
          if (!window.db.objectStoreNames.contains('insights')) {
            window.db.createObjectStore('insights', { keyPath: 'channelId' });
          }
          if (!window.db.objectStoreNames.contains('dailySubs')) {
            window.db.createObjectStore('dailySubs', { keyPath: ['channelId', 'date'] });
          }
          if (!window.db.objectStoreNames.contains('doneVideos')) {
            window.db.createObjectStore('doneVideos', { keyPath: ['channelId', 'videoId'] });
          }
        };
        
        r.onsuccess = e => { 
          window.db = e.target.result; 
          res(window.db); 
        };
        
        r.onerror = e => rej(e);
      });
    }

    function idbAll(store) { 
      return openDB().then(db => new Promise((res, rej) => { 
        const tx = db.transaction(store, 'readonly'); 
        const s = tx.objectStore(store); 
        const q = s.getAll(); 
        q.onsuccess = () => res(q.result); 
        q.onerror = () => rej(q.error);
      })); 
    }

    function idbGet(store, key) { 
      return openDB().then(db => new Promise((res, rej) => { 
        const tx = db.transaction(store, 'readonly'); 
        const s = tx.objectStore(store); 
        const q = s.get(key); 
        q.onsuccess = () => res(q.result); 
        q.onerror = () => rej(q.error);
      })); 
    }

    function idbPut(store, obj) { 
      return openDB().then(db => new Promise((res, rej) => { 
        try { 
          const tx = db.transaction(store, 'readwrite'); 
          const s = tx.objectStore(store); 
          const q = s.put(obj); 
          q.onsuccess = () => res(); 
          q.onerror = () => rej(q.error); 
          tx.onerror = () => rej(tx.error);
        } catch (e) {
          rej(e);
        } 
      })); 
    }

    function idbDel(store, key) { 
      return openDB().then(db => new Promise((res, rej) => { 
        const tx = db.transaction(store, 'readwrite'); 
        const s = tx.objectStore(store); 
        const q = s.delete(key); 
        q.onsuccess = () => res(); 
        q.onerror = () => rej(q.error);
      })); 
    }

    // YouTube API 호출
    async function yt(endpoint, params, attempt = 0) {
      if (!window.hasKeys()) {
        throw new Error('API 키가 설정되지 않았습니다. API 키를 먼저 입력해주세요.');
      }
      
      const ctrl = new AbortController();
      const timeout = setTimeout(() => ctrl.abort('timeout'), window.CONFIG.TIMEOUT);
      
      const p = new URLSearchParams(params);
      p.set('key', window.apiKeys[window.keyIdx]);
      const url = window.CONFIG.API_BASE + endpoint + '?' + p.toString();
      
      try {
        const r = await fetch(url, { signal: ctrl.signal });
        const data = await r.json();
        clearTimeout(timeout);
        
        if (data.error) {
          if (data.error.code === 403 && /quota/i.test(data.error.message || '')) {
            throw new Error('API 할당량이 초과되었습니다.');
          }
          if (attempt < window.apiKeys.length - 1) {
            window.nextKey();
            return yt(endpoint, params, attempt + 1);
          }
          throw new Error(data.error.message || 'API 오류');
        }
        return data;
      } catch (e) {
        clearTimeout(timeout);
        if (attempt < window.apiKeys.length - 1) {
          window.nextKey();
          return yt(endpoint, params, attempt + 1);
        }
        throw e;
      }
    }

    // UI 관리 함수
    function openModal(id) { 
      const modal = qs('#' + id);
      if (modal) {
        modal.style.display = 'flex';
      }
    }

    function closeModal(id) { 
      const modal = qs('#' + id);
      if (modal) {
        modal.style.display = 'none';
      }
    }

    function loadTheme() {
      const savedTheme = localStorage.getItem('theme') || 'dark';
      const body = document.body;
      const btn = qs('#btn-toggle-theme');
      
      body.classList.remove('dark', 'light');
      body.classList.add(savedTheme);
      
      if (btn) {
        btn.textContent = savedTheme === 'dark' ? '라이트 모드' : '다크 모드';
      }
    }

    function toggleTheme() {
      const body = document.body;
      const btn = qs('#btn-toggle-theme');
      
      if (body.classList.contains('dark')) {
        body.classList.remove('dark');
        body.classList.add('light');
        if (btn) btn.textContent = '다크 모드';
        localStorage.setItem('theme', 'light');
      } else {
        body.classList.remove('light');
        body.classList.add('dark');
        if (btn) btn.textContent = '라이트 모드';
        localStorage.setItem('theme', 'dark');
      }
    }

    // 채널 관리 함수
    async function getAllChannels() {
      return idbAll('my_channels');
    }

    async function deleteChannel(id) {
      await idbDel('my_channels', id);
      await idbDel('insights', id);
    }

    function sortChannels(list, mode) {
      if (mode === 'videos') {
        list.sort((a, b) => parseInt(b.videoCount || '0') - parseInt(a.videoCount || '0'));
      } else if (mode === 'latest') {
        list.sort((a, b) => new Date(b.latestUploadDate || 0) - new Date(a.latestUploadDate || 0));
      } else {
        list.sort((a, b) => parseInt(b.subscriberCount || '0') - parseInt(a.subscriberCount || '0'));
      }
    }

    async function getYesterdaySubCount(ch) {
      const y = moment().subtract(1, 'day').format('YYYY-MM-DD');
      const rec = await idbGet('dailySubs', [ch.id, y]);
      return rec ? rec.subCount : null;
    }

    async function updateDailySubSnapshot(ch) {
      const today = moment().format('YYYY-MM-DD');
      const ex = await idbGet('dailySubs', [ch.id, today]);
      if (!ex) {
        await idbPut('dailySubs', {
          channelId: ch.id,
          date: today,
          subCount: parseInt(ch.subscriberCount || '0', 10)
        });
      }
    }

    async function addChannelById(channelId) {
      if (!channelId) {
        toast('올바른 채널 ID가 아닙니다.', 'error');
        return false;
      }

      const exist = await idbGet('my_channels', channelId);
      if (exist) {
        toast('이미 등록된 채널입니다.', 'warning');
        return false;
      }

      try {
        const ch = await yt('channels', {
          part: 'snippet,statistics,contentDetails',
          id: channelId
        });

        const it = ch.items?.[0];
        if (!it) throw new Error('채널을 찾을 수 없습니다.');

        const uploads = it.contentDetails?.relatedPlaylists?.uploads || '';
        let latest = it.snippet.publishedAt;

        if (uploads) {
          try {
            const pl = await yt('playlistItems', {
              part: 'snippet',
              playlistId: uploads,
              maxResults: 1
            });
            if (pl.items && pl.items[0]) {
              latest = pl.items[0].snippet.publishedAt || latest;
            }
          } catch {}
        }

        const data = {
          id: it.id,
          title: it.snippet.title,
          thumbnail: it.snippet.thumbnails?.default?.url || '',
          subscriberCount: it.statistics.subscriberCount || '0',
          videoCount: it.statistics.videoCount || '0',
          uploadsPlaylistId: uploads,
          latestUploadDate: latest,
          country: it.snippet.country || '-'
        };

        await idbPut('my_channels', data);
        toast(`✅ ${data.title} 채널이 등록되었습니다.`, 'success');
        setTimeout(() => refreshChannels(), 50);
        return true;
      } catch (e) {
        toast('채널 추가 실패: ' + e.message, 'error');
        return false;
      }
    }

    async function refreshChannels() {
      try {
        const allChannels = await getAllChannels();
        
        for (const ch of allChannels) {
          await updateDailySubSnapshot(ch);
        }

        const sortSelect = qs('#sort-channels');
        const sortMode = sortSelect?.value || 'subscribers';
        sortChannels(allChannels, sortMode);

        const channelCountEl = qs('#channel-count');
        if (channelCountEl) {
          channelCountEl.textContent = allChannels.length.toString();
        }

        const wrap = qs('#channel-list');
        if (!wrap) return;

        if (!allChannels.length) {
          wrap.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">📺</div>
              <p class="muted">채널을 추가하여 시작하세요</p>
              <button class="btn btn-primary" onclick="document.getElementById('btn-add-channel').click()">첫 채널 추가하기</button>
            </div>
          `;
          return;
        }

        wrap.innerHTML = '';

        for (const ch of allChannels) {
          const y = await getYesterdaySubCount(ch);
          const today = parseInt(ch.subscriberCount || '0', 10);
          const diff = y == null ? null : today - y;
          const diffStr = y == null ? '<span class="v neutral">(전일 정보 없음)</span>'
            : diff > 0 ? `<span class="v positive">+${fmt(diff)}</span>`
            : diff < 0 ? `<span class="v negative">${fmt(diff)}</span>`
            : `<span class="v neutral">0</span>`;

          const el = document.createElement('div');
          el.className = 'channel-card';
          el.innerHTML = `
            <a href="https://www.youtube.com/channel/${ch.id}" target="_blank" style="text-decoration: none;">
              <img class="channel-thumb" src="${ch.thumbnail || ''}" alt="${ch.title}">
            </a>
            <div class="channel-meta">
              <h3><a href="https://www.youtube.com/channel/${ch.id}" target="_blank">${ch.title}</a></h3>
              <div class="row">
                <span>구독자: <strong>${fmt(today)}</strong></span>
                <span>영상: <strong>${fmt(ch.videoCount)}</strong></span>
              </div>
              <div class="latest">최신 업로드: ${ch.latestUploadDate ? moment(ch.latestUploadDate).format('YYYY-MM-DD') : '-'}</div>
            </div>
            <div class="channel-actions">
              <button class="btn-danger" onclick="deleteChannelHandler('${ch.id}')">삭제</button>
            </div>
            <div class="channel-insights">
              <div class="insights">
                <div><span class="k">전일대비</span> ${diffStr}</div>
                <div><span class="k">국가</span> <span class="v">${ch.country || '-'}</span></div>
              </div>
            </div>
          `;

          wrap.appendChild(el);
        }
      } catch (error) {
        console.error('refreshChannels 오류:', error);
        toast('채널 목록을 불러오는 중 오류가 발생했습니다.', 'error');
      }
    }

    // 채널 삭제 핸들러
    window.deleteChannelHandler = async function(channelId) {
      if (confirm('채널을 삭제할까요?')) {
        try {
          await deleteChannel(channelId);
          await refreshChannels();
          toast('채널이 삭제되었습니다.', 'success');
        } catch (e) {
          toast('채널 삭제 중 오류가 발생했습니다.', 'error');
        }
      }
    };

    // 채널 ID 추출 함수
    async function extractChannelId(url) {
      if (!url) return null;
      
      url = url.trim();
      
      // 이미 채널 ID인 경우
      if (/^UC[a-zA-Z0-9_-]{22}$/.test(url)) {
        return url;
      }
      
      // 채널 URL에서 ID 추출
      let match = url.match(/(?:youtube\.com|youtu\.be)\/channel\/([a-zA-Z0-9_-]+)/);
      if (match) return match[1];
      
      // @핸들 처리
      match = url.match(/@([a-zA-Z0-9_-]+)/);
      if (match) {
        try {
          const searchRes = await yt('search', {
            part: 'snippet',
            q: '@' + match[1],
            type: 'channel',
            maxResults: 1
          });
          return searchRes.items?.[0]?.snippet?.channelId || null;
        } catch (e) {
          return null;
        }
      }

      // 영상 URL에서 채널 ID 추출
      match = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)/);
      if (match) {
        try {
          const videoRes = await yt('videos', {
            part: 'snippet',
            id: match[1]
          });
          return videoRes.items?.[0]?.snippet?.channelId || null;
        } catch (e) {
          return null;
        }
      }
      
      return null;
    }

    // 이벤트 바인딩
    function bindEvents() {
      console.log('이벤트 바인딩 시작');
      
      // API 키 버튼
      const btnApi = qs('#btn-api');
      console.log('API 버튼 찾음:', !!btnApi);
      if (btnApi) {
        btnApi.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('API 버튼 클릭됨');
          openApiModal();
        });
      }

      // 테마 토글
      const btnToggleTheme = qs('#btn-toggle-theme');
      console.log('테마 버튼 찾음:', !!btnToggleTheme);
      if (btnToggleTheme) {
        btnToggleTheme.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('테마 버튼 클릭됨');
          toggleTheme();
        });
      }

      // 채널 추가
      const btnAddChannel = qs('#btn-add-channel');
      console.log('채널 추가 버튼 찾음:', !!btnAddChannel);
      if (btnAddChannel) {
        btnAddChannel.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('채널 추가 버튼 클릭됨');
          if (!window.hasKeys()) {
            toast('먼저 API 키를 설정해주세요.', 'warning');
            return;
          }
          openModal('modal-add');
        });
      }

      // 분석 버튼
      const btnAnalyze = qs('#btn-analyze');
      console.log('분석 버튼 찾음:', !!btnAnalyze);
      if (btnAnalyze) {
        btnAnalyze.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('분석 버튼 클릭됨');
          if (!window.hasKeys()) {
            toast('먼저 API 키를 설정해주세요.', 'warning');
            return;
          }
          toast('분석 기능은 채널을 추가한 후 사용할 수 있습니다.', 'info');
        });
      }

      // 모달 닫기
      document.querySelectorAll('.close').forEach(closeBtn => {
        closeBtn.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('모달 닫기 버튼 클릭됨');
          const modal = e.target.closest('.modal');
          if (modal) {
            modal.style.display = 'none';
          }
        });
      });

      // 모달 외부 클릭시 닫기
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            console.log('모달 외부 클릭으로 닫기');
            modal.style.display = 'none';
          }
        });
      });

      // 채널 추가 모달 이벤트
      bindChannelAddEvents();

      // API 키 모달 이벤트
      bindApiEvents();

      // 정렬 변경 이벤트
      const sortChannels = qs('#sort-channels');
      if (sortChannels) {
        sortChannels.addEventListener('change', () => {
          console.log('정렬 변경됨');
          refreshChannels();
        });
      }

      console.log('이벤트 바인딩 완료');
    }

    function openApiModal() {
      console.log('API 모달 열기 시작');
      const apiInputsContainer = qs('#api-inputs');
      console.log('API 입력 컨테이너 찾음:', !!apiInputsContainer);
      
      if (apiInputsContainer) {
        apiInputsContainer.innerHTML = '';
        
        for (let i = 0; i < 5; i++) {
          const apiKey = (window.apiKeys && window.apiKeys[i]) || '';
          const input = document.createElement('input');
          input.type = 'text';
          input.className = 'api-inp';
          input.placeholder = `API Key ${i + 1}`;
          input.value = apiKey;
          input.style.cssText = `
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--card);
            color: var(--text);
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
          `;
          apiInputsContainer.appendChild(input);
        }

        const testResult = qs('#api-test-result');
        if (testResult) testResult.innerHTML = '';

        console.log('API 모달 열기 시도');
        openModal('modal-api');
      } else {
        console.error('API 입력 컨테이너를 찾을 수 없습니다');
      }
    }

    function bindApiEvents() {
      console.log('API 이벤트 바인딩 시작');
      
      const apiSave = qs('#api-save');
      console.log('API 저장 버튼 찾음:', !!apiSave);
      if (apiSave) {
        apiSave.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('API 저장 버튼 클릭됨');
          
          const keys = [...document.querySelectorAll('.api-inp')]
            .map(i => i.value.trim())
            .filter(Boolean);
          
          console.log('입력된 키 개수:', keys.length);
          
          window.setApiKeys(keys);
          toast('API 키가 저장되었습니다.', 'success');
          
          const testResult = qs('#api-test-result');
          if (testResult) testResult.innerHTML = '';
          
          closeModal('modal-api');
          
          setTimeout(() => {
            refreshChannels();
          }, 500);
        });
      }

      const apiTest = qs('#api-test');
      console.log('API 테스트 버튼 찾음:', !!apiTest);
      if (apiTest) {
        apiTest.addEventListener('click', async (e) => {
          e.preventDefault();
          console.log('API 테스트 버튼 클릭됨');
          
          const keys = [...document.querySelectorAll('.api-inp')]
            .map(i => i.value.trim())
            .filter(Boolean);
          
          const testKeys = keys.length ? keys : (window.apiKeys || []);
          const testResult = qs('#api-test-result');

          if (!testKeys.length) {
            if (testResult) {
              testResult.innerHTML = '<span style="color: var(--brand);">저장된 키가 없습니다.</span>';
            }
            return;
          }

          if (testResult) {
            testResult.innerHTML = 'API 키 테스트 중...';
            testResult.style.background = 'var(--glass-bg)';
            testResult.style.border = '1px solid var(--border)';
          }

          let success = false;
          let lastError = '';

          for (const key of testKeys) {
            try {
              const testUrl = `${window.CONFIG.API_BASE}channels?part=id&id=UC_x5XG1OV2P6uZZ5FSM9Ttw&key=${encodeURIComponent(key)}`;
              const response = await fetch(testUrl);
              const data = await response.json();
              
              if (!data.error) {
                success = true;
                break;
              }
              lastError = data.error.message || JSON.stringify(data.error);
            } catch (e) {
              lastError = e.message || String(e);
            }
          }

          if (testResult) {
            testResult.innerHTML = success ?
              '<span style="color: #1db954;">✓ API 키가 정상적으로 작동합니다!</span>' :
              `<span style="color: var(--brand);">✗ API 키 테스트 실패: ${lastError}</span>`;
          }
        });
      }
      
      console.log('API 이벤트 바인딩 완료');
    }

    function bindChannelAddEvents() {
      console.log('채널 추가 이벤트 바인딩 시작');
      
      const btnUrlAdd = qs('#btn-url-add');
      const urlInput = qs('#url-input');
      
      console.log('URL 추가 버튼 찾음:', !!btnUrlAdd);
      console.log('URL 입력 필드 찾음:', !!urlInput);
      
      if (btnUrlAdd && urlInput) {
        const handleUrlAdd = async () => {
          console.log('URL 추가 핸들러 실행');
          const input = urlInput.value.trim();
          if (!input) {
            toast('채널 URL 또는 ID를 입력해주세요.', 'warning');
            return;
          }

          const resultDiv = qs('#url-result');
          if (resultDiv) {
            resultDiv.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div>채널을 추가하는 중...</div>';
          }

          try {
            let channelId = await extractChannelId(input);
            
            if (!channelId) {
              toast('채널을 찾을 수 없습니다. URL이나 채널명을 확인해주세요.', 'error');
              if (resultDiv) resultDiv.innerHTML = '';
              return;
            }

            const success = await addChannelById(channelId);
            if (success) {
              closeModal('modal-add');
              urlInput.value = '';
              if (resultDiv) resultDiv.innerHTML = '';
            }
          } catch (e) {
            console.error('채널 추가 오류:', e);
            toast('채널 추가 실패: ' + e.message, 'error');
            if (resultDiv) resultDiv.innerHTML = '';
          }
        };

        btnUrlAdd.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('URL 추가 버튼 클릭됨');
          handleUrlAdd();
        });
        
        urlInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            console.log('Enter 키로 URL 추가');
            handleUrlAdd();
          }
        });
      }
      
      console.log('채널 추가 이벤트 바인딩 완료');
    }

    // 초기화
    function initializeApp() {
      console.log('앱 초기화 시작...');

      // moment.js 설정
      if (typeof moment !== 'undefined') {
        moment.tz.setDefault('Asia/Seoul');
        moment.locale('ko');
        console.log('Moment.js 설정 완료');
      } else {
        console.warn('Moment.js가 로드되지 않았습니다');
      }

      // 테마 로드
      loadTheme();
      console.log('테마 로드 완료');

      // 이벤트 바인딩
      bindEvents();

      // 드래그 앤 드롭 초기화
      if (typeof Sortable !== 'undefined') {
        const mainContent = qs('#main-content');
        if (mainContent) {
          Sortable.create(mainContent, {
            animation: 150,
            handle: '.col-head',
            onSort: () => {
              const keys = [...mainContent.children].map(n => n.getAttribute('data-col')); 
              localStorage.setItem('colOrder', keys.join(','));
            }
          });
          console.log('드래그 앤 드롭 초기화 완료');
        }
      } else {
        console.warn('Sortable.js가 로드되지 않았습니다');
      }

      // 초기 데이터 로드
      if (window.hasKeys()) {
        console.log('API 키 있음, 채널 데이터 로드 시작');
        setTimeout(() => {
          refreshChannels();
        }, 1000);
      } else {
        console.log('API 키 없음, 설정 요청');
        toast('API 키를 설정해주세요. 우상단 🔑 API 키 버튼을 클릭하세요.', 'info');
      }

      console.log('앱 초기화 완료');
    }

료');
      setTimeout(initializeApp, 100);
    });
