<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>로이가 만든 유튜브 채널 모니터</title>
  <link rel="icon" href="favicon.ico" />
  <link rel="stylesheet" href="css/styles.css" />

  <!-- 외부 라이브러리 -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.45/moment-timezone-with-data.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.js"></script>

  <!-- 헬퍼 폴리필 -->
  <script defer>
    window.qs  = window.qs  || ((sel, scope = document) => scope.querySelector(sel));
    window.qsa = window.qsa || ((sel, scope = document) => Array.from(scope.querySelectorAll(sel)));
    window.toast = window.toast || (msg => console.log('[toast]', msg));
  </script>

  <!-- 앱 스크립트 (의존 순서 유지) -->
  <script defer src="js/config.js"></script>
  <script defer src="js/utils.js"></script>
  <script defer src="js/api.js"></script>
  <script defer src="js/database.js"></script>
  <script defer src="js/video-renderer.js"></script>
  <script defer src="js/channels.js"></script>
  <script defer src="js/videos.js"></script>
  <script defer src="js/analysis.js"></script>
  <script defer src="js/ui.js"></script>
  <script defer src="js/main.js"></script>

  <!-- 로딩 확인 -->
  <script defer>
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof Chart === 'undefined') {
        console.error('Chart.js가 로드되지 않았습니다.');
        if (typeof toast === 'function') toast('차트 라이브러리 로딩 오류가 발생했습니다.');
      } else {
        console.log('Chart.js 버전:', Chart.version);
      }

      if (typeof moment === 'undefined') {
        console.error('Moment.js가 로드되지 않았습니다.');
      } else {
        console.log('Moment.js 버전:', moment.version);
      }
    });
  </script>
</head>

<body>
  <header>
    <h1>유튜브 채널 모니터</h1>
    <nav class="tabs">
      <button class="tab active" data-tab="home-panel">홈</button>
      <button class="tab" data-tab="analysis-panel">분석</button>
      <button class="tab" data-tab="settings-panel">설정</button>
    </nav>
  </header>

  <main id="app">
    <!-- 홈 탭 -->
    <section id="home-panel" class="tabpanel active">
      <div id="main-content" class="three-col">
        <section class="col" data-col="channels">
          <div class="col-head" draggable="true">
            <h2>채널 추가</h2>
            <div class="col-actions">
              <button id="btn-add-channel" class="btn">+ 채널 추가</button> 
              <button id="btn-export-channels" class="btn">내보내기</button> 
              <button id="btn-import-channels" class="btn">가져오기</button> 
              <input type="file" id="file-import-channels" accept="application/json" style="display:none" />
              <span>등록: <span id="channel-count">0</span></span>
            </div>
          </div>
          <div class="sort-row">
            <label>정렬:
              <select id="sort-channels">
                <option value="subscribers" selected>구독자수</option>
                <option value="videos">영상갯수</option>
                <option value="latest">최근업로드</option>
              </select>
            </label>
          </div>
          <div id="channel-list" class="channel-list">
            <p class="muted">채널을 추가하세요.</p>
          </div>
          <div id="channel-pagination" class="pagination"></div>
        </section>

        <section class="col" data-col="mutant">
          <div class="col-head" draggable="true">
            <h2>돌연변이 영상</h2>
            <div class="col-actions">
              <div class="date-range">
                <button data-period="1m">1개월</button>
                <button data-period="3m">3개월</button>
                <button class="active" data-period="6m">6개월</button>
                <button data-period="all">전체</button>
              </div>
            </div>
          </div>
          <div class="sort-row">
            <label>정렬:
              <select id="sort-mutant">
                <option value="mutantIndex" selected>돌연변이지수</option>
                <option value="views">조회수</option>
                <option value="subscribers">구독자수</option>
                <option value="latest">최근업로드</option>
              </select>
            </label>
          </div>
          <div id="mutant-keywords" class="keywords"></div>
          <div id="mutant-list" class="video-list">
            <p class="muted">채널을 추가하여 영상을 분석해주세요.</p>
          </div>
          <div id="mutant-pagination" class="pagination"></div>
        </section>

        <section class="col" data-col="latest">
          <div class="col-head" draggable="true">
            <h2>최신 영상</h2>
          </div>
          <div class="sort-row">
            <label>정렬:
              <select id="sort-latest">
                <option value="views" selected>조회수</option>
                <option value="subscribers">구독자수</option>
                <option value="latest">최근업로드</option>
                <option value="mutantIndex">돌연변이지수</option>
              </select>
            </label>
          </div>
          <div id="latest-keywords" class="keywords"></div>
          <div id="latest-list" class="video-list">
            <p class="muted">채널을 추가하여 영상을 분석해주세요.</p>
          </div>
          <div id="latest-pagination" class="pagination"></div>
        </section>
      </div>
    </section>

    <!-- 분석 탭 -->
    <section id="analysis-panel" class="tabpanel">
      <button id="btn-back-home">← 뒤로가기</button>
      <div id="analysis-content"></div>
    </section>

    <!-- 설정 탭 -->
    <section id="settings-panel" class="tabpanel">
      <h2>API 키 관리</h2>
      <button id="open-api-modal">API 키 설정</button>
    </section>
  </main>

  <!-- API 키 모달 -->
  <div id="modal-api" class="modal">
    <div class="modal-content">
      <span class="close" data-close="modal-api">&times;</span>
      <h3>API 키 설정</h3>
      <div id="api-inputs"></div>
      <div class="modal-actions">
        <button id="api-save">저장</button>
        <button id="api-test">테스트</button>
      </div>
      <div id="api-test-result"></div>
    </div>
  </div>

  <!-- 채널 추가 모달 -->
  <div id="modal-add" class="modal">
    <div class="modal-content">
      <span class="close" data-close="modal-add">&times;</span>
      <h3>채널 추가</h3>
      <input type="text" id="add-channel-id" placeholder="채널 ID 입력" />
      <div class="modal-actions">
        <button id="add-channel-confirm">추가</button>
      </div>
    </div>
  </div>

  <!-- 분석 모달 -->
  <div id="modal-analyze" class="modal">
    <div class="modal-content">
      <span class="close" data-close="modal-analyze">&times;</span>
      <h3>채널 분석</h3>
      <div id="analyze-channel-list"></div>
    </div>
  </div>

  <!-- 차트 모달 -->
  <div id="modal-chart" class="modal">
    <div class="modal-content">
      <span class="close" data-close="modal-chart">&times;</span>
      <h3>채널 분석 차트</h3>
      <canvas id="analysis-chart"></canvas>
    </div>
  </div>
</body>
</html>
