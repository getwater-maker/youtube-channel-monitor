<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube ì±„ë„ ë¶„ì„ê¸°</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }

        .header-container {
            background-color: #fff;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-container h1 {
            font-size: 2rem;
            margin: 0;
            color: #212529;
        }

        .tab-menu {
            display: flex;
            background-color: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
        }

        .tab-menu button {
            padding: 10px 20px;
            border: none;
            background-color: transparent;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
            border-right: 1px solid #ccc;
        }

        .tab-menu button:last-child {
            border-right: none;
        }

        .tab-menu button.active {
            background-color: #007bff;
            color: #fff;
        }

        .tab-content {
            padding: 20px;
            background-color: #fff;
            margin-top: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .channel-management {
            margin-top: 20px;
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
        }

        .channel-card {
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .channel-card img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 10px;
        }

        .channel-info h4 {
            font-size: 1rem;
            margin: 0 0 5px 0;
        }

        .monitoring-channel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .video-card {
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 10px;
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .video-card img {
            width: 120px;
            height: auto;
            border-radius: 5px;
        }

        .video-info h4 {
            font-size: 1rem;
            margin-top: 0;
        }

        .video-info p {
            font-size: 0.9rem;
            margin: 0;
            color: #666;
        }

        .empty-state {
            text-align: center;
            color: #6c757d;
            padding: 50px;
            background-color: #e9ecef;
            border-radius: 5px;
        }

        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        .loading-message {
            color: white;
            margin-top: 10px;
        }

        .modal-dialog {
            margin-top: 10%;
        }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Loading...</span>
        </div>
        <p id="loading-message" class="loading-message">ë¡œë”© ì¤‘...</p>
    </div>
</div>

<div class="container py-4">
    <div class="header-container">
        <h1>YouTube ì±„ë„ ë¶„ì„ê¸°</h1>
        <div class="tab-menu">
            <button class="tab-btn active" data-tab="monitoring">ì±„ë„ ëª¨ë‹ˆí„°ë§</button>
            <button class="tab-btn" data-tab="tracking">ëŒì—°ë³€ì´ ì¶”ì </button>
        </div>
    </div>

    <div id="monitoring-tab" class="tab-content">
        <h2>ëª¨ë‹ˆí„°ë§ ì¤‘ì¸ ì±„ë„ (<span id="monitoring-channel-count">0</span>ê°œ)
            <button id="monitoring-collapse-btn" class="btn btn-secondary btn-sm ml-2">â–²</button>
        </h2>
        <div class="channel-management monitoring-channel-management">
            <button id="add-monitoring-channel-btn" class="btn btn-primary">ì²« ë²ˆì§¸ ì±„ë„ ì¶”ê°€í•˜ê¸°</button>
            <div id="monitoring-channel-grid" class="monitoring-channel-grid mt-3">
                <div class="empty-state">
                    <p>ëª¨ë‹ˆí„°ë§í•  ì±„ë„ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.</p>
                </div>
            </div>
        </div>

        <hr class="my-4">

        <h2>ìµœì‹  ì˜ìƒ ëª©ë¡</h2>
        <div id="latest-videos-container" class="mt-3">
            <div class="empty-state">
                <p>ë“±ë¡ëœ ì±„ë„ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>

    <div id="tracking-tab" class="tab-content" style="display: none;">
        <h2>ëŒì—°ë³€ì´ ì¶”ì </h2>
        <p>
            'ëŒì—°ë³€ì´' ì˜ìƒì´ë€, ì±„ë„ êµ¬ë…ì ìˆ˜ ëŒ€ë¹„ ì¡°íšŒìˆ˜ê°€ ë¹„ì •ìƒì ìœ¼ë¡œ ë†’ì€ ì˜ìƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
            ì±„ë„ ì¶”ì ì„ í†µí•´ ë¹ ë¥´ê²Œ ì¸ê¸° ê¸‰ìƒìŠ¹ ì˜ìƒì„ ë°œê²¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </p>

        <div class="d-flex align-items-center mb-3">
            <button id="start-monitoring-btn" class="btn btn-primary mr-3">ğŸ“ˆ ì±„ë„ ì¶”ì  ì‹œì‘</button>
            <div class="form-group mb-0 mr-3">
                <label for="hot-video-ratio" class="mr-2">ëŒì—°ë³€ì´ ë¹„ìœ¨ (%):</label>
                <select id="hot-video-ratio" class="form-control d-inline-block w-auto">
                    <option value="10">10%</option>
                    <option value="20">20%</option>
                    <option value="30" selected>30%</option>
                    <option value="40">40%</option>
                    <option value="50">50%</option>
                </select>
            </div>
            <div class="form-group mb-0 mr-3">
                <label for="tracking-sort-order" class="mr-2">ì •ë ¬ ê¸°ì¤€:</label>
                <select id="tracking-sort-order" class="form-control d-inline-block w-auto">
                    <option value="ratio">ëŒì—°ë³€ì´ ë¹„ìœ¨</option>
                    <option value="publishedAt" selected>ìµœì‹ ìˆœ</option>
                    <option value="viewCount">ì¡°íšŒìˆ˜</option>
                    <option value="subscriberCount">êµ¬ë…ììˆ˜</option>
                </select>
            </div>
            <div class="form-check mr-3">
                <input class="form-check-input" type="checkbox" id="show-all-channels">
                <label class="form-check-label" for="show-all-channels">ëª¨ë‘ í‘œì‹œ</label>
            </div>
            <button id="add-tracking-channel-btn" class="btn btn-secondary mr-3">ì±„ë„ ì¶”ê°€</button>
            <button id="backup-tracking-data-btn" class="btn btn-info mr-3">ë°±ì—…</button>
            <button id="restore-tracking-data-btn" class="btn btn-warning">ë³µì›</button>
            <input type="file" id="restore-tracking-data-input" style="display:none;">
        </div>

        <div id="tracking-records" class="mt-3">
            <div class="empty-state">
                <p>ì±„ë„ ì¶”ì ì„ ì‹œì‘í•˜ë©´ ìµœì‹  ì˜ìƒì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="channel-modal" tabindex="-1" role="dialog" aria-labelledby="channelModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="channelModalLabel">ì±„ë„ ì¶”ê°€í•˜ê¸°</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="closeModal(document.getElementById('channel-modal'))">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="channel-input">YouTube ì±„ë„ ID, URL, í•¸ë“¤(@) ë˜ëŠ” ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.</label>
                    <input type="text" class="form-control" id="channel-input" placeholder="@channle_name ë˜ëŠ” UC... ë˜ëŠ” ì±„ë„ëª…">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal(document.getElementById('channel-modal'))">ë‹«ê¸°</button>
                <button type="button" class="btn btn-primary" id="add-channel-confirm-btn">ì¶”ê°€</button>
            </div>
        </div>
    </div>
</div>

<script>
    // =====================================================================================================
    // ëª¨ë“  ì½”ë“œ
    // =====================================================================================================

    // ì „ì—­ ìƒíƒœ ë° ê³µí†µ ê¸°ëŠ¥
    const API_KEY = 'YOUR_YOUTUBE_API_KEY'; // ì—¬ê¸°ì— ì‹¤ì œ API í‚¤ë¥¼ ë„£ìœ¼ì„¸ìš”
    const BASE_URL = 'https://www.googleapis.com/youtube/v3/';
    
    let channels = JSON.parse(localStorage.getItem('youtubeChannels')) || {};
    let currentChannelType = '';
    
    // DOM ìš”ì†Œ
    const loadingOverlay = document.getElementById('loading-overlay');
    const channelModal = document.getElementById('channel-modal');
    const channelInput = document.getElementById('channel-input');
    const addChannelConfirmBtn = document.getElementById('add-channel-confirm-btn');

    // 'ì±„ë„ ëª¨ë‹ˆí„°ë§' íƒ­ ê´€ë ¨ DOM ìš”ì†Œ
    const addMonitoringChannelBtn = document.getElementById('add-monitoring-channel-btn');
    const addTrackingChannelBtn = document.getElementById('add-tracking-channel-btn');
    const monitoringChannelGrid = document.getElementById('monitoring-channel-grid');
    const trackingRecords = document.getElementById('tracking-records');
    const latestVideosContainer = document.getElementById('latest-videos-container');
    const channelSelectionModal = document.getElementById('channel-selection-modal');
    const channelSelectionList = document.getElementById('channel-selection-list');
    const startMonitoringBtn = document.getElementById('start-monitoring-btn');
    const monitoringChannelCountSpan = document.getElementById('monitoring-channel-count');
    const hotVideoRatioSelect = document.getElementById('hot-video-ratio');
    const trackingSortOrderSelect = document.getElementById('tracking-sort-order');
    const showAllChannelsCheckbox = document.getElementById('show-all-channels');
    const backupTrackingDataBtn = document.getElementById('backup-tracking-data-btn');
    const restoreTrackingDataBtn = document.getElementById('restore-tracking-data-btn');
    const restoreTrackingDataInput = document.getElementById('restore-tracking-data-input');
    const monitoringCollapseBtn = document.getElementById('monitoring-collapse-btn');
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    // ì „ì—­ ë³€ìˆ˜ (channel-monitor.jsì—ì„œ ì‚¬ìš©ë˜ë˜ ê²ƒë“¤)
    let selectedChannelsToMonitor = new Set();
    let monitoringIntervalId = null;
    let allTrackingData = {};
    const UPDATE_INTERVAL = 5 * 60 * 1000;

    // ë¡œë”© ìƒíƒœ í‘œì‹œ
    function showLoading(message = 'ì²˜ë¦¬ ì¤‘...') {
        loadingOverlay.style.display = 'flex';
        document.getElementById('loading-message').textContent = message;
    }

    // ë¡œë”© ìƒíƒœ ìˆ¨ê¸°ê¸°
    function hideLoading() {
        loadingOverlay.style.display = 'none';
    }

    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì±„ë„ ì €ì¥
    function saveChannelsToLocalStorage() {
        localStorage.setItem('youtubeChannels', JSON.stringify(channels));
    }

    // ëª¨ë‹¬ ì—´ê¸°
    function openModal(modal) {
        modal.style.display = 'block';
    }

    // ëª¨ë‹¬ ë‹«ê¸°
    function closeModal(modal) {
        modal.style.display = 'none';
    }

    // ì±„ë„ ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°
    function openChannelModal(type) {
        currentChannelType = type;
        channelInput.value = '';
        openModal(channelModal);
    }

    // YouTube API í˜¸ì¶œ
    async function fetchYouTubeApi(endpoint, params) {
        const url = new URL(BASE_URL + endpoint);
        url.searchParams.append('key', API_KEY);
        for (const key in params) {
            url.searchParams.append(key, params[key]);
        }

        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${response.statusText}`);
            }
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('API Error:', error);
            alert('API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. API í‚¤ë¥¼ í™•ì¸í•˜ê±°ë‚˜ í• ë‹¹ëŸ‰ì„ ì´ˆê³¼í–ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
            return null;
        }
    }

    // =====================================================================================================
    // ì±„ë„ ê´€ë¦¬ ë° ë Œë”ë§ (channel-monitor.js)
    // =====================================================================================================
    async function addChannel(input, type) {
        showLoading('ì±„ë„ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...');
        let params = { part: 'snippet,statistics' };

        if (input.startsWith('UC')) {
            params.id = input;
        } else if (input.startsWith('@')) {
            params.forHandle = input.slice(1);
        } else {
            const searchData = await fetchYouTubeApi('search', { q: input, type: 'channel', maxResults: 1 });
            if (!searchData || !searchData.items || searchData.items.length === 0) {
                hideLoading();
                alert('ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            params.id = searchData.items[0].id.channelId;
        }
        
        const data = await fetchYouTubeApi('channels', params);
        
        if (!data || !data.items || data.items.length === 0) {
            hideLoading();
            alert('ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        const channel = data.items[0];
        const channelId = channel.id;

        if (channels[channelId]) {
            hideLoading();
            alert('ì´ë¯¸ ì¶”ê°€ëœ ì±„ë„ì…ë‹ˆë‹¤.');
            return;
        }

        channels[channelId] = {
            id: channelId,
            name: channel.snippet.title,
            thumbnail: channel.snippet.thumbnails.default.url,
            type: type,
        };
        
        saveChannelsToLocalStorage();
        renderMonitoringChannels();
        renderLatestVideos();
        hideLoading();
    }

    function removeChannel(channelId) {
        if (confirm('ì •ë§ë¡œ ì´ ì±„ë„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            delete channels[channelId];
            saveChannelsToLocalStorage();
            renderMonitoringChannels();
            renderLatestVideos();
            stopMonitoring();
        }
    }

    function renderMonitoringChannels() {
        monitoringChannelGrid.innerHTML = '';
        const monitoringChannels = Object.values(channels).filter(c => c.type === 'monitoring');

        if (monitoringChannelCountSpan) {
            monitoringChannelCountSpan.textContent = monitoringChannels.length;
        }

        if (monitoringChannels.length === 0) {
            monitoringChannelGrid.innerHTML = `<div class="empty-state">
                <p>ëª¨ë‹ˆí„°ë§í•  ì±„ë„ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.</p>
            </div>`;
            return;
        }

        monitoringChannels.forEach(channel => {
            const channelCard = document.createElement('div');
            channelCard.className = 'channel-card';
            channelCard.innerHTML = `
                <img src="${channel.thumbnail}" alt="${channel.name}">
                <div class="channel-info">
                    <h4>${channel.name}</h4>
                    <button class="btn btn-danger btn-small remove-channel-btn" data-channel-id="${channel.id}">ì‚­ì œ</button>
                </div>
            `;
            monitoringChannelGrid.appendChild(channelCard);
        });
    }

    function toggleChannelManagementSection(type) {
        const grid = document.getElementById(`${type}-channel-grid`);
        const collapseBtn = document.getElementById(`${type}-collapse-btn`);
        if (grid && collapseBtn) {
            if (grid.style.display === 'none') {
                grid.style.display = 'grid';
                collapseBtn.textContent = 'â–²';
            } else {
                grid.style.display = 'none';
                collapseBtn.textContent = 'â–¼';
            }
        }
    }

    // ëª¨ë‹ˆí„°ë§ ë¡œì§ (channel-monitor.js)
    async function startMonitoring() {
        stopMonitoring();
        showLoading('ì±„ë„ ëª¨ë‹ˆí„°ë§ ì‹œì‘...');
        selectedChannelsToMonitor = new Set(Object.values(channels).filter(c => c.type === 'monitoring').map(c => c.id));
        await fetchVideos();
        hideLoading();
        monitoringIntervalId = setInterval(fetchVideos, UPDATE_INTERVAL);
    }

    function stopMonitoring() {
        if (monitoringIntervalId) {
            clearInterval(monitoringIntervalId);
            monitoringIntervalId = null;
            trackingRecords.innerHTML = `<div class="empty-state"><p>ì±„ë„ ì¶”ì ì„ ì‹œì‘í•˜ë©´ ìµœì‹  ì˜ìƒì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p></div>`;
        }
    }

    async function fetchVideos() {
        if (selectedChannelsToMonitor.size === 0) {
            stopMonitoring();
            return;
        }
        
        showLoading('ìƒˆ ì˜ìƒì„ í™•ì¸í•˜ëŠ” ì¤‘...');

        const channelIds = Array.from(selectedChannelsToMonitor);
        const channelDataPromises = channelIds.map(channelId => {
            return fetchYouTubeApi('search', {
                channelId: channelId,
                part: 'snippet',
                order: 'date',
                maxResults: 50,
                type: 'video'
            });
        });

        const searchResults = await Promise.all(channelDataPromises);
        const videoIds = searchResults.flatMap(result => result && result.items ? result.items.map(item => item.id.videoId) : []);

        if (videoIds.length === 0) {
            hideLoading();
            trackingRecords.innerHTML = `<div class="empty-state"><p>ìµœì‹  ì˜ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p></div>`;
            return;
        }

        const videoData = await fetchYouTubeApi('videos', {
            id: videoIds.join(','),
            part: 'snippet,statistics'
        });

        if (!videoData || videoData.items.length === 0) {
            hideLoading();
            trackingRecords.innerHTML = `<div class="empty-state"><p>ì˜ìƒ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p></div>`;
            return;
        }

        const allVideos = videoData.items;

        allVideos.forEach(video => {
            if (!allTrackingData[video.id]) {
                allTrackingData[video.id] = {
                    title: video.snippet.title,
                    channelId: video.snippet.channelId,
                    channelTitle: video.snippet.channelTitle,
                    thumbnail: video.snippet.thumbnails.medium.url,
                    publishedAt: video.snippet.publishedAt,
                    statistics: {
                        viewCount: video.statistics.viewCount,
                        likeCount: video.statistics.likeCount,
                        commentCount: video.statistics.commentCount,
                    },
                    channelStats: null
                };
            }
        });

        const uniqueChannelIds = [...new Set(allVideos.map(v => v.snippet.channelId))];
        const channelStatsPromises = uniqueChannelIds.map(id => 
            fetchYouTubeApi('channels', { id: id, part: 'statistics' })
        );
        const channelStatsResults = await Promise.all(channelStatsPromises);

        const channelStatsMap = {};
        channelStatsResults.forEach(result => {
            if (result && result.items && result.items.length > 0) {
                channelStatsMap[result.items[0].id] = result.items[0].statistics;
            }
        });

        Object.keys(allTrackingData).forEach(videoId => {
            const video = allTrackingData[videoId];
            const channelStats = channelStatsMap[video.channelId];
            if (channelStats) {
                video.channelStats = channelStats;
                const viewCount = parseInt(video.statistics.viewCount, 10) || 0;
                const subscriberCount = parseInt(channelStats.subscriberCount, 10) || 1;
                video.ratio = (viewCount / subscriberCount) * 100;
            }
        });

        renderTrackingRecords();
        hideLoading();
    }

    function renderTrackingRecords() {
        trackingRecords.innerHTML = '';
        const videoData = Object.values(allTrackingData);

        if (videoData.length === 0) {
            trackingRecords.innerHTML = `<div class="empty-state"><p>ì¶”ì ëœ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p></div>`;
            return;
        }

        const showAll = showAllChannelsCheckbox.checked;
        const hotVideoRatio = parseFloat(hotVideoRatioSelect.value);

        const filteredVideos = videoData.filter(video => {
            if (showAll) {
                return true;
            }
            return video.ratio && video.ratio >= hotVideoRatio;
        });

        const sortBy = trackingSortOrderSelect.value;
        filteredVideos.sort((a, b) => {
            if (sortBy === 'ratio') {
                return (b.ratio || 0) - (a.ratio || 0);
            } else if (sortBy === 'publishedAt') {
                return new Date(b.publishedAt) - new Date(a.publishedAt);
            } else if (sortBy === 'viewCount') {
                return (parseInt(b.statistics.viewCount) || 0) - (parseInt(a.statistics.viewCount) || 0);
            } else if (sortBy === 'subscriberCount') {
                return (parseInt(b.channelStats.subscriberCount) || 0) - (parseInt(a.channelStats.subscriberCount) || 0);
            }
            return 0;
        });

        filteredVideos.forEach(video => {
            const videoCard = document.createElement('div');
            videoCard.className = 'video-card tracking-card';
            videoCard.innerHTML = `
                <img src="${video.thumbnail}" alt="${video.title}">
                <div class="video-info">
                    <h4><a href="http://googleusercontent.com/youtube.com/watch?v=${video.id}" target="_blank">${video.title}</a></h4>
                    <p><strong>ì±„ë„:</strong> ${video.channelTitle}</p>
                    <p><strong>ì¡°íšŒìˆ˜:</strong> ${formatNumber(video.statistics.viewCount)}íšŒ</p>
                    <p><strong>êµ¬ë…ì:</strong> ${video.channelStats ? formatNumber(video.channelStats.subscriberCount) : 'ì •ë³´ ì—†ìŒ'}</p>
                    ${video.ratio ? `<p><strong>ëŒì—°ë³€ì´ ë¹„ìœ¨:</strong> ${video.ratio.toFixed(2)}%</p>` : ''}
                    <p><strong>ì—…ë¡œë“œ:</strong> ${new Date(video.publishedAt).toLocaleDateString()}</p>
                </div>
            `;
            trackingRecords.appendChild(videoCard);
        });
    }

    function formatNumber(num) {
        if (num === null || num === undefined) {
            return '0';
        }
        const n = parseInt(num, 10);
        if (n >= 100000000) return (n / 100000000).toFixed(1) + 'ì–µ';
        if (n >= 10000) return (n / 10000).toFixed(1) + 'ë§Œ';
        return n.toLocaleString();
    }

    function renderLatestVideos() {
        latestVideosContainer.innerHTML = '';
        const monitoringChannels = Object.values(channels).filter(c => c.type === 'monitoring');

        if (monitoringChannels.length === 0) {
            latestVideosContainer.innerHTML = `<div class="empty-state">
                <p>ë“±ë¡ëœ ì±„ë„ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>`;
            return;
        }

        monitoringChannels.forEach(channel => {
            const channelSection = document.createElement('div');
            channelSection.className = 'channel-latest-videos';
            channelSection.innerHTML = `
                <h3>${channel.name}ì˜ ìµœì‹  ì˜ìƒ</h3>
                <div id="latest-videos-${channel.id}" class="latest-video-list">
                    <p>ë¡œë”© ì¤‘...</p>
                </div>
            `;
            latestVideosContainer.appendChild(channelSection);
            fetchAndRenderLatestVideos(channel.id);
        });
    }

    async function fetchAndRenderLatestVideos(channelId) {
        const listContainer = document.getElementById(`latest-videos-${channelId}`);
        listContainer.innerHTML = '<p>ë¡œë”© ì¤‘...</p>';

        const searchData = await fetchYouTubeApi('search', {
            channelId: channelId,
            part: 'snippet',
            order: 'date',
            maxResults: 5,
            type: 'video'
        });

        if (!searchData || searchData.items.length === 0) {
            listContainer.innerHTML = '<p>ìµœì‹  ì˜ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        const videoIds = searchData.items.map(item => item.id.videoId).join(',');
        const videoData = await fetchYouTubeApi('videos', {
            id: videoIds,
            part: 'snippet,statistics'
        });

        listContainer.innerHTML = '';
        if (!videoData || videoData.items.length === 0) {
            listContainer.innerHTML = '<p>ì˜ìƒ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
            return;
        }

        videoData.items.forEach(video => {
            const videoCard = document.createElement('div');
            videoCard.className = 'video-card';
            videoCard.innerHTML = `
                <img src="${video.snippet.thumbnails.medium.url}" alt="${video.snippet.title}">
                <div class="video-info">
                    <h4><a href="http://googleusercontent.com/youtube.com/watch?v=${video.id}" target="_blank">${video.snippet.title}</a></h4>
                    <p><strong>ì¡°íšŒìˆ˜:</strong> ${formatNumber(video.statistics.viewCount)}íšŒ</p>
                    <p><strong>ì—…ë¡œë“œ:</strong> ${new Date(video.snippet.publishedAt).toLocaleDateString()}</p>
                </div>
            `;
            listContainer.appendChild(videoCard);
        });
    }

    function backupData() {
        const dataStr = JSON.stringify(allTrackingData, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'youtube_tracking_data.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert('ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë°±ì—…ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    function restoreData(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const restoredData = JSON.parse(e.target.result);
                allTrackingData = restoredData;
                renderTrackingRecords();
                alert('ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                alert('íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. JSON íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            }
        };
        reader.readAsText(file);
    }
    
    // =====================================================================================================
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    // =====================================================================================================
    function setupEventListeners() {
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tab = button.dataset.tab;
                tabContents.forEach(content => {
                    content.style.display = 'none';
                });
                document.getElementById(`${tab}-tab`).style.display = 'block';
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
            });
        });

        startMonitoringBtn.addEventListener('click', () => {
            if (monitoringIntervalId) {
                stopMonitoring();
                startMonitoringBtn.textContent = 'ğŸ“ˆ ì±„ë„ ì¶”ì  ì‹œì‘';
                startMonitoringBtn.classList.add('btn-primary');
                startMonitoringBtn.classList.remove('btn-danger');
            } else {
                if (Object.values(channels).filter(c => c.type === 'monitoring').length === 0) {
                    alert('ë¨¼ì € ëª¨ë‹ˆí„°ë§í•  ì±„ë„ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
                    return;
                }
                startMonitoringBtn.textContent = 'â¸ï¸ ì±„ë„ ì¶”ì  ì¤‘ì§€';
                startMonitoringBtn.classList.remove('btn-primary');
                startMonitoringBtn.classList.add('btn-danger');
                startMonitoring();
            }
        });

        monitoringChannelGrid.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-channel-btn')) {
                const channelId = e.target.dataset.channelId;
                removeChannel(channelId);
            }
        });

        monitoringCollapseBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleChannelManagementSection('monitoring');
        });

        backupTrackingDataBtn.addEventListener('click', backupData);
        restoreTrackingDataBtn.addEventListener('click', () => restoreTrackingDataInput.click());
        restoreTrackingDataInput.addEventListener('change', restoreData);

        trackingSortOrderSelect.addEventListener('change', renderTrackingRecords);
        hotVideoRatioSelect.addEventListener('change', renderTrackingRecords);
        showAllChannelsCheckbox.addEventListener('change', renderTrackingRecords);

        if (addMonitoringChannelBtn) {
            addMonitoringChannelBtn.addEventListener('click', () => {
                openChannelModal('monitoring');
            });
        }

        if (addTrackingChannelBtn) {
            addTrackingChannelBtn.addEventListener('click', () => {
                openChannelModal('tracking');
            });
        }
        
        // ëª¨ë‹¬ì˜ 'ì¶”ê°€' ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        addChannelConfirmBtn.addEventListener('click', async () => {
            const inputValue = channelInput.value.trim();
            if (inputValue) {
                await addChannel(inputValue, currentChannelType);
                channelInput.value = '';
                closeModal(channelModal);
            } else {
                alert('ì±„ë„ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }
        });
    }

    // =====================================================================================================
    // ì´ˆê¸°í™”
    // =====================================================================================================
    document.addEventListener('DOMContentLoaded', () => {
        setupEventListeners();
        renderMonitoringChannels();
        renderLatestVideos();
    });
</script>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
