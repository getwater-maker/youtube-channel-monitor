<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë¡œì´ê°€ ë§Œë“  ìœ íŠœë¸Œ ì±„ë„ ëª¨ë‹ˆí„°</title>
  <link rel="icon" href="favicon.svg" />
  
  <!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.45/moment-timezone-with-data.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.js"></script>

  <style>
    :root {
      --brand: #c4302b;
      --brand-hover: #a02622;
      --gradient-brand: linear-gradient(135deg, #c4302b, #a02622);
      --glass-bg: rgba(255, 255, 255, 0.05);
      --border: #4a5568;
      --card: #2d3748;
      --text: #e4e6ea;
      --muted: #a0aec0;
      --bg: #1a1a1a;
    }

    .light {
      --glass-bg: rgba(0, 0, 0, 0.05);
      --border: #dee2e6;
      --card: #ffffff;
      --text: #333333;
      --muted: #6c757d;
      --bg: #f8f9fa;
    }

    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }

    .container { 
      max-width: 1400px; 
      margin: 0 auto; 
      padding: 20px; 
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 16px;
      margin-bottom: 24px;
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      width: 32px;
      height: 32px;
      border-radius: 8px;
    }

    .logo-section h1 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 800;
      background: var(--gradient-brand);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .nav-buttons {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .three-col { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); 
      gap: 24px; 
    }

    .col { 
      background: var(--card); 
      border-radius: 16px; 
      padding: 20px; 
      border: 2px solid var(--border); 
    }

    .col-head { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 16px;
      cursor: move;
    }

    .col-head h2 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 700;
    }

    .col-actions { 
      display: flex; 
      gap: 8px; 
      align-items: center; 
      flex-wrap: wrap; 
    }

    .btn { 
      padding: 8px 16px; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      font-weight: 600; 
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
      font-size: 14px;
    }

    .btn-primary { 
      background: var(--gradient-brand); 
      color: white; 
      box-shadow: 0 4px 15px rgba(196, 48, 43, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(196, 48, 43, 0.4);
    }

    .btn-secondary { 
      background: var(--glass-bg); 
      color: var(--text); 
      border: 2px solid var(--border); 
    }

    .btn-secondary:hover {
      background: var(--border);
      border-color: var(--brand);
      transform: translateY(-1px);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ff4757, #c44569);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
    }

    .btn-danger:hover {
      background: linear-gradient(135deg, #ff3742, #b73e56);
      transform: translateY(-1px);
    }

    .sort-row {
      padding: 12px 16px;
      background: var(--glass-bg);
      border-radius: 8px;
      margin-bottom: 16px;
      border: 1px solid var(--border);
    }

    .sort-row label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      color: var(--text);
      font-size: 14px;
    }

    .sort-row select {
      padding: 6px 12px;
      border: 2px solid var(--border);
      border-radius: 6px;
      background: var(--card);
      color: var(--text);
      font-weight: 600;
      cursor: pointer;
    }

    .empty-state { 
      text-align: center; 
      padding: 60px 20px; 
      color: var(--muted);
      background: var(--glass-bg);
      border-radius: 16px;
      border: 2px dashed var(--border);
      margin: 20px 0;
    }

    .empty-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.6;
    }

    .empty-state .muted {
      font-size: 16px;
      margin-bottom: 20px;
      color: var(--muted);
    }

    .channel-card {
      display: flex;
      gap: 16px;
      align-items: center;
      padding: 16px;
      border: 2px solid var(--border);
      border-radius: 12px;
      margin-bottom: 12px;
      background: var(--card);
      transition: all 0.3s;
    }

    .channel-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      border-color: var(--brand);
    }

    .channel-thumb {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      object-fit: cover;
      border: 2px solid var(--border);
    }

    .channel-meta {
      flex: 1;
    }

    .channel-meta h3 {
      margin: 0 0 8px 0;
      font-size: 1.1rem;
      font-weight: 700;
    }

    .channel-meta h3 a {
      color: var(--text);
      text-decoration: none;
    }

    .channel-meta .row {
      display: flex;
      gap: 16px;
      margin-bottom: 8px;
      flex-wrap: wrap;
      font-size: 13px;
      color: var(--muted);
    }

    .channel-meta .row strong {
      color: var(--text);
      font-weight: 700;
    }

    .channel-meta .latest {
      font-size: 12px;
      color: var(--muted);
    }

    .channel-actions {
      display: flex;
      gap: 8px;
    }

    .channel-insights {
      width: 100%;
      margin-top: 12px;
      padding: 12px;
      background: var(--glass-bg);
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .insights {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 8px;
      font-size: 11px;
    }

    .insights > div {
      display: flex;
      justify-content: space-between;
      padding: 4px 6px;
      background: var(--card);
      border-radius: 4px;
    }

    .insights .k {
      color: var(--muted);
      font-weight: 500;
    }

    .insights .v {
      font-weight: 700;
      color: var(--text);
    }

    .insights .v.positive { color: #1db954; }
    .insights .v.negative { color: #c4302b; }
    .insights .v.neutral { color: var(--text); }

    .video-card {
      border: 2px solid var(--border);
      border-radius: 12px;
      margin-bottom: 12px;
      background: var(--card);
      overflow: hidden;
      transition: all 0.3s;
    }

    .video-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      border-color: var(--brand);
    }

    .video-link {
      display: block;
      padding: 12px;
      text-decoration: none;
      color: inherit;
    }

    .thumb-wrap {
      position: relative;
      margin-bottom: 8px;
    }

    .thumb {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
    }

    .v-title {
      font-weight: 700;
      font-size: 14px;
      line-height: 1.4;
      margin-bottom: 8px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .v-meta {
      font-size: 12px;
      color: var(--muted);
    }

    .v-meta-top {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .v-meta-bottom {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .mutant-badge {
      background: linear-gradient(135deg, #ffa502, #ff6348);
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 700;
    }

    .mutant-indicator {
      color: var(--muted);
      font-size: 10px;
    }

    .video-done-checkbox {
      font-size: 10px;
      cursor: pointer;
    }

    .keywords {
      margin-bottom: 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .kw {
      background: var(--glass-bg);
      color: var(--text);
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      border: 1px solid var(--border);
    }

    .pagination { 
      display: flex; 
      gap: 8px; 
      justify-content: center; 
      margin-top: 16px; 
      flex-wrap: wrap;
    }

    .page-btn { 
      padding: 8px 12px; 
      border: 2px solid var(--border); 
      background: var(--card); 
      color: var(--text);
      border-radius: 8px; 
      cursor: pointer;
      font-weight: 600;
      min-width: 40px;
      transition: all 0.3s;
    }

    .page-btn:hover {
      background: var(--glass-bg);
      border-color: var(--brand);
      transform: translateY(-1px);
    }

    .page-btn.active { 
      background: var(--gradient-brand); 
      color: white; 
      border-color: var(--brand);
      box-shadow: 0 4px 12px rgba(196, 48, 43, 0.3);
    }

    .modal { 
      display: none; 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.7); 
      z-index: 1000; 
      align-items: center; 
      justify-content: center; 
    }

    .modal-content { 
      background: var(--card); 
      color: var(--text);
      padding: 24px; 
      border-radius: 16px; 
      max-width: 500px; 
      width: 90%; 
      max-height: 80vh; 
      overflow-y: auto;
      border: 2px solid var(--border);
    }

    .modal-large { 
      max-width: 800px; 
    }

    .close { 
      float: right; 
      font-size: 24px; 
      cursor: pointer; 
      color: var(--muted);
    }

    .close:hover {
      color: var(--brand);
    }

    .modal-description {
      color: var(--muted);
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .input-group {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .input-group input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: 8px;
      background: var(--card);
      color: var(--text);
      font-size: 14px;
    }

    .input-group input:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(196, 48, 43, 0.1);
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .add-tabs {
      display: flex;
      border-bottom: 2px solid var(--border);
      margin-bottom: 20px;
    }

    .add-tab {
      padding: 12px 20px;
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-weight: 600;
      border-bottom: 2px solid transparent;
      transition: all 0.3s;
    }

    .add-tab.active {
      color: var(--brand);
      border-bottom-color: var(--brand);
    }

    .add-tab-content {
      display: none;
    }

    .add-tab-content.active {
      display: block;
    }

    .examples {
      margin-top: 20px;
      padding: 16px;
      background: var(--glass-bg);
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .examples h4 {
      margin: 0 0 12px 0;
      color: var(--text);
      font-size: 14px;
    }

    .examples ul {
      margin: 0;
      padding-left: 20px;
    }

    .examples li {
      margin-bottom: 8px;
      font-size: 13px;
      color: var(--muted);
    }

    .examples code {
      background: var(--card);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
      color: var(--brand);
      border: 1px solid var(--border);
    }

    .date-range {
      display: flex;
      gap: 4px;
    }

    .date-range button {
      padding: 6px 12px;
      border: 2px solid var(--border);
      background: var(--card);
      color: var(--text);
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s;
    }

    .date-range button:hover {
      border-color: var(--brand);
    }

    .date-range button.active {
      background: var(--gradient-brand);
      color: white;
      border-color: var(--brand);
    }

    .channel-count-wrapper {
      font-weight: 600;
      color: var(--text);
      background: var(--glass-bg);
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      font-size: 14px;
    }

    .channel-count-wrapper #channel-count {
      color: var(--brand);
      font-weight: 700;
    }

    #toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      pointer-events: none;
      max-width: 400px;
    }

    .loading-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border);
      border-top: 3px solid var(--brand);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 16px;
        text-align: center;
      }
      
      .nav-buttons {
        width: 100%;
        justify-content: center;
        flex-wrap: wrap;
      }
      
      .three-col {
        grid-template-columns: 1fr;
      }
      
      .col-actions {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }
      
      .channel-card {
        flex-direction: column;
        text-align: center;
      }
      
      .channel-meta .row {
        justify-content: center;
      }
    }
  </style>
</head>

<body class="dark">
  <div class="container">
    <header>
      <div class="header-content">
        <div class="logo-section">
          <div style="width: 32px; height: 32px; background: var(--gradient-brand); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800;">Y</div>
          <h1>ìœ íŠœë¸Œ ì±„ë„ ëª¨ë‹ˆí„°</h1>
        </div>
        <nav class="nav-buttons">
          <button id="btn-analyze" class="btn btn-primary">ğŸ“Š ì±„ë„ ë¶„ì„</button>
          <button id="btn-toggle-theme" class="btn btn-secondary">ë¼ì´íŠ¸ ëª¨ë“œ</button>
          <button id="btn-api" class="btn btn-secondary">ğŸ”‘ API í‚¤</button>
        </nav>
      </div>
    </header>

    <main id="main-content" class="three-col">
      <!-- ì±„ë„ ì„¹ì…˜ -->
      <section class="col" data-col="channels">
        <div class="col-head" draggable="true">
          <h2>ğŸ“º ì±„ë„ ê´€ë¦¬</h2>
          <div class="col-actions">
            <button id="btn-add-channel" class="btn btn-primary">+ ì±„ë„ ì¶”ê°€</button> 
            <button id="btn-export-channels" class="btn btn-secondary">ğŸ“¥ ë‚´ë³´ë‚´ê¸°</button> 
            <button id="btn-import-channels" class="btn btn-secondary">ğŸ“¤ ê°€ì ¸ì˜¤ê¸°</button> 
            <input type="file" id="file-import-channels" accept="application/json" style="display:none" />
            <span class="channel-count-wrapper">ë“±ë¡: <span id="channel-count">0</span>ê°œ</span>
          </div>
        </div>
        <div class="sort-row">
          <label for="sort-channels">ì •ë ¬:
            <select id="sort-channels">
              <option value="subscribers" selected>êµ¬ë…ììˆ˜</option>
              <option value="videos">ì˜ìƒê°¯ìˆ˜</option>
              <option value="latest">ìµœê·¼ì—…ë¡œë“œ</option>
            </select>
          </label>
        </div>
        <div id="channel-list" class="channel-list">
          <div class="empty-state">
            <div class="empty-icon">ğŸ“º</div>
            <p class="muted">ì±„ë„ì„ ì¶”ê°€í•˜ì—¬ ì‹œì‘í•˜ì„¸ìš”</p>
            <button class="btn btn-primary" onclick="document.getElementById('btn-add-channel').click()">ì²« ì±„ë„ ì¶”ê°€í•˜ê¸°</button>
          </div>
        </div>
        <div id="channel-pagination" class="pagination"></div>
      </section>

      <!-- ëŒì—°ë³€ì´ ì˜ìƒ ì„¹ì…˜ -->
      <section class="col" data-col="mutant">
        <div class="col-head" draggable="true">
          <h2>ğŸš€ ëŒì—°ë³€ì´ ì˜ìƒ</h2>
          <div class="col-actions">
            <div class="date-range">
              <button data-period="1m">1ê°œì›”</button>
              <button data-period="3m">3ê°œì›”</button>
              <button class="active" data-period="6m">6ê°œì›”</button>
              <button data-period="all">ì „ì²´</button>
            </div>
          </div>
        </div>
        <div class="sort-row">
          <label for="sort-mutant">ì •ë ¬:
            <select id="sort-mutant">
              <option value="mutantIndex" selected>ëŒì—°ë³€ì´ì§€ìˆ˜</option>
              <option value="views">ì¡°íšŒìˆ˜</option>
              <option value="subscribers">êµ¬ë…ììˆ˜</option>
              <option value="latest">ìµœê·¼ì—…ë¡œë“œ</option>
            </select>
          </label>
        </div>
        <div id="mutant-keywords" class="keywords"></div>
        <div id="mutant-list" class="video-list">
          <div class="empty-state">
            <div class="empty-icon">ğŸš€</div>
            <p class="muted">ì±„ë„ì„ ì¶”ê°€í•˜ì—¬ ì˜ìƒì„ ë¶„ì„í•´ì£¼ì„¸ìš”</p>
          </div>
        </div>
        <div id="mutant-pagination" class="pagination"></div>
      </section>

      <!-- ìµœì‹  ì˜ìƒ ì„¹ì…˜ -->
      <section class="col" data-col="latest">
        <div class="col-head" draggable="true">
          <h2>ğŸ“± ìµœì‹  ì˜ìƒ</h2>
        </div>
        <div class="sort-row">
          <label for="sort-latest">ì •ë ¬:
            <select id="sort-latest">
              <option value="views" selected>ì¡°íšŒìˆ˜</option>
              <option value="subscribers">êµ¬ë…ììˆ˜</option>
              <option value="latest">ìµœê·¼ì—…ë¡œë“œ</option>
              <option value="mutantIndex">ëŒì—°ë³€ì´ì§€ìˆ˜</option>
            </select>
          </label>
        </div>
        <div id="latest-keywords" class="keywords"></div>
        <div id="latest-list" class="video-list">
          <div class="empty-state">
            <div class="empty-icon">ğŸ“±</div>
            <p class="muted">ì±„ë„ì„ ì¶”ê°€í•˜ì—¬ ì˜ìƒì„ ë¶„ì„í•´ì£¼ì„¸ìš”</p>
          </div>
        </div>
        <div id="latest-pagination" class="pagination"></div>
      </section>
    </main>
  </div>

  <!-- API í‚¤ ëª¨ë‹¬ -->
  <div id="modal-api" class="modal">
    <div class="modal-content">
      <span class="close" data-close="modal-api">&times;</span>
      <h3>ğŸ”‘ YouTube API í‚¤ ì„¤ì •</h3>
      <p class="modal-description">
        YouTube Data API v3 í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”. 
        <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color: var(--brand);">Google Cloud Console</a>ì—ì„œ ë°œê¸‰ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </p>
      
      <div class="api-input-section">
        <div id="api-inputs"></div>
      </div>
      
      <div class="modal-actions">
        <button id="api-save" class="btn btn-primary">ğŸ’¾ ì €ì¥</button>
        <button id="api-test" class="btn btn-secondary">ğŸ§ª í…ŒìŠ¤íŠ¸</button>
      </div>
      <div id="api-test-result" style="margin-top: 16px; padding: 12px; border-radius: 8px;"></div>
    </div>
  </div>

  <!-- ì±„ë„ ì¶”ê°€ ëª¨ë‹¬ -->
  <div id="modal-add" class="modal">
    <div class="modal-content modal-large">
      <span class="close" data-close="modal-add">&times;</span>
      <h3>ğŸ“º ì±„ë„ ì¶”ê°€</h3>
      
      <!-- íƒ­ ë©”ë‰´ -->
      <div class="add-tabs">
        <button class="add-tab active" data-add-tab="url">URL/ID ì§ì ‘ ì…ë ¥</button>
      </div>
      
      <!-- URL ì§ì ‘ ì…ë ¥ -->
      <div id="add-tab-url" class="add-tab-content active">
        <div class="input-group">
          <input type="text" id="url-input" placeholder="ì±„ë„ URL, ID, @í•¸ë“¤, ì˜ìƒ URL ë“±ì„ ì…ë ¥í•˜ì„¸ìš”" />
          <button id="btn-url-add" class="btn btn-primary">ì¶”ê°€</button>
        </div>
        <div id="url-result"></div>
        <div class="examples">
          <h4>ì…ë ¥ ì˜ˆì‹œ:</h4>
          <ul>
            <li>ì±„ë„ ID: <code>UC_x5XG1OV2P6uZZ5FSM9Ttw</code></li>
            <li>ì±„ë„ URL: <code>https://youtube.com/channel/UC_x5XG1OV2P6uZZ5FSM9Ttw</code></li>
            <li>í•¸ë“¤: <code>@GoogleDevelopers</code></li>
            <li>ì˜ìƒ URL: <code>https://youtube.com/watch?v=dQw4w9WgXcQ</code></li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- ë¶„ì„ ëª¨ë‹¬ -->
  <div id="modal-analyze" class="modal">
    <div class="modal-content">
      <span class="close" data-close="modal-analyze">&times;</span>
      <h3>ğŸ“Š ì±„ë„ ë¶„ì„</h3>
      <p class="modal-description">ë¶„ì„í•  ì±„ë„ì„ ì„ íƒí•˜ì„¸ìš”. ì‹¬ì¸µ ë¶„ì„ì—ëŠ” ì‹œê°„ì´ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      <div id="analyze-channel-list" class="analyze-list"></div>
    </div>
  </div>

  <script>
    // ì „ì—­ ì„¤ì • ë° ìƒíƒœ
    window.CONFIG = {
      API_BASE: 'https://www.googleapis.com/youtube/v3/',
      PAGINATION: {
        CHANNELS: 8,
        VIDEOS: 5
      },
      TIMEOUT: 30000,
      MUTANT_THRESHOLD: 2.0
    };

    window.state = {
      currentMutantPeriod: '6m',
      currentView: 'home',
      currentPage: {
        channels: 1,
        mutant: 1,
        latest: 1
      }
    };

    // API í‚¤ ê´€ë¦¬
    window.apiKeys = JSON.parse(localStorage.getItem('youtubeApiKeys') || '[]');
    window.keyIdx = 0;

    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
    window.qs = function(selector, scope = document) {
      try {
        if (selector.startsWith('#')) {
          return scope.getElementById ? scope.getElementById(selector.slice(1)) : scope.querySelector(selector);
        }
        return scope.querySelector(selector);
      } catch (e) {
        console.warn(`Element '${selector}' not found:`, e);
        return null;
      }
    };

    window.fmt = function(n) {
      if (!n && n !== 0) return '0';
      const num = parseInt(n.toString().replace(/,/g, ''), 10);
      if (isNaN(num)) return '0';
      return num.toLocaleString('ko-KR');
    };

    window.toast = function(msg, type = 'info', duration = 3000) {
      console.log('[TOAST]', msg);
      
      let container = document.getElementById('toast-container');
      if (!container) {
        container = document.createElement('div');
        container.id = 'toast-container';
        container.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          z-index: 10000;
          pointer-events: none;
          max-width: 400px;
        `;
        document.body.appendChild(container);
      }
      
      const toastEl = document.createElement('div');
      const typeConfig = {
        success: { icon: 'âœ…', color: '#1db954' },
        error: { icon: 'âŒ', color: '#c4302b' },
        warning: { icon: 'âš ï¸', color: '#ffa502' },
        info: { icon: 'â„¹ï¸', color: '#667eea' }
      };
      
      const config = typeConfig[type] || typeConfig.info;
      
      toastEl.innerHTML = `
        <div style="
          display: flex; 
          align-items: center; 
          gap: 12px;
          background: var(--card);
          color: var(--text);
          border: 2px solid ${config.color};
          border-radius: 12px;
          padding: 16px 20px;
          margin-bottom: 12px;
          font-size: 14px;
          font-weight: 600;
          box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
          transform: translateX(100%);
          transition: transform 0.3s ease;
          pointer-events: auto;
          cursor: pointer;
        ">
          <span style="font-size: 16px;">${config.icon}</span>
          <span>${msg}</span>
        </div>
      `;
      
      container.appendChild(toastEl);
      
      setTimeout(() => {
        toastEl.style.transform = 'translateX(0)';
      }, 10);
      
      const remove = () => {
        toastEl.style.transform = 'translateX(100%)';
        setTimeout(() => {
          if (toastEl.parentNode) {
            toastEl.parentNode.removeChild(toastEl);
          }
        }, 300);
      };
      
      setTimeout(remove, duration);
      toastEl.onclick = remove;
    };

    window.truncateText = function(text, maxLength = 30) {
      if (!text) return '';
      return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    };

    window.extractKeywords = function(text) {
      if (!text) return [];
      
      const stopWords = new Set([
        'ê·¸ë¦¬ê³ ', 'í•˜ì§€ë§Œ', 'ê·¸ëŸ¬ë‚˜', 'ë˜í•œ', 'ì´ì œ', 'ê·¸ë•Œ', 'ì´ê²ƒ', 'ì €ê²ƒ', 'ì—¬ê¸°', 'ê±°ê¸°',
        'ì´ëŸ°', 'ì €ëŸ°', 'ê°™ì€', 'ë‹¤ë¥¸', 'ìƒˆë¡œìš´', 'ì˜¤ë˜ëœ', 'í°', 'ì‘ì€', 'ì¢‹ì€', 'ë‚˜ìœ',
        'ë§ì€', 'ì ì€', 'ë¹ ë¥¸', 'ëŠë¦°', 'ì‰¬ìš´', 'ì–´ë ¤ìš´', 'ì¤‘ìš”í•œ', 'í•„ìš”í•œ', 'ê°€ëŠ¥í•œ'
      ]);

      const words = text
        .replace(/[^\w\sê°€-í£]/g, ' ')
        .split(/\s+/)
        .filter(w => w.length >= 2 && !stopWords.has(w) && !/^\d+$/.test(w))
        .map(w => w.toLowerCase());

      const freq = {};
      words.forEach(w => freq[w] = (freq[w] || 0) + 1);

      return Object.entries(freq)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 20);
    };

    window.seconds = function(iso) {
      if (!iso) return 0;
      const match = iso.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
      if (!match) return 0;
      const h = parseInt(match[1] || '0', 10);
      const m = parseInt(match[2] || '0', 10);
      const s = parseInt(match[3] || '0', 10);
      return h * 3600 + m * 60 + s;
    };

    // API í‚¤ ê´€ë¦¬ í•¨ìˆ˜
    window.setApiKeys = function(keys) {
      window.apiKeys = keys.filter(Boolean);
      window.keyIdx = 0;
      localStorage.setItem('youtubeApiKeys', JSON.stringify(window.apiKeys));
    };

    window.nextKey = function() { 
      if (window.apiKeys.length > 1) window.keyIdx = (window.keyIdx + 1) % window.apiKeys.length; 
    };

    window.hasKeys = function() { 
      return window.apiKeys.length > 0; 
    };

    // IndexedDB ê´€ë¦¬
    window.db = null;

    function openDB() { 
      return new Promise((res, rej) => { 
        if (window.db) return res(window.db); 
        const r = indexedDB.open('myChannelDB', 4);
        
        r.onupgradeneeded = e => { 
          window.db = e.target.result;
          if (!window.db.objectStoreNames.contains('my_channels')) {
            window.db.createObjectStore('my_channels', { keyPath: 'id' });
          }
          if (!window.db.objectStoreNames.contains('insights')) {
            window.db.createObjectStore('insights', { keyPath: 'channelId' });
          }
          if (!window.db.objectStoreNames.contains('dailySubs')) {
            window.db.createObjectStore('dailySubs', { keyPath: ['channelId', 'date'] });
          }
          if (!window.db.objectStoreNames.contains('doneVideos')) {
            window.db.createObjectStore('doneVideos', { keyPath: ['channelId', 'videoId'] });
          }
        };
        
        r.onsuccess = e => { 
          window.db = e.target.result; 
          res(window.db); 
        };
        
        r.onerror = e => rej(e);
      });
    }

    function idbAll(store) { 
      return openDB().then(db => new Promise((res, rej) => { 
        const tx = db.transaction(store, 'readonly'); 
        const s = tx.objectStore(store); 
        const q = s.getAll(); 
        q.onsuccess = () => res(q.result); 
        q.onerror = () => rej(q.error);
      })); 
    }

    function idbGet(store, key) { 
      return openDB().then(db => new Promise((res, rej) => { 
        const tx = db.transaction(store, 'readonly'); 
        const s = tx.objectStore(store); 
        const q = s.get(key); 
        q.onsuccess = () => res(q.result); 
        q.onerror = () => rej(q.error);
      })); 
    }

    function idbPut(store, obj) { 
      return openDB().then(db => new Promise((res, rej) => { 
        try { 
          const tx = db.transaction(store, 'readwrite'); 
          const s = tx.objectStore(store); 
          const q = s.put(obj); 
          q.onsuccess = () => res(); 
          q.onerror = () => rej(q.error); 
          tx.onerror = () => rej(tx.error);
        } catch (e) {
          rej(e);
        } 
      })); 
    }

    function idbDel(store, key) { 
      return openDB().then(db => new Promise((res, rej) => { 
        const tx = db.transaction(store, 'readwrite'); 
        const s = tx.objectStore(store); 
        const q = s.delete(key); 
        q.onsuccess = () => res(); 
        q.onerror = () => rej(q.error);
      })); 
    }

    // YouTube API í˜¸ì¶œ
    async function yt(endpoint, params, attempt = 0) {
      if (!window.hasKeys()) {
        throw new Error('API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.');
      }
      
      const ctrl = new AbortController();
      const timeout = setTimeout(() => ctrl.abort('timeout'), window.CONFIG.TIMEOUT);
      
      const p = new URLSearchParams(params);
      p.set('key', window.apiKeys[window.keyIdx]);
      const url = window.CONFIG.API_BASE + endpoint + '?' + p.toString();
      
      try {
        const r = await fetch(url, { signal: ctrl.signal });
        const data = await r.json();
        clearTimeout(timeout);
        
        if (data.error) {
          if (data.error.code === 403 && /quota/i.test(data.error.message || '')) {
            throw new Error('API í• ë‹¹ëŸ‰ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.');
          }
          if (attempt < window.apiKeys.length - 1) {
            window.nextKey();
            return yt(endpoint, params, attempt + 1);
          }
          throw new Error(data.error.message || 'API ì˜¤ë¥˜');
        }
        return data;
      } catch (e) {
        clearTimeout(timeout);
        if (attempt < window.apiKeys.length - 1) {
          window.nextKey();
          return yt(endpoint, params, attempt + 1);
        }
        throw e;
      }
    }

    // UI ê´€ë¦¬ í•¨ìˆ˜
    function openModal(id) { 
      const modal = qs('#' + id);
      if (modal) {
        modal.style.display = 'flex';
      }
    }

    function closeModal(id) { 
      const modal = qs('#' + id);
      if (modal) {
        modal.style.display = 'none';
      }
    }

    function loadTheme() {
      const savedTheme = localStorage.getItem('theme') || 'dark';
      const body = document.body;
      const btn = qs('#btn-toggle-theme');
      
      body.classList.remove('dark', 'light');
      body.classList.add(savedTheme);
      
      if (btn) {
        btn.textContent = savedTheme === 'dark' ? 'ë¼ì´íŠ¸ ëª¨ë“œ' : 'ë‹¤í¬ ëª¨ë“œ';
      }
    }

    function toggleTheme() {
      const body = document.body;
      const btn = qs('#btn-toggle-theme');
      
      if (body.classList.contains('dark')) {
        body.classList.remove('dark');
        body.classList.add('light');
        if (btn) btn.textContent = 'ë‹¤í¬ ëª¨ë“œ';
        localStorage.setItem('theme', 'light');
      } else {
        body.classList.remove('light');
        body.classList.add('dark');
        if (btn) btn.textContent = 'ë¼ì´íŠ¸ ëª¨ë“œ';
        localStorage.setItem('theme', 'dark');
      }
    }

    // ì±„ë„ ê´€ë¦¬ í•¨ìˆ˜
    async function getAllChannels() {
      return idbAll('my_channels');
    }

    async function deleteChannel(id) {
      await idbDel('my_channels', id);
      await idbDel('insights', id);
    }

    function sortChannels(list, mode) {
      if (mode === 'videos') {
        list.sort((a, b) => parseInt(b.videoCount || '0') - parseInt(a.videoCount || '0'));
      } else if (mode === 'latest') {
        list.sort((a, b) => new Date(b.latestUploadDate || 0) - new Date(a.latestUploadDate || 0));
      } else {
        list.sort((a, b) => parseInt(b.subscriberCount || '0') - parseInt(a.subscriberCount || '0'));
      }
    }

    async function getYesterdaySubCount(ch) {
      const y = moment().subtract(1, 'day').format('YYYY-MM-DD');
      const rec = await idbGet('dailySubs', [ch.id, y]);
      return rec ? rec.subCount : null;
    }

    async function updateDailySubSnapshot(ch) {
      const today = moment().format('YYYY-MM-DD');
      const ex = await idbGet('dailySubs', [ch.id, today]);
      if (!ex) {
        await idbPut('dailySubs', {
          channelId: ch.id,
          date: today,
          subCount: parseInt(ch.subscriberCount || '0', 10)
        });
      }
    }

    async function addChannelById(channelId) {
      if (!channelId) {
        toast('ì˜¬ë°”ë¥¸ ì±„ë„ IDê°€ ì•„ë‹™ë‹ˆë‹¤.', 'error');
        return false;
      }

      const exist = await idbGet('my_channels', channelId);
      if (exist) {
        toast('ì´ë¯¸ ë“±ë¡ëœ ì±„ë„ì…ë‹ˆë‹¤.', 'warning');
        return false;
      }

      try {
        const ch = await yt('channels', {
          part: 'snippet,statistics,contentDetails',
          id: channelId
        });

        const it = ch.items?.[0];
        if (!it) throw new Error('ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

        const uploads = it.contentDetails?.relatedPlaylists?.uploads || '';
        let latest = it.snippet.publishedAt;

        if (uploads) {
          try {
            const pl = await yt('playlistItems', {
              part: 'snippet',
              playlistId: uploads,
              maxResults: 1
            });
            if (pl.items && pl.items[0]) {
              latest = pl.items[0].snippet.publishedAt || latest;
            }
          } catch {}
        }

        const data = {
          id: it.id,
          title: it.snippet.title,
          thumbnail: it.snippet.thumbnails?.default?.url || '',
          subscriberCount: it.statistics.subscriberCount || '0',
          videoCount: it.statistics.videoCount || '0',
          uploadsPlaylistId: uploads,
          latestUploadDate: latest,
          country: it.snippet.country || '-'
        };

        await idbPut('my_channels', data);
        toast(`âœ… ${data.title} ì±„ë„ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        setTimeout(() => refreshChannels(), 50);
        return true;
      } catch (e) {
        toast('ì±„ë„ ì¶”ê°€ ì‹¤íŒ¨: ' + e.message, 'error');
        return false;
      }
    }

    async function refreshChannels() {
      try {
        const allChannels = await getAllChannels();
        
        for (const ch of allChannels) {
          await updateDailySubSnapshot(ch);
        }

        const sortSelect = qs('#sort-channels');
        const sortMode = sortSelect?.value || 'subscribers';
        sortChannels(allChannels, sortMode);

        const channelCountEl = qs('#channel-count');
        if (channelCountEl) {
          channelCountEl.textContent = allChannels.length.toString();
        }

        const wrap = qs('#channel-list');
        if (!wrap) return;

        if (!allChannels.length) {
          wrap.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">ğŸ“º</div>
              <p class="muted">ì±„ë„ì„ ì¶”ê°€í•˜ì—¬ ì‹œì‘í•˜ì„¸ìš”</p>
              <button class="btn btn-primary" onclick="document.getElementById('btn-add-channel').click()">ì²« ì±„ë„ ì¶”ê°€í•˜ê¸°</button>
            </div>
          `;
          return;
        }

        wrap.innerHTML = '';

        for (const ch of allChannels) {
          const y = await getYesterdaySubCount(ch);
          const today = parseInt(ch.subscriberCount || '0', 10);
          const diff = y == null ? null : today - y;
          const diffStr = y == null ? '<span class="v neutral">(ì „ì¼ ì •ë³´ ì—†ìŒ)</span>'
            : diff > 0 ? `<span class="v positive">+${fmt(diff)}</span>`
            : diff < 0 ? `<span class="v negative">${fmt(diff)}</span>`
            : `<span class="v neutral">0</span>`;

          const el = document.createElement('div');
          el.className = 'channel-card';
          el.innerHTML = `
            <a href="https://www.youtube.com/channel/${ch.id}" target="_blank" style="text-decoration: none;">
              <img class="channel-thumb" src="${ch.thumbnail || ''}" alt="${ch.title}">
            </a>
            <div class="channel-meta">
              <h3><a href="https://www.youtube.com/channel/${ch.id}" target="_blank">${ch.title}</a></h3>
              <div class="row">
                <span>êµ¬ë…ì: <strong>${fmt(today)}</strong></span>
                <span>ì˜ìƒ: <strong>${fmt(ch.videoCount)}</strong></span>
              </div>
              <div class="latest">ìµœì‹  ì—…ë¡œë“œ: ${ch.latestUploadDate ? moment(ch.latestUploadDate).format('YYYY-MM-DD') : '-'}</div>
            </div>
            <div class="channel-actions">
              <button class="btn-danger" onclick="deleteChannelHandler('${ch.id}')">ì‚­ì œ</button>
            </div>
            <div class="channel-insights">
              <div class="insights">
                <div><span class="k">ì „ì¼ëŒ€ë¹„</span> ${diffStr}</div>
                <div><span class="k">êµ­ê°€</span> <span class="v">${ch.country || '-'}</span></div>
              </div>
            </div>
          `;

          wrap.appendChild(el);
        }
      } catch (error) {
        console.error('refreshChannels ì˜¤ë¥˜:', error);
        toast('ì±„ë„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }

    // ì±„ë„ ì‚­ì œ í•¸ë“¤ëŸ¬
    window.deleteChannelHandler = async function(channelId) {
      if (confirm('ì±„ë„ì„ ì‚­ì œí• ê¹Œìš”?')) {
        try {
          await deleteChannel(channelId);
          await refreshChannels();
          toast('ì±„ë„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        } catch (e) {
          toast('ì±„ë„ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
      }
    };

    // ì±„ë„ ID ì¶”ì¶œ í•¨ìˆ˜
    async function extractChannelId(url) {
      if (!url) return null;
      
      url = url.trim();
      
      // ì´ë¯¸ ì±„ë„ IDì¸ ê²½ìš°
      if (/^UC[a-zA-Z0-9_-]{22}$/.test(url)) {
        return url;
      }
      
      // ì±„ë„ URLì—ì„œ ID ì¶”ì¶œ
      let match = url.match(/(?:youtube\.com|youtu\.be)\/channel\/([a-zA-Z0-9_-]+)/);
      if (match) return match[1];
      
      // @í•¸ë“¤ ì²˜ë¦¬
      match = url.match(/@([a-zA-Z0-9_-]+)/);
      if (match) {
        try {
          const searchRes = await yt('search', {
            part: 'snippet',
            q: '@' + match[1],
            type: 'channel',
            maxResults: 1
          });
          return searchRes.items?.[0]?.snippet?.channelId || null;
        } catch (e) {
          return null;
        }
      }

      // ì˜ìƒ URLì—ì„œ ì±„ë„ ID ì¶”ì¶œ
      match = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)/);
      if (match) {
        try {
          const videoRes = await yt('videos', {
            part: 'snippet',
            id: match[1]
          });
          return videoRes.items?.[0]?.snippet?.channelId || null;
        } catch (e) {
          return null;
        }
      }
      
      return null;
    }

    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    function bindEvents() {
      console.log('ì´ë²¤íŠ¸ ë°”ì¸ë”© ì‹œì‘');
      
      // API í‚¤ ë²„íŠ¼
      const btnApi = qs('#btn-api');
      console.log('API ë²„íŠ¼ ì°¾ìŒ:', !!btnApi);
      if (btnApi) {
        btnApi.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('API ë²„íŠ¼ í´ë¦­ë¨');
          openApiModal();
        });
      }

      // í…Œë§ˆ í† ê¸€
      const btnToggleTheme = qs('#btn-toggle-theme');
      console.log('í…Œë§ˆ ë²„íŠ¼ ì°¾ìŒ:', !!btnToggleTheme);
      if (btnToggleTheme) {
        btnToggleTheme.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('í…Œë§ˆ ë²„íŠ¼ í´ë¦­ë¨');
          toggleTheme();
        });
      }

      // ì±„ë„ ì¶”ê°€
      const btnAddChannel = qs('#btn-add-channel');
      console.log('ì±„ë„ ì¶”ê°€ ë²„íŠ¼ ì°¾ìŒ:', !!btnAddChannel);
      if (btnAddChannel) {
        btnAddChannel.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('ì±„ë„ ì¶”ê°€ ë²„íŠ¼ í´ë¦­ë¨');
          if (!window.hasKeys()) {
            toast('ë¨¼ì € API í‚¤ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.', 'warning');
            return;
          }
          openModal('modal-add');
        });
      }

      // ë¶„ì„ ë²„íŠ¼
      const btnAnalyze = qs('#btn-analyze');
      console.log('ë¶„ì„ ë²„íŠ¼ ì°¾ìŒ:', !!btnAnalyze);
      if (btnAnalyze) {
        btnAnalyze.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('ë¶„ì„ ë²„íŠ¼ í´ë¦­ë¨');
          if (!window.hasKeys()) {
            toast('ë¨¼ì € API í‚¤ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.', 'warning');
            return;
          }
          toast('ë¶„ì„ ê¸°ëŠ¥ì€ ì±„ë„ì„ ì¶”ê°€í•œ í›„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'info');
        });
      }

      // ëª¨ë‹¬ ë‹«ê¸°
      document.querySelectorAll('.close').forEach(closeBtn => {
        closeBtn.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ í´ë¦­ë¨');
          const modal = e.target.closest('.modal');
          if (modal) {
            modal.style.display = 'none';
          }
        });
      });

      // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            console.log('ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°');
            modal.style.display = 'none';
          }
        });
      });

      // ì±„ë„ ì¶”ê°€ ëª¨ë‹¬ ì´ë²¤íŠ¸
      bindChannelAddEvents();

      // API í‚¤ ëª¨ë‹¬ ì´ë²¤íŠ¸
      bindApiEvents();

      // ì •ë ¬ ë³€ê²½ ì´ë²¤íŠ¸
      const sortChannels = qs('#sort-channels');
      if (sortChannels) {
        sortChannels.addEventListener('change', () => {
          console.log('ì •ë ¬ ë³€ê²½ë¨');
          refreshChannels();
        });
      }

      console.log('ì´ë²¤íŠ¸ ë°”ì¸ë”© ì™„ë£Œ');
    }

    function openApiModal() {
      console.log('API ëª¨ë‹¬ ì—´ê¸° ì‹œì‘');
      const apiInputsContainer = qs('#api-inputs');
      console.log('API ì…ë ¥ ì»¨í…Œì´ë„ˆ ì°¾ìŒ:', !!apiInputsContainer);
      
      if (apiInputsContainer) {
        apiInputsContainer.innerHTML = '';
        
        for (let i = 0; i < 5; i++) {
          const apiKey = (window.apiKeys && window.apiKeys[i]) || '';
          const input = document.createElement('input');
          input.type = 'text';
          input.className = 'api-inp';
          input.placeholder = `API Key ${i + 1}`;
          input.value = apiKey;
          input.style.cssText = `
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--card);
            color: var(--text);
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
          `;
          apiInputsContainer.appendChild(input);
        }

        const testResult = qs('#api-test-result');
        if (testResult) testResult.innerHTML = '';

        console.log('API ëª¨ë‹¬ ì—´ê¸° ì‹œë„');
        openModal('modal-api');
      } else {
        console.error('API ì…ë ¥ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      }
    }

    function bindApiEvents() {
      console.log('API ì´ë²¤íŠ¸ ë°”ì¸ë”© ì‹œì‘');
      
      const apiSave = qs('#api-save');
      console.log('API ì €ì¥ ë²„íŠ¼ ì°¾ìŒ:', !!apiSave);
      if (apiSave) {
        apiSave.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('API ì €ì¥ ë²„íŠ¼ í´ë¦­ë¨');
          
          const keys = [...document.querySelectorAll('.api-inp')]
            .map(i => i.value.trim())
            .filter(Boolean);
          
          console.log('ì…ë ¥ëœ í‚¤ ê°œìˆ˜:', keys.length);
          
          window.setApiKeys(keys);
          toast('API í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
          
          const testResult = qs('#api-test-result');
          if (testResult) testResult.innerHTML = '';
          
          closeModal('modal-api');
          
          setTimeout(() => {
            refreshChannels();
          }, 500);
        });
      }

      const apiTest = qs('#api-test');
      console.log('API í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ì°¾ìŒ:', !!apiTest);
      if (apiTest) {
        apiTest.addEventListener('click', async (e) => {
          e.preventDefault();
          console.log('API í…ŒìŠ¤íŠ¸ ë²„íŠ¼ í´ë¦­ë¨');
          
          const keys = [...document.querySelectorAll('.api-inp')]
            .map(i => i.value.trim())
            .filter(Boolean);
          
          const testKeys = keys.length ? keys : (window.apiKeys || []);
          const testResult = qs('#api-test-result');

          if (!testKeys.length) {
            if (testResult) {
              testResult.innerHTML = '<span style="color: var(--brand);">ì €ì¥ëœ í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.</span>';
            }
            return;
          }

          if (testResult) {
            testResult.innerHTML = 'API í‚¤ í…ŒìŠ¤íŠ¸ ì¤‘...';
            testResult.style.background = 'var(--glass-bg)';
            testResult.style.border = '1px solid var(--border)';
          }

          let success = false;
          let lastError = '';

          for (const key of testKeys) {
            try {
              const testUrl = `${window.CONFIG.API_BASE}channels?part=id&id=UC_x5XG1OV2P6uZZ5FSM9Ttw&key=${encodeURIComponent(key)}`;
              const response = await fetch(testUrl);
              const data = await response.json();
              
              if (!data.error) {
                success = true;
                break;
              }
              lastError = data.error.message || JSON.stringify(data.error);
            } catch (e) {
              lastError = e.message || String(e);
            }
          }

          if (testResult) {
            testResult.innerHTML = success ?
              '<span style="color: #1db954;">âœ“ API í‚¤ê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤!</span>' :
              `<span style="color: var(--brand);">âœ— API í‚¤ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${lastError}</span>`;
          }
        });
      }
      
      console.log('API ì´ë²¤íŠ¸ ë°”ì¸ë”© ì™„ë£Œ');
    }

    function bindChannelAddEvents() {
      console.log('ì±„ë„ ì¶”ê°€ ì´ë²¤íŠ¸ ë°”ì¸ë”© ì‹œì‘');
      
      const btnUrlAdd = qs('#btn-url-add');
      const urlInput = qs('#url-input');
      
      console.log('URL ì¶”ê°€ ë²„íŠ¼ ì°¾ìŒ:', !!btnUrlAdd);
      console.log('URL ì…ë ¥ í•„ë“œ ì°¾ìŒ:', !!urlInput);
      
      if (btnUrlAdd && urlInput) {
        const handleUrlAdd = async () => {
          console.log('URL ì¶”ê°€ í•¸ë“¤ëŸ¬ ì‹¤í–‰');
          const input = urlInput.value.trim();
          if (!input) {
            toast('ì±„ë„ URL ë˜ëŠ” IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
            return;
          }

          const resultDiv = qs('#url-result');
          if (resultDiv) {
            resultDiv.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div>ì±„ë„ì„ ì¶”ê°€í•˜ëŠ” ì¤‘...</div>';
          }

          try {
            let channelId = await extractChannelId(input);
            
            if (!channelId) {
              toast('ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. URLì´ë‚˜ ì±„ë„ëª…ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
              if (resultDiv) resultDiv.innerHTML = '';
              return;
            }

            const success = await addChannelById(channelId);
            if (success) {
              closeModal('modal-add');
              urlInput.value = '';
              if (resultDiv) resultDiv.innerHTML = '';
            }
          } catch (e) {
            console.error('ì±„ë„ ì¶”ê°€ ì˜¤ë¥˜:', e);
            toast('ì±„ë„ ì¶”ê°€ ì‹¤íŒ¨: ' + e.message, 'error');
            if (resultDiv) resultDiv.innerHTML = '';
          }
        };

        btnUrlAdd.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('URL ì¶”ê°€ ë²„íŠ¼ í´ë¦­ë¨');
          handleUrlAdd();
        });
        
        urlInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            console.log('Enter í‚¤ë¡œ URL ì¶”ê°€');
            handleUrlAdd();
          }
        });
      }
      
      console.log('ì±„ë„ ì¶”ê°€ ì´ë²¤íŠ¸ ë°”ì¸ë”© ì™„ë£Œ');
    }

    // ì´ˆê¸°í™”
    function initializeApp() {
      console.log('ì•± ì´ˆê¸°í™” ì‹œì‘...');

      // moment.js ì„¤ì •
      if (typeof moment !== 'undefined') {
        moment.tz.setDefault('Asia/Seoul');
        moment.locale('ko');
        console.log('Moment.js ì„¤ì • ì™„ë£Œ');
      } else {
        console.warn('Moment.jsê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
      }

      // í…Œë§ˆ ë¡œë“œ
      loadTheme();
      console.log('í…Œë§ˆ ë¡œë“œ ì™„ë£Œ');

      // ì´ë²¤íŠ¸ ë°”ì¸ë”©
      bindEvents();

      // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ˆê¸°í™”
      if (typeof Sortable !== 'undefined') {
        const mainContent = qs('#main-content');
        if (mainContent) {
          Sortable.create(mainContent, {
            animation: 150,
            handle: '.col-head',
            onSort: () => {
              const keys = [...mainContent.children].map(n => n.getAttribute('data-col')); 
              localStorage.setItem('colOrder', keys.join(','));
            }
          });
          console.log('ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ˆê¸°í™” ì™„ë£Œ');
        }
      } else {
        console.warn('Sortable.jsê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
      }

      // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
      if (window.hasKeys()) {
        console.log('API í‚¤ ìˆìŒ, ì±„ë„ ë°ì´í„° ë¡œë“œ ì‹œì‘');
        setTimeout(() => {
          refreshChannels();
        }, 1000);
      } else {
        console.log('API í‚¤ ì—†ìŒ, ì„¤ì • ìš”ì²­');
        toast('API í‚¤ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”. ìš°ìƒë‹¨ ğŸ”‘ API í‚¤ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.', 'info');
      }

      console.log('ì•± ì´ˆê¸°í™” ì™„ë£Œ');
    }

ë£Œ');
      setTimeout(initializeApp, 100);
    });
