<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>로이가 만든 유튜브 채널 모니터</title>
<style>
  :root{
    --bg:#0b0d12; --card:#121622; --muted:#9aa3b2; --text:#e7edf5; --acc:#5da0ff; --acc2:#22c55e; --danger:#ef4444;
    --chip:#1b2233; --chip2:#17212c;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", "Apple SD Gothic Neo", sans-serif; background:var(--bg); color:var(--text)}
  a{color:var(--acc); text-decoration:none}
  .wrap{max-width:1200px; margin:0 auto; padding:24px}
  header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px}
  h1{font-size:22px; margin:0}
  .btn{background:#1e2638; color:var(--text); border:1px solid #293045; padding:8px 12px; border-radius:12px; cursor:pointer}
  .btn:hover{filter:brightness(1.05)}
  .btn.acc{background:var(--acc); color:#05111f; border-color:transparent}
  .row{display:flex; gap:16px; flex-wrap:wrap}
  .card{background:var(--card); border:1px solid #22283a; border-radius:16px; padding:16px; box-shadow:0 4px 16px rgb(0 0 0 / 25%)}
  .card h3{margin:0 0 8px 0}
  .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:16px}
  .col-6{grid-column:span 6}
  .col-12{grid-column:span 12}
  @media (max-width:880px){.col-6{grid-column:span 12}}
  .flex{display:flex; align-items:center; gap:8px}
  .flexb{display:flex; justify-content:space-between; align-items:center; gap:8px}
  .chip{display:inline-flex; align-items:center; gap:6px; background:var(--chip); border:1px solid #2a3247; color:#cfe2ff; padding:4px 8px; border-radius:999px; font-size:12px}
  .muted{color:var(--muted); font-size:13px}
  .field{display:flex; gap:8px; flex-wrap:wrap}
  input[type="text"], input[type="file"], select{background:#0e1320; color:var(--text); border:1px solid #27314b; padding:10px 12px; border-radius:10px; outline:none; min-width:240px}
  .mini{font-size:12px}
  .thumb{width:120px; height:68px; border-radius:10px; object-fit:cover; background:#0c0f18}
  .avatar{width:44px; height:44px; border-radius:50%; object-fit:cover; background:#0c0f18}
  .stat{display:inline-flex; gap:6px; align-items:center; padding:2px 8px; border-radius:999px; background:var(--chip2); border:1px solid #2a3247; font-size:12px}
  .badge{display:inline-flex; padding:6px 10px; border-radius:999px; border:1px solid #2a3247; background:#0d1522; font-weight:700}
  .center{text-align:center}
  .right{text-align:right}
  .sp{height:10px}
  .kv{display:flex; flex-wrap:wrap; gap:8px}
  .mut-score{display:inline-block; padding:8px 14px; border-radius:999px; background:linear-gradient(90deg,#3b82f6,#8b5cf6); color:white; font-weight:800; letter-spacing:.3px; box-shadow:0 4px 12px rgb(59 130 246 / 35%)}
  .divider{height:1px; background:#21283a; margin:12px 0}
  .keywords{display:flex; flex-wrap:wrap; gap:8px}
  .kw{background:#0f1729; border:1px solid #26304a; padding:6px 10px; border-radius:999px; font-size:12px}
  .table-like{display:grid; grid-template-columns: 56px 1fr auto; gap:12px; align-items:center}
  .line1, .line2, .line3{display:flex; align-items:center; justify-content:space-between; gap:8px}
  .line1 div, .line2 div, .line3 div{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .line3{justify-content:center}
  .checkbox{appearance:none; width:18px; height:18px; border-radius:6px; border:1px solid #2c3550; background:#0c1220; position:relative; cursor:pointer}
  .checkbox:checked{background:var(--acc2); border-color:var(--acc2)}
  .checkbox:checked::after{content:""; position:absolute; left:5px; top:1px; width:5px; height:10px; border:2px solid white; border-top:0; border-left:0; transform:rotate(45deg)}
  .toast{position:fixed; right:16px; bottom:16px; background:#0f172a; border:1px solid #27314b; color:var(--text); padding:12px 14px; border-radius:12px; display:none}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>로이가 만든 유튜브 채널 모니터</h1>
    <div class="field">
      <input id="apiKey" type="text" placeholder="YouTube API Key" />
      <button class="btn" onclick="saveApiKey()">저장</button>
      <button class="btn" onclick="openAddModal()">채널 추가</button>
      <button class="btn" onclick="exportChannels()">내보내기</button>
      <label class="btn" for="txtImport">가져오기</label>
      <input id="txtImport" type="file" accept=".txt" style="display:none" />
    </div>
  </header>

  <div class="grid">
    <section class="card col-6">
      <h3>돌연변이 영상</h3>
      <div id="mutantVideos"></div>
      <div class="divider"></div>
      <div class="flexb">
        <div class="muted mini">키워드(빈도 ≥ 2 · 이 섹션 범위만)</div>
        <button class="btn mini" onclick="refreshKeywords('mutant')">새로고침</button>
      </div>
      <div class="keywords" id="kwMutant"></div>
    </section>

    <section class="card col-6">
      <h3>최신 영상</h3>
      <div id="latestVideos"></div>
      <div class="divider"></div>
      <div class="flexb">
        <div class="muted mini">키워드(빈도 ≥ 2 · 이 섹션 범위만)</div>
        <button class="btn mini" onclick="refreshKeywords('latest')">새로고침</button>
      </div>
      <div class="keywords" id="kwLatest"></div>
    </section>

    <section class="card col-12">
      <h3>등록 채널</h3>
      <div id="channels"></div>
    </section>
  </div>
</div>

<!-- Add Modal -->
<dialog id="addModal" style="border:none;border-radius:16px;max-width:960px;width:96%;background:#0b1020;color:var(--text)">
  <form method="dialog" style="margin:0">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:16px 16px 0 16px">
      <div style="font-weight:700">채널 추가</div>
      <button class="btn" value="cancel">닫기</button>
    </div>
    <div style="padding:16px">
      <div class="field">
        <select id="tabSelect">
          <option value="channel">채널명 검색</option>
          <option value="video">영상 검색(롱폼만)</option>
          <option value="url">URL 직접 입력</option>
        </select>
        <input id="query" type="text" placeholder="검색어 또는 URL / @handle" />
        <button type="button" class="btn acc" onclick="doSearch()">검색</button>
        <select id="sortSelect"></select>
      </div>
      <div class="muted mini" id="hint"></div>
      <div class="divider"></div>
      <div id="results"></div>
      <div class="flexb" style="margin-top:12px">
        <div class="muted mini" id="resultInfo"></div>
        <div id="pagination" class="field"></div>
      </div>
    </div>
  </form>
</dialog>

<div id="toast" class="toast"></div>

<script>
// ------------------------------
// Storage
// ------------------------------
const LS_KEY = 'yt_channels_v2'; // [{id,title,thumb}]
const DONE_DB = 'doneVideos_v1';  // IndexedDB for checkboxes

function getChannels(){
  try{ return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); }catch(e){ return []; }
}
function setChannels(arr){
  localStorage.setItem(LS_KEY, JSON.stringify(arr));
  renderChannels();
}

function saveApiKey(){
  const v = document.getElementById('apiKey').value.trim();
  localStorage.setItem('yt_api_key', v);
  toast('API Key 저장됨');
}
function loadApiKey(){
  const v = localStorage.getItem('yt_api_key') || '';
  document.getElementById('apiKey').value = v;
  return v;
}
function toast(msg){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.display = 'block';
  setTimeout(()=>t.style.display='none', 2200);
}

// ------------------------------
// Add Modal
// ------------------------------
const addModal = document.getElementById('addModal');
document.getElementById('txtImport').addEventListener('change', (e)=> handleImportTxt(e.target.files?.[0]));

function openAddModal(){
  addModal.showModal();
  document.getElementById('tabSelect').value = 'channel';
  onTabChange();
}
document.getElementById('tabSelect').addEventListener('change', onTabChange);

function onTabChange(){
  const tab = document.getElementById('tabSelect').value;
  const sortSelect = document.getElementById('sortSelect');
  const hint = document.getElementById('hint');
  sortSelect.innerHTML = '';
  if(tab==='channel'){
    addOption(sortSelect,'subs_desc','구독자순');
    addOption(sortSelect,'videos_desc','영상수순');
    addOption(sortSelect,'latest_desc','최신업로드순');
    hint.innerHTML = '채널명으로 검색합니다. 썸네일/프로필 클릭 시 채널 새 탭 열림.';
  }else if(tab==='video'){
    addOption(sortSelect,'views_desc','조회수순');
    addOption(sortSelect,'subs_desc','채널 구독자순');
    addOption(sortSelect,'date_desc','업로드 최신순');
    hint.innerHTML = '롱폼(>=60초)만 검색합니다. 썸네일/제목 클릭 시 영상 새 탭 열림.';
  }else{
    hint.innerHTML = '채널/영상/플레이리스트 URL 또는 @handle을 붙여넣으세요. 채널로 정규화됩니다.';
  }
  document.getElementById('results').innerHTML='';
  document.getElementById('resultInfo').textContent='';
  document.getElementById('pagination').innerHTML='';
}

function addOption(sel, value, label){
  const o = document.createElement('option'); o.value=value; o.textContent=label; sel.appendChild(o);
}

let currentPage = 1;
let totalPages = 1;
let lastSearchCache = null;

async function doSearch(page=1){
  currentPage = page;
  const tab = document.getElementById('tabSelect').value;
  const q = document.getElementById('query').value.trim();
  const sort = document.getElementById('sortSelect').value;
  const key = loadApiKey();
  if(!key){ toast('먼저 API Key를 입력하세요'); return; }

  document.getElementById('results').innerHTML = '<div class="muted">검색 중...</div>';
  lastSearchCache = {tab, q, sort};

  try{
    if(tab==='channel'){
      await searchChannels(q, sort, page, key);
    }else if(tab==='video'){
      await searchVideos(q, sort, page, key);
    }else{
      await searchByUrl(q, key);
    }
  }catch(e){
    console.error(e);
    document.getElementById('results').innerHTML = '<div class="muted">오류: '+e.message+'</div>';
  }
}

function buildPagination(){
  const p = document.getElementById('pagination');
  p.innerHTML='';
  for(let i=1; i<=totalPages; i++){
    const b = document.createElement('button');
    b.className = 'btn mini';
    b.textContent = i;
    if(i===currentPage) b.style.background = '#2a3553';
    b.onclick = ()=>doSearch(i);
    p.appendChild(b);
  }
}

// ------------------------------
// Search: Channels
// ------------------------------
async function searchChannels(q, sort, page, key){
  if(!q){ document.getElementById('results').innerHTML=''; return; }
  const max = 4;
  const srch = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=channel&maxResults=${max}&q=${encodeURIComponent(q)}&pageToken=${encodeURIComponent(await pageTokenFor(page))}&key=${key}`);
  const sjson = await srch.json();
  const ids = (sjson.items||[]).map(i=>i.id.channelId).join(',');
  const details = ids ? await (await fetch(`https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics,contentDetails&id=${ids}&key=${key}`)).json() : {items:[]};
  totalPages = await inferTotalPages(sjson, max);
  renderChannelResults(details.items||[], sort, key);
  buildPagination();
  document.getElementById('resultInfo').textContent = `총 페이지: ${totalPages}`;
}

function renderChannelResults(items, sort, key){
  // Sort
  const arr = items.slice();
  if(sort==='subs_desc') arr.sort((a,b)=> (+b.statistics.subscriberCount||0) - (+a.statistics.subscriberCount||0));
  if(sort==='videos_desc') arr.sort((a,b)=> (+b.statistics.videoCount||0) - (+a.statistics.videoCount||0));
  if(sort==='latest_desc') arr.sort((a,b)=> new Date(b.snippet.publishedAt) - new Date(a.snippet.publishedAt));

  const host = document.getElementById('results'); host.innerHTML='';
  arr.forEach(ch=>{
    const el = document.createElement('div'); el.className='card'; el.style.marginBottom='8px';
    const ava = ch.snippet.thumbnails?.default?.url || '';
    el.innerHTML = `
      <div class="flexb">
        <div class="flex">
          <img class="avatar" src="${ava}" alt="avatar" onclick="window.open('https://www.youtube.com/channel/${ch.id}','_blank')"/>
          <div>
            <div style="font-weight:700">${escapeHtml(ch.snippet.title)}</div>
            <div class="muted mini">${escapeHtml(ch.snippet.customUrl||'')}</div>
          </div>
        </div>
        <button class="btn acc mini" onclick="addChannel('${ch.id}','${escapeHtmlAttr(ch.snippet.title)}','${ava}', '${key}')">추가</button>
      </div>
      <div class="kv" style="margin-top:8px">
        <span class="stat">구독자 ${formatNum(ch.statistics.subscriberCount)}</span>
        <span class="stat">영상 ${formatNum(ch.statistics.videoCount)}</span>
        <span class="stat">최신업로드 ${new Date(ch.snippet.publishedAt).toLocaleDateString()}</span>
        <span class="stat" id="first-${ch.id}">최초업로드 -</span>
        <span class="stat" id="oper-${ch.id}">운영기간 -</span>
      </div>
    `;
    host.appendChild(el);
    // lazy fetch first upload & period
    resolveFirstUploadAndPeriod(ch.id, key).then(info=>{
      if(!info) return;
      const f = document.getElementById(`first-${ch.id}`);
      const o = document.getElementById(`oper-${ch.id}`);
      if(f) f.textContent = `최초업로드 ${new Date(info.firstDate).toLocaleDateString()}`;
      if(o) o.textContent = `운영기간 ${formatPeriod(info.firstDate, new Date())}`;
    });
  });
}

// ------------------------------
// Search: Videos (long-form only)
// ------------------------------
async function searchVideos(q, sort, page, key){
  if(!q){ document.getElementById('results').innerHTML=''; return; }
  const max = 4;
  // search videos
  const searchUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=${max}&q=${encodeURIComponent(q)}&pageToken=${encodeURIComponent(await pageTokenFor(page))}&key=${key}`;
  const res = await fetch(searchUrl); const js = await res.json();
  const ids = (js.items||[]).map(i=>i.id.videoId).join(',');
  // video details (statistics, contentDetails to filter long-form)
  const vjs = ids ? await (await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics,contentDetails&id=${ids}&key=${key}`)).json() : {items:[]};
  // filter long-form (duration >= PT1M)
  const longVideos = (vjs.items||[]).filter(v=> iso8601ToSeconds(v.contentDetails?.duration||'PT0S') >= 60);
  // attach channel stats for display
  const channelIds = [...new Set(longVideos.map(v=>v.snippet.channelId))].join(',');
  const cjs = channelIds ? await (await fetch(`https://www.googleapis.com/youtube/v3/channels?part=statistics&id=${channelIds}&key=${key}`)).json() : {items:[]};
  const cMap = {}; (cjs.items||[]).forEach(c=>cMap[c.id]=c);
  // sort
  let arr = longVideos.slice();
  if(sort==='views_desc') arr.sort((a,b)=>(+b.statistics.viewCount||0) - (+a.statistics.viewCount||0));
  if(sort==='subs_desc') arr.sort((a,b)=>(+cMap[b.snippet.channelId]?.statistics?.subscriberCount||0) - (+cMap[a.snippet.channelId]?.statistics?.subscriberCount||0));
  if(sort==='date_desc') arr.sort((a,b)=> new Date(b.snippet.publishedAt) - new Date(a.snippet.publishedAt));

  totalPages = await inferTotalPages(js, max);
  buildPagination();
  document.getElementById('resultInfo').textContent = `총 페이지: ${totalPages}`;

  const host = document.getElementById('results'); host.innerHTML='';
  arr.forEach(v=>{
    const chStats = cMap[v.snippet.channelId]?.statistics || {};
    const thumb = v.snippet.thumbnails?.medium?.url || '';
    const views = formatNum(v.statistics.viewCount);
    const subs = formatNum(chStats.subscriberCount);
    const vcount = formatNum(chStats.videoCount);
    const date = new Date(v.snippet.publishedAt).toLocaleDateString();
    const vid = v.id;
    const url = `https://www.youtube.com/watch?v=${vid}`;
    const el = document.createElement('div'); el.className='card'; el.style.marginBottom='8px';
    el.innerHTML = `
      <div class="table-like">
        <img class="thumb" src="${thumb}" alt="thumb" onclick="window.open('${url}','_blank')"/>
        <div>
          <div style="font-weight:700; line-height:1.3; cursor:pointer" onclick="window.open('${url}','_blank')">${escapeHtml(v.snippet.title)}</div>
          <div class="kv" style="margin-top:6px">
            <span class="stat">채널 구독자 ${subs}</span>
            <span class="stat">채널 영상 ${vcount}</span>
            <span class="stat">영상 조회수 ${views}</span>
            <span class="stat">업로드 ${date}</span>
          </div>
        </div>
        <div><button class="btn acc mini" onclick="addChannel('${v.snippet.channelId}','${escapeHtmlAttr(v.snippet.channelTitle)}','','${key}')">채널 추가</button></div>
      </div>
    `;
    host.appendChild(el);
  });
}

// ------------------------------
// URL Direct
// ------------------------------
async function searchByUrl(q, key){
  if(!q){ document.getElementById('results').innerHTML=''; return; }
  const parsed = parseYouTubeInput(q);
  if(!parsed){ document.getElementById('results').innerHTML = '<div class="muted">지원되는 URL/@handle을 입력하세요.</div>'; return; }
  const chId = await resolveToChannelId(parsed, key);
  if(!chId){ document.getElementById('results').innerHTML = '<div class="muted">채널을 찾을 수 없습니다.</div>'; return; }
  const cj = await (await fetch(`https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics,contentDetails&id=${chId}&key=${key}`)).json();
  renderChannelResults(cj.items || [], 'subs_desc', key);
  totalPages = 1; buildPagination();
  document.getElementById('resultInfo').textContent = '';
}

function parseYouTubeInput(text){
  const v = text.trim();
  if(v.startsWith('@')) return {type:'handle', value:v.slice(1)};
  try{
    const u = new URL(v);
    if(u.hostname.includes('youtube.com') || u.hostname.includes('youtu.be')){
      if(u.pathname.startsWith('/channel/')) return {type:'channel', value:u.pathname.split('/')[2]};
      if(u.pathname.startsWith('/@')) return {type:'handle', value:u.pathname.slice(2)};
      if(u.searchParams.get('v')) return {type:'video', value:u.searchParams.get('v')};
      if(u.pathname.startsWith('/watch')) return {type:'video', value:u.searchParams.get('v')};
      if(u.pathname.startsWith('/playlist')) return {type:'playlist', value:u.searchParams.get('list')};
      if(u.hostname==='youtu.be' && u.pathname.length>1) return {type:'video', value:u.pathname.slice(1)};
    }
  }catch(e){ /* not URL */ }
  // Maybe plain channel id
  if(/^UC[0-9A-Za-z_-]{22}$/.test(v)) return {type:'channel', value:v};
  return null;
}

async function resolveToChannelId(parsed, key){
  if(parsed.type==='channel') return parsed.value;
  if(parsed.type==='handle'){
    const r = await fetch(`https://www.googleapis.com/youtube/v3/channels?part=id&forHandle=${encodeURIComponent(parsed.value)}&key=${key}`);
    const j = await r.json(); return j.items?.[0]?.id;
  }
  if(parsed.type==='video'){
    const r = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${parsed.value}&key=${key}`);
    const j = await r.json(); return j.items?.[0]?.snippet?.channelId;
  }
  if(parsed.type==='playlist'){
    const r = await fetch(`https://www.googleapis.com/youtube/v3/playlists?part=snippet&id=${parsed.value}&key=${key}`);
    const j = await r.json(); return j.items?.[0]?.snippet?.channelId;
  }
  return null;
}

// ------------------------------
// Add Channel & rendering
// ------------------------------
async function addChannel(id, title, thumb, key){
  const list = getChannels();
  if(list.some(c=>c.id===id)){ toast('이미 추가된 채널'); return; }
  setChannels([...list, {id, title, thumb}]);
  toast('채널이 추가되었습니다');
  // also compute first upload in background for cache
  resolveFirstUploadAndPeriod(id, key).catch(()=>{});
}

async function resolveFirstUploadAndPeriod(channelId, key){
  try{
    // get uploads playlist id
    const ch = await (await fetch(`https://www.googleapis.com/youtube/v3/channels?part=contentDetails&id=${channelId}&key=${key}`)).json();
    const up = ch.items?.[0]?.contentDetails?.relatedPlaylists?.uploads;
    if(!up) return null;
    // page through to the end to find oldest
    let token='', oldest=null;
    while(true){
      const pj = await (await fetch(`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&playlistId=${up}&maxResults=50&pageToken=${token}&key=${key}`)).json();
      const items = pj.items||[];
      if(items.length===0) break;
      // last page? if nextPageToken missing, the last item is oldest
      if(!pj.nextPageToken){
        const last = items[items.length-1];
        oldest = last.snippet?.publishedAt;
        break;
      }
      token = pj.nextPageToken;
    }
    if(!oldest) return null;
    return {firstDate: new Date(oldest)};
  }catch(e){ console.error(e); return null; }
}

function formatPeriod(startDate, endDate){
  const s = new Date(startDate), e = new Date(endDate);
  let years=0, months=0, weeks=0, days=0;
  // step years
  let d = new Date(s);
  while(new Date(d.getFullYear()+1, d.getMonth(), d.getDate()) <= e){
    d = new Date(d.getFullYear()+1, d.getMonth(), d.getDate()); years++;
  }
  // step months
  while(new Date(d.getFullYear(), d.getMonth()+1, d.getDate()) <= e){
    d = new Date(d.getFullYear(), d.getMonth()+1, d.getDate()); months++;
  }
  // remaining days
  const diffDays = Math.floor((e - d) / (1000*60*60*24));
  weeks = Math.floor(diffDays / 7);
  days = diffDays % 7;

  // Display rule
  if(years>=1){
    return `${years}년 ${months}개월`;
  }else if(months>=1){
    return `${months}개월${weeks?` ${weeks}주`:''}`.trim();
  }else if(weeks>=1){
    return `${weeks}주`;
  }else{
    return `${diffDays}일`;
  }
}

// ------------------------------
// Render main channel list
// ------------------------------
async function renderChannels(){
  const key = loadApiKey();
  const host = document.getElementById('channels'); host.innerHTML='';
  const list = getChannels();
  if(list.length===0){ host.innerHTML='<div class="muted">등록된 채널이 없습니다. 우측 상단 "채널 추가"를 눌러 등록하세요.</div>'; return; }

  for(const ch of list){
    const cj = key ? await (await fetch(`https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics&id=${ch.id}&key=${key}`)).json() : {items:[]};
    const c = cj.items?.[0];
    const ava = c?.snippet?.thumbnails?.default?.url || ch.thumb || '';
    const firstInfo = key ? await resolveFirstUploadAndPeriod(ch.id, key) : null;
    const firstText = firstInfo ? new Date(firstInfo.firstDate).toLocaleDateString() : '-';
    const operText = firstInfo ? formatPeriod(firstInfo.firstDate, new Date()) : '-';

    const el = document.createElement('div'); el.className='card'; el.style.marginBottom='10px';
    el.innerHTML = `
      <div class="flexb">
        <div class="flex">
          <img class="avatar" src="${ava}" alt="avatar" onclick="window.open('https://www.youtube.com/channel/${ch.id}','_blank')" />
          <div>
            <div style="font-weight:700">${escapeHtml(c?.snippet?.title || ch.title || ch.id)}</div>
            <div class="muted mini">${escapeHtml(c?.snippet?.customUrl || '')}</div>
          </div>
        </div>
        <div class="kv">
          <span class="stat">구독자 ${formatNum(c?.statistics?.subscriberCount)}</span>
          <span class="stat">영상 ${formatNum(c?.statistics?.videoCount)}</span>
          <span class="stat">운영기간 ${operText}</span>
          <span class="stat">최초 업로드 ${firstText}</span>
        </div>
      </div>
    `;
    host.appendChild(el);
  }
}

// ------------------------------
// Cards (mutant/latest) demo rendering
// NOTE: In a real app, replace with your data fetch. Here we render from sample arrays for layout.
// ------------------------------
let demoMutantVideos = []; // filled when user searches normally in your app
let demoLatestVideos = [];

function renderVideoList(sectionId, videos){
  const host = document.getElementById(sectionId); host.innerHTML='';
  videos.forEach(v=>{
    const el = document.createElement('div'); el.className='card'; el.style.marginBottom='8px';
    const vid = v.id; const url = `https://www.youtube.com/watch?v=${vid}`;
    const checked = isVideoDone(vid);
    el.innerHTML = `
      <div class="line1">
        <div>
          <img class="thumb" src="${v.thumb}" alt="thumb" onclick="window.open('${url}','_blank')" />
          <div style="font-weight:700; cursor:pointer" onclick="window.open('${url}','_blank')">${escapeHtml(v.title)}</div>
        </div>
        <div class="mut-score">${v.mutantBadge || '지수 72.4'}</div>
      </div>
      <div class="sp"></div>
      <div class="line1">
        <div class="muted mini">${escapeHtml(v.channel)} · 구독자 ${formatNum(v.subscribers)} · 조회수 ${formatNum(v.views)}</div>
      </div>
      <div class="line2">
        <div class="muted mini">업로드 ${new Date(v.publishedAt).toLocaleDateString()}</div>
        <div class="muted mini">영상제작완료 <input type="checkbox" class="checkbox" ${checked?'checked':''} onchange="toggleVideoDone('${vid}', this.checked)"></div>
      </div>
      <div class="line3">
        <div class="mut-score">${v.mutantBadge || '지수 72.4'}</div>
      </div>
    `;
    host.appendChild(el);
  });
}

function refreshKeywords(scope){
  // Build from that section only
  const videos = scope==='mutant' ? demoMutantVideos : demoLatestVideos;
  const kws = extractKeywords(videos.map(v=> `${v.title} ${v.description||''}`));
  const box = document.getElementById(scope==='mutant' ? 'kwMutant' : 'kwLatest'); box.innerHTML='';
  kws.forEach(([w,c])=>{
    const s = document.createElement('span'); s.className='kw'; s.textContent = `${w} · ${c}`; box.appendChild(s);
  });
}

// ------------------------------
// Keyword extraction (ko)
// - Per-section only
// - remove low-quality words, freq >= 2
// ------------------------------
const STOPWORDS = new Set([
  '그리고','그러나','하지만','또한','그래서','때문','이번','영상','오늘','정말','너무','조금','또','더','하는','있는','없는','에서','으로','하다','했다','것','수','등',
  '사라졌습니다','나선','만에','하다가','합니다','했어요','하세요','시청','구독','좋아요','댓글','영상입니다','만든','까지','합니다','관련','대한','최근','소개',
  'the','and','or','with','for','from','into','into','this','that','those','these','are','was','were','been','have','has','had','you','your','our',
  '입니다','네요','인데','하면','했는데','하고','하거나','되나요','됐다','되었다','됐다가','됐다네요','대한','입니다만','라고','으로써','위해','가장','최고'
]);

function tokenizeKo(text){
  const clean = (text||'').toLowerCase().replace(/[^\p{L}\p{N}\s]/gu,' ');
  return clean.split(/\s+/).filter(w=> w.length>=2 && !STOPWORDS.has(w) && !/^\d+$/.test(w));
}

function extractKeywords(texts){
  const freq = new Map();
  texts.forEach(t=>{
    tokenizeKo(t).forEach(w=> freq.set(w, (freq.get(w)||0)+1));
  });
  // keep freq >= 2
  const arr = [...freq.entries()].filter(([w,c])=> c>=2).sort((a,b)=> b[1]-a[1]);
  return arr.slice(0,30);
}

// ------------------------------
// Utilities
// ------------------------------
function iso8601ToSeconds(dur){
  const m = dur.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/); if(!m) return 0;
  const h = +m[1]||0, mi=+m[2]||0, s=+m[3]||0; return h*3600+mi*60+s;
}
function formatNum(n){ n=+n||0; return n.toLocaleString('ko-KR'); }
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function escapeHtmlAttr(s){ return (s||'').replace(/["']/g, m=> ({'"':'&quot;',"'":'&#39;'}[m])); }

async function pageTokenFor(page){
  // Because Search API uses tokens not numeric pages; here we keep it simple
  // For demo purposes, page>1 returns '' (first page). Real implementation would store tokens sequence.
  if(page<=1) return '';
  return '';
}
async function inferTotalPages(searchJson, pageSize){ 
  // Unknown from API without totalResults; YouTube v3 returns searchInformation not available.
  // We'll conservatively show up to 10 pages if nextPageToken exists, else 1.
  return searchJson.nextPageToken ? 10 : 1;
}

// ------------------------------
// Export / Import TXT
// ------------------------------
function exportChannels(){
  const list = getChannels();
  const rows = list.map(c=> `${c.id}\t${c.title||''}`).join('\n');
  const blob = new Blob([rows], {type:'text/plain;charset=utf-8'});
  const a = document.createElement('a');
  const y = new Date(); const ymd = `${y.getFullYear()}${String(y.getMonth()+1).padStart(2,'0')}${String(y.getDate()).padStart(2,'0')}`;
  a.href = URL.createObjectURL(blob);
  a.download = `channels-${ymd}.txt`;
  a.click();
  URL.revokeObjectURL(a.href);
}

async function handleImportTxt(file){
  if(!file) return;
  const key = loadApiKey();
  if(!key){ toast('먼저 API Key를 입력하세요'); return; }
  const text = await file.text();
  const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const added = []; const skipped = [];
  for(const line of lines){
    try{
      const parsed = parseYouTubeInput(line) || {type:'channel', value: line}; // bare id fallback
      const cid = await resolveToChannelId(parsed, key);
      if(!cid){ skipped.push({line, reason:'채널 없음'}); continue; }
      const list = getChannels();
      if(list.some(c=>c.id===cid)){ skipped.push({line, reason:'중복'}); continue; }
      // fetch title
      const cj = await (await fetch(`https://www.googleapis.com/youtube/v3/channels?part=snippet&id=${cid}&key=${key}`)).json();
      const title = cj.items?.[0]?.snippet?.title || cid;
      setChannels([...getChannels(), {id:cid, title}]);
      added.push(cid);
    }catch(e){
      skipped.push({line, reason:'오류'});
    }
  }
  toast(`가져오기 완료: ${added.length}개 추가, ${skipped.length}개 건너뜀`);
}

// ------------------------------
// IndexedDB for "영상제작완료"
// ------------------------------
function openDoneDB(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(DONE_DB, 1);
    req.onupgradeneeded = ()=>{ req.result.createObjectStore('done', {keyPath:'id'}); };
    req.onsuccess = ()=> resolve(req.result);
    req.onerror = ()=> reject(req.error);
  });
}
async function isVideoDone(id){
  const db = await openDoneDB();
  return new Promise(res=>{
    const tx = db.transaction('done'); const st = tx.objectStore('done'); const rq = st.get(id);
    rq.onsuccess = ()=> res(!!rq.result); rq.onerror = ()=> res(false);
  });
}
async function toggleVideoDone(id, state){
  const db = await openDoneDB(); const tx = db.transaction('done','readwrite'); const st = tx.objectStore('done');
  if(state) st.put({id}); else st.delete(id);
}

// ------------------------------
// Boot
// ------------------------------
loadApiKey();
renderChannels();
// demo lists (for layout preview only)
demoMutantVideos = [
  {id:'abc1', title:'놀라운 실험으로 급상승!', channel:'실험실TV', subscribers:1230000, views:348902, publishedAt:'2024-02-11', thumb:'https://i.ytimg.com/vi/aqz-KE-bpKQ/mqdefault.jpg', mutantBadge:'돌연변이 지수 83.2'},
  {id:'abc2', title:'예상 못한 결과 공개', channel:'테스트연구소', subscribers:85000, views:99012, publishedAt:'2024-05-01', thumb:'https://i.ytimg.com/vi/dQw4w9WgXcQ/mqdefault.jpg', mutantBadge:'돌연변이 지수 71.4'}
];
demoLatestVideos = [
  {id:'def1', title:'신제품 개봉기', channel:'리뷰왕', subscribers:250000, views:120034, publishedAt:'2025-07-05', thumb:'https://i.ytimg.com/vi/aqz-KE-bpKQ/mqdefault.jpg', mutantBadge:'돌연변이 지수 36.5'},
  {id:'def2', title:'사용 꿀팁 10가지', channel:'리뷰왕', subscribers:250000, views:56034, publishedAt:'2025-07-09', thumb:'https://i.ytimg.com/vi/dQw4w9WgXcQ/mqdefault.jpg', mutantBadge:'돌연변이 지수 44.1'}
];
renderVideoList('mutantVideos', demoMutantVideos);
renderVideoList('latestVideos', demoLatestVideos);
refreshKeywords('mutant');
refreshKeywords('latest');
</script>
</body>
</html>
