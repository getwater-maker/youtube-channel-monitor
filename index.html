<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>로이가 만든 유튜브 채널 모니터</title>
<link rel="icon" href="favicon.ico"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.45/moment-timezone-with-data.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<style>
/* 테마 변수 */
:root {
  --brand: #c4302b;
  --bg: #f6f7fb;
  --card: #fff;
  --muted: #888;
  --shadow: 0 6px 22px rgba(0,0,0,.07);
  --pastel1: #fff6f1;
  --pastel2: #f1fbff;
  --pastel3: #f8fff4;
  --text: #333;
  --border: #f0f0f0;
  --placeholder: #ccc;
  --modal-bg: rgba(0,0,0,.45);
}

/* 나이트 모드 변수 */
body.dark {
  --bg: #1e1e1e;
  --card: #2d2d2d;
  --muted: #b0b0b0;
  --shadow: 0 6px 22px rgba(0,0,0,.3);
  --pastel1: #4a3e3d;
  --pastel2: #3e4a4e;
  --pastel3: #424a40;
  --text: #e0e0e0;
  --border: #3c3c3c;
  --placeholder: #555;
  --modal-bg: rgba(255,255,255,.15);
}

/* 나이트 모드 스크롤바 */
body.dark::-webkit-scrollbar { width: 10px; }
body.dark::-webkit-scrollbar-track { background: #2d2d2d; }
body.dark::-webkit-scrollbar-thumb { background-color: #555; border-radius: 6px; border: 2px solid #2d2d2d; }
body.dark::-webkit-scrollbar-thumb:hover { background-color: #666; }

/* 기본 스타일 */
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:Arial,Helvetica,sans-serif;
  line-height:1.55;
  transition: background-color 0.3s, color 0.3s;
}
.container{max-width:1440px;margin:24px auto;background:var(--card);padding:22px;border-radius:16px;box-shadow:var(--shadow)}
h1{margin:6px 0 14px;text-align:center;color:var(--brand)}
.single-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:8px;}
.single-header .row{gap:8px;}
.api-btn, .analyze-btn, .toggle-btn{background:var(--brand);color:#fff;border:0;border-radius:8px;padding:8px 14px;cursor:pointer}
.toggle-btn{background:#6c757d;}
.three-col{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
@media (max-width:900px){.three-col{grid-template-columns:1fr}}
.col{background:var(--card);border-radius:14px;box-shadow:var(--shadow);padding:14px;display:flex;flex-direction:column;gap:10px}
.col-head{display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid var(--border);padding-bottom:8px;cursor:grab}
.col-actions{display:flex;gap:8px;align-items:center}
.sort-row{display:flex;justify-content:flex-end}
.sort-row select{padding:6px 10px;border:1px solid var(--border);border-radius:6px;background:var(--card);color:var(--text);}
.muted{color:var(--muted);text-align:center}

/* 채널 카드 */
.channel-list{display:flex;flex-direction:column;gap:10px}
.channel-card{
  display:grid;
  grid-template-columns:56px 1fr auto;
  gap:12px;
  align-items:center;
  border:1px solid var(--border);
  background:var(--bg);
  border-radius:12px;
  padding:12px
}
.channel-thumb{width:56px;height:56px;border-radius:50%;object-fit:cover;background:var(--bg)}
.channel-thumb-link{display:block;border-radius:50%}
.channel-meta h3{margin:0 0 4px 0;font-weight:800}
.channel-title-link{color:var(--brand);text-decoration:none}
.channel-title-link:hover{text-decoration:underline}
.channel-meta .row{display:flex;gap:10px;flex-wrap:wrap;font-size:13px}
.channel-meta .latest{font-size:12px;color:var(--muted)}
.channel-actions{display:flex;gap:6px;justify-content:flex-end}
.btn{border:1px solid var(--border);background:var(--bg);color:var(--brand);border-radius:6px;padding:6px 10px;cursor:pointer;transition:all 0.3s;}
.btn:hover{background:var(--brand);color:#fff}
.btn-danger{background:#dc3545;color:#fff;border:none}

/* 인사이트를 카드 하단 전체폭으로 */
.channel-insights{grid-column:1 / -1;margin-top:6px}
.insights{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px 12px;font-size:12px}
@media (max-width:1000px){.insights{grid-template-columns:repeat(2,minmax(0,1fr))}}
@media (max-width:600px){.insights{grid-template-columns:1fr}}
.insights .k{color:var(--muted)}.insights .v{font-weight:600}

/* 영상 카드 */
.video-list{display:flex;flex-direction:column;gap:12px}
.video-card{border-radius:14px;box-shadow:var(--shadow);overflow:hidden}
.video-card:nth-child(3n+1){background:var(--pastel1)}
.video-card:nth-child(3n+2){background:var(--pastel2)}
.video-card:nth-child(3n+3){background:var(--pastel3)}
.video-link{display:block;color:inherit;text-decoration:none;padding:12px}
.thumb-wrap{padding:10px}
.thumb{width:100%;height:auto;object-fit:contain;aspect-ratio:16/9;display:block}
.v-title{font-weight:700;margin:8px 2px 6px}
.v-meta{font-size:13px;color:var(--muted);display:flex;gap:12px;flex-wrap:wrap}
.badge{display:inline-block;background:linear-gradient(90deg,#e4002b 40%,#fdcf6f 100%);color:#fff;border-radius:14px;padding:4px 10px;font-weight:800;margin-top:8px}
.keywords{display:flex;flex-wrap:wrap;gap:6px}
.kw{font-size:12px;background:var(--border);border-radius:999px;padding:4px 8px}

/* 모달/검색 */
.modal{display:none;position:fixed;inset:0;background:var(--modal-bg);z-index:10;align-items:center;justify-content:center}
.modal .content{background:var(--card);border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.25);padding:16px;max-width:720px;width:96%}
.modal .close{float:right;font-size:22px;color:var(--muted);cursor:pointer}
.api-inputs{display:grid;grid-template-columns:1fr;gap:6px;margin:8px 0}
.api-inp, .search-input{width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;background:var(--card);color:var(--text);}
.api-inp::placeholder, .search-input::placeholder{color:var(--placeholder);}
.file-label{background:#6c757d;color:#fff;border-radius:8px;padding:8px 12px;display:inline-block;cursor:pointer}
.file-label input{display:none}
.tabs{display:flex;gap:6px;margin:8px 0 10px}
.tab{border:1px solid var(--border);background:var(--bg);border-radius:6px;padding:6px 10px;cursor:pointer;color:var(--text);}
.tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}
.tabpanel{display:none}.tabpanel.active{display:block}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.result-list{display:flex;flex-direction:column;gap:10px;max-height:420px;overflow:auto}
.result-row{display:grid;grid-template-columns:64px 1fr auto;gap:10px;align-items:center;border:1px solid var(--border);border-radius:10px;padding:10px;cursor:pointer;background:var(--bg);}
.result-row:hover{background:var(--border)}
.r-avatar{width:64px;height:64px;border-radius:50%;object-fit:contain;background:var(--card);border:1px solid var(--border)}
.r-thumb{width:64px;height:64px;border-radius:8px;object-fit:contain;background:var(--card);border:1px solid var(--border)}
.r-title{font-weight:700;margin-bottom:3px;color:var(--text)}.r-sub{font-size:12px;color:var(--muted)}
.pagination{display:flex;gap:6px;justify-content:center;margin-top:8px}
.pagination button{padding:6px 10px;border:1px solid var(--border);background:var(--bg);color:var(--text);border-radius:6px;cursor:pointer}
.pagination button.active{background:var(--brand);color:#fff;border-color:var(--brand)}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:.95;z-index:9999;display:none}
.small{font-size:12px;color:var(--muted)}
.test-ok{color:#1db954}.test-bad{color:#c4302b}
.date-range{display:flex;gap:4px}
.date-range button{padding:4px 8px;border:1px solid var(--border);background:var(--bg);border-radius:4px;cursor:pointer;font-size:12px;color:var(--text);}
.date-range button.active{background:var(--brand);color:#fff;border-color:var(--brand)}
.error-message{color:#c4302b;background:#ffebee;padding:8px;border-radius:6px;margin:8px 0;font-size:14px}
.success-message{color:#1db954;background:#e8f5e8;padding:8px;border-radius:6px;margin:8px 0;font-size:14px}
body.dark .error-message{background:#5c2427;color:#ff8a8a;}
body.dark .success-message{background:#2b542b;color:#a5d6a7;}

/* 채널 분석 관련 */
.analysis-page {
  display: flex;
  flex-direction: column;
  gap: 20px;
}
.analysis-header {
  display: flex;
  align-items: center;
  gap: 16px;
  background: var(--bg);
  padding: 16px;
  border-radius: 12px;
  box-shadow: var(--shadow);
}
.analysis-header .thumb {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  object-fit: cover;
}
.analysis-header h2 {
  margin: 0;
  font-size: 24px;
}
.analysis-header p {
  margin: 4px 0 0;
  color: var(--muted);
}
.analysis-content {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}
@media (max-width: 900px) {
  .analysis-content {
    grid-template-columns: 1fr;
  }
}
.analysis-card {
  background: var(--card);
  border-radius: 14px;
  box-shadow: var(--shadow);
  padding: 16px;
}
.analysis-card h3 {
  margin-top: 0;
  border-bottom: 1px solid var(--border);
  padding-bottom: 8px;
  margin-bottom: 12px;
}
.analysis-videos .video-list {
  max-height: 500px;
  overflow-y: auto;
}
.analysis-video-card {
  display: flex;
  gap: 12px;
  align-items: center;
  padding: 8px;
  border-bottom: 1px solid var(--border);
}
.analysis-video-card:last-child {
  border-bottom: none;
}
.analysis-video-card img {
  width: 90px;
  height: auto;
  object-fit: cover;
  border-radius: 8px;
}
.analysis-video-meta h4 {
  margin: 0 0 4px;
  font-size: 14px;
}
.analysis-video-meta p {
  margin: 0;
  font-size: 12px;
  color: var(--muted);
}
.analysis-charts .chart-container {
  height: 200px;
  width: 100%;
}
.analysis-charts .chart-label {
  text-align: center;
  font-weight: bold;
  margin-top: 8px;
}
.analysis-charts .chart-container {
  max-height: 200px;
}
</style>
</head>
<body class="light">
<div class="container">
  <h1>로이가 만든 유튜브 채널 모니터</h1>
  <div class="single-header">
    <button id="btn-analyze" class="analyze-btn">채널 분석</button>
    <div class="row">
      <button id="btn-api" class="api-btn">API 키 입력</button>
      <button id="btn-toggle-theme" class="toggle-btn">다크 모드</button>
    </div>
  </div>

  <div id="main-content" class="three-col">
    <section class="col" data-col="channels">
      <div class="col-head" draggable="true">
        <h2>채널 추가</h2>
        <div class="col-actions">
          <button id="btn-add-channel" class="btn">+ 채널 추가</button> <button id="btn-export-channels" class="btn">내보내기</button> <button id="btn-import-channels" class="btn">가져오기</button> <input type="file" id="file-import-channels" accept="application/json" style="display:none" />
          <span>등록: <span id="channel-count">0</span></span>
        </div>
      </div>
      <div class="sort-row">
        <label>정렬:
          <select id="sort-channels">
            <option value="subscribers" selected>구독자수</option>
            <option value="videos">영상갯수</option>
            <option value="latest">최근업로드</option>
          </select>
        </label>
      </div>
      <div id="channel-list" class="channel-list"><p class="muted">채널을 추가하세요.</p></div>
    </section>

    <section class="col" data-col="mutant">
      <div class="col-head" draggable="true">
        <h2>돌연변이 영상</h2>
        <div class="col-actions">
          <div class="date-range">
            <button data-period="1m">1개월</button>
            <button data-period="3m">3개월</button>
            <button class="active" data-period="6m">6개월</button>
            <button data-period="all">전체</button>
          </div>
        </div>
      </div>
      <div class="sort-row">
        <label>정렬:
          <select id="sort-mutant">
            <option value="mutantIndex" selected>돌연변이지수</option>
            <option value="views">조회수</option>
            <option value="subscribers">구독자수</option>
            <option value="latest">최근업로드</option>
          </select>
        </label>
      </div>
      <div id="mutant-keywords" class="keywords"></div>
      <div id="mutant-list" class="video-list"><p class="muted">채널을 추가하여 영상을 분석해주세요.</p></div>
    </section>

    <section class="col" data-col="latest">
      <div class="col-head" draggable="true"><h2>최신 영상</h2></div>
      <div class="sort-row">
        <label>정렬:
          <select id="sort-latest">
            <option value="views" selected>조회수</option>
            <option value="subscribers">구독자수</option>
            <option value="latest">최근업로드</option>
            <option value="mutantIndex">돌연변이지수</option>
          </select>
        </label>
      </div>
      <div id="latest-keywords" class="keywords"></div>
      <div id="latest-list" class="video-list"><p class="muted">채널을 추가하여 영상을 분석해주세요.</p></div>
    </section>
<section class="col" data-col="keywords">
  <div class="col-head" draggable="true"><h2>키워드 분석</h2></div>
  <div class="sort-row">
    <div class="tabs">
      <button id="tab-mutant" class="btn small" data-target="mutant">돌연변이 영상</button>
      <button id="tab-latest" class="btn small" data-target="latest">최신 영상</button>
    </div>
    <label style="margin-left:auto">표시 개수:
      <select id="kw-limit"><option>8</option><option selected>12</option><option>16</option><option>20</option></select>
    </label>
    <label style="margin-left:8px">필터:
      <select id="kw-mincount"><option value="1" selected>모두</option><option value="2">2회 이상</option></select>
    </label>
  </div>
  <div id="kw-badges" class="keywords"></div>
  <div class="table-wrap">
    <table class="table" id="kw-table">
      <thead><tr><th>키워드</th><th>포함영상수</th><th>평균 조회수</th><th>조회 속도</th><th>평균 돌연변이</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</section>

  </div>
</div>

<div id="modal-api" class="modal">
  <div class="content">
    <span class="close" data-close="modal-api">×</span>
    <h3>API 키 입력</h3>
    <p>최대 5개까지 저장하고 자동 순환 사용합니다.</p>
    <div id="api-inputs" class="api-inputs"></div>
    <div class="row" style="margin-top:8px">
      <input type="file" id="api-file" accept=".txt" style="display:none"/>
      <button id="api-file-btn" class="file-label" type="button">API 키 업로드(.txt)</button>
      <button id="api-save" class="btn" type="button">저장</button>
      <button id="api-download" class="btn" type="button">다운로드</button>
      <button id="api-test" class="btn" type="button">API 키 테스트</button>
    </div>
    <div id="api-test-result" class="small"></div>
  </div>
</div>

<div id="modal-add" class="modal">
  <div class="content">
    <span class="close" data-close="modal-add">×</span>
    <h3>채널 추가</h3>
    <div class="tabs">
      <button class="tab active" data-tab="tab-ch-search">채널명 검색</button>
      <button class="tab" data-tab="tab-vid-search">영상 검색(롱폼만)</button>
      <button class="tab" data-tab="tab-url-add">URL 직접 입력</button>
    </div>
    <div id="tab-ch-search" class="tabpanel active">
      <div class="row"><input id="ch-query" class="search-input" placeholder="채널명으로 검색"/><button id="btn-ch-search" class="btn">검색</button><span style="flex:1"></span><label style="font-size:12px">정렬: <select id="ch-sort"><option value="subs" selected>구독자순</option><option value="videos">영상수순</option><option value="latest">최신업로드순</option></select></label></div>
      <div id="ch-results" class="result-list"></div>
      <div id="ch-pagination" class="pagination"></div>
    </div>
    <div id="tab-vid-search" class="tabpanel">
      <div class="row"><input id="vid-query" class="search-input" placeholder="검색어 입력(롱폼만 표시)"/><button id="btn-vid-search" class="btn">검색</button></div>
      <div id="vid-results" class="result-list"></div>
      <div id="vid-pagination" class="pagination"></div>
    </div>
    <div id="tab-url-add" class="tabpanel">
      <div class="row">
        <input id="url-input" class="search-input" placeholder="채널 URL 또는 채널 ID 입력"/>
        <button id="btn-url-add" class="btn">추가</button>
      </div>
      <div id="url-result"></div>
    </div>
  </div>
</div>

<div id="modal-analyze" class="modal">
  <div class="content">
    <span class="close" data-close="modal-analyze">×</span>
    <h3>분석할 채널 선택</h3>
    <p class="muted">분석을 원하는 채널을 선택해주세요.</p>
    <div id="analyze-channel-list" class="result-list"></div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<script>
moment.tz.setDefault('Asia/Seoul');
const API='https://www.googleapis.com/youtube/v3/';
let currentMutantPeriod='6m';
let currentView = 'home'; // 'home' 또는 'analysis'

/* API 키 — youtubeApiKeys/apiKeys 호환 */
let apiKeys = JSON.parse(localStorage.getItem('youtubeApiKeys') || localStorage.getItem('apiKeys') || '[]');
if (!localStorage.getItem('youtubeApiKeys') && localStorage.getItem('apiKeys')) {
  localStorage.setItem('youtubeApiKeys', localStorage.getItem('apiKeys'));
}
let keyIdx=0;
function setApiKeys(keys){
  apiKeys = keys.filter(Boolean);
  keyIdx = 0;
  localStorage.setItem('youtubeApiKeys', JSON.stringify(apiKeys));
  localStorage.setItem('apiKeys', JSON.stringify(apiKeys));
}
function nextKey(){ if(apiKeys.length>1) keyIdx=(keyIdx+1)%apiKeys.length; }
function hasKeys(){ return apiKeys.length>0; }

/* IndexedDB */
let db=null;
function openDB(){ return new Promise((res,rej)=>{ if(db) return res(db); const r=indexedDB.open('myChannelDB',4); // 버전 4로 업데이트
  r.onupgradeneeded=e=>{ db=e.target.result;
    if(!db.objectStoreNames.contains('my_channels')) db.createObjectStore('my_channels',{keyPath:'id'});
    if(!db.objectStoreNames.contains('insights')) db.createObjectStore('insights',{keyPath:'channelId'});
    if(!db.objectStoreNames.contains('dailySubs')) db.createObjectStore('dailySubs',{keyPath:['channelId','date']});
    if(!db.objectStoreNames.contains('doneVideos')) db.createObjectStore('doneVideos',{keyPath:['channelId','videoId']}); // 새로운 저장소 추가
  };
  r.onsuccess=e=>{ db=e.target.result; res(db); };
  r.onerror=e=>rej(e);
});}
function idbAll(store){ return openDB().then(db=>new Promise((res,rej)=>{ const tx=db.transaction(store,'readonly'); const s=tx.objectStore(store); const q=s.getAll(); q.onsuccess=()=>res(q.result); q.onerror=()=>rej(q.error);})); }
function idbGet(store,key){ return openDB().then(db=>new Promise((res,rej)=>{ const tx=db.transaction(store,'readonly'); const s=tx.objectStore(store); const q=s.get(key); q.onsuccess=()=>res(q.result); q.onerror=()=>rej(q.error);})); }
function idbPut(store,obj){ return openDB().then(db=>new Promise((res,rej)=>{ try{ const tx=db.transaction(store,'readwrite'); const s=tx.objectStore(store); const q=s.put(obj); q.onsuccess=()=>res(); q.onerror=()=>rej(q.error); tx.onerror=()=>rej(tx.error);}catch(e){rej(e);} })); }
function idbDel(store,key){ return openDB().then(db=>new Promise((res,rej)=>{ const tx=db.transaction(store,'readwrite'); const s=tx.objectStore(store); const q=s.delete(key); q.onsuccess=()=>res(); q.onerror=()=>rej(q.error);})); }

/* 유틸 */
const qs=id=>document.getElementById(id);
const fmt=n=>{ const x=parseInt(n||'0',10); return isNaN(x)?'0':x.toLocaleString(); };
const seconds=iso=>moment.duration(iso).asSeconds();
const stopWords=new Set(['은','는','이','가','을','를','에','의','와','과','도','로','으로','the','a','an','of','to','in','on','for','and','or','but','with','about','into','에서','같은','뿐','위해','합니다','했다','하는','하기','진짜','무너졌다']);
function toast(msg,ms=1800){ const t=qs('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',ms); }
function showError(elementId, message){ qs(elementId).innerHTML = `<div class="error-message">${message}</div>`; }
function showSuccess(elementId, message){ qs(elementId).innerHTML = `<div class="success-message">${message}</div>`; }
function extractKeywords(text){
    const freq = new Map();
    if (!text) return [];
    text.replace(/[#"'.!?()/\-:;[\]{}|<>~^%$@*&+=]/g,' ').split(/\s+/).forEach(w=>{
      w=w.trim().toLowerCase(); const hasKo=/[가-힣]/.test(w);
      if(!w) return;
      if((hasKo && w.length<2) || (!hasKo && w.length<3)) return;
      if(stopWords.has(w)) return;
      freq.set(w, (freq.get(w)||0)+1);
    });
    return [...freq.entries()].sort((a,b)=>b[1]-a[1]);
}

/* API 호출(순환키+타임아웃) */
async function yt(endpoint,params,attempt=0){
  if(!apiKeys.length) throw new Error('API 키가 설정되지 않았습니다. API 키를 먼저 입력해주세요.');
  const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort('timeout'),30000);
  const p=new URLSearchParams(params); p.set('key',apiKeys[keyIdx]);
  const url=API+endpoint+'?'+p.toString();
  try{
    const r=await fetch(url,{signal:ctrl.signal}); const data=await r.json(); clearTimeout(t);
    if(data.error){
      if(data.error.code===403 && /quota/i.test(data.error.message||'')) throw new Error('API 할당량이 초과되었습니다.');
      if(attempt<apiKeys.length-1){ nextKey(); return yt(endpoint,params,attempt+1); }
      throw new Error(data.error.message||'API 오류');
    }
    return data;
  }catch(e){
    clearTimeout(t);
    if(attempt<apiKeys.length-1){ nextKey(); return yt(endpoint,params,attempt+1); }
    throw e;
  }
}


/* 채널 목록 내보내기/가져오기 */
async function exportChannels(){
  const list = await getAllChannels();
  // 최소 정보만 저장(다른 곳에서 다시 API로 최신 상태 동기화)
  const data = { version: 1, exportedAt: new Date().toISOString(), channels: list.map(c => ({ id: c.id, title: c.title })) };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'channels-export.json';
  document.body.appendChild(a);
  a.click();
  URL.revokeObjectURL(url);
  a.remove();
  toast('채널 목록을 다운로드했습니다.');
}

async function importChannelsFromFile(file){
  try{
    const txt = await file.text();
    const parsed = JSON.parse(txt);
    // 허용 포맷: {channels:[{id,...}]}, [{id,...}], ["channelId", ...]
    let ids = [];
    if(Array.isArray(parsed)){
      ids = parsed.map(x => (typeof x === 'string' ? x : x.id)).filter(Boolean);
    }else if(parsed && Array.isArray(parsed.channels)){
      ids = parsed.channels.map(x => (typeof x === 'string' ? x : x.id)).filter(Boolean);
    }else{
      // 객체의 값들 중 id 추출
      ids = Object.values(parsed).map(x => (typeof x === 'string' ? x : x.id)).filter(Boolean);
    }
    ids = Array.from(new Set(ids)); // 중복 제거
    if(!ids.length){ toast('가져올 채널 ID가 없습니다.'); return; }

    const exist = await getAllChannels();
    const existIds = new Set(exist.map(c=>c.id));
    const toAdd = ids.filter(id => !existIds.has(id));

    let ok=0, fail=0;
    for(const id of toAdd){
      try{
        await addChannelById(id);
        ok++;
      }catch(e){
        console.error('채널 추가 실패', id, e);
        fail++;
      }
    }
    toast(`가져오기 완료: ${ok}개 추가${fail?`, 실패 ${fail}개`:''} (중복 제외)`);
    refreshAll('channels');
  }catch(e){
    console.error(e);
    toast('가져오는 중 오류가 발생했습니다.');
  }
}
/* 채널 */
async function getAllChannels(){ return idbAll('my_channels'); }
async function deleteChannel(id){ await idbDel('my_channels',id); await idbDel('insights',id); }
function sortChannels(list,mode){
  if(mode==='videos') list.sort((a,b)=>parseInt(b.videoCount||'0')-parseInt(a.videoCount||'0'));
  else if(mode==='latest') list.sort((a,b)=>new Date(b.latestUploadDate||0)-new Date(a.latestUploadDate||0));
  else list.sort((a,b)=>parseInt(b.subscriberCount||'0')-parseInt(a.subscriberCount||'0'));
}
async function ensureUploadsAndLatest(ch){
  if(ch.uploadsPlaylistId && ch.latestUploadDate) return ch;
  const info=await yt('channels',{part:'contentDetails',id:ch.id});
  ch.uploadsPlaylistId=info.items?.[0]?.contentDetails?.relatedPlaylists?.uploads||'';
  if(ch.uploadsPlaylistId){
    const pl=await yt('playlistItems',{part:'snippet',playlistId:ch.uploadsPlaylistId,maxResults:1});
    if(pl.items && pl.items[0]) ch.latestUploadDate=pl.items[0].snippet.publishedAt;
  }
  await idbPut('my_channels',ch); return ch;
}

async function ensureFirstUploadDate(ch){
  if (ch.firstUploadDate) return ch;
  try{
    if (!ch.uploadsPlaylistId){ await ensureUploadsAndLatest(ch); }
    if (!ch.uploadsPlaylistId) return ch;
    let next=null, oldest=null;
    while(true){
      const pl=await yt('playlistItems',{part:'snippet',playlistId:ch.uploadsPlaylistId,maxResults:50,pageToken:next||''});
      const items=pl.items||[];
      for(const it of items){
        const d=it?.snippet?.publishedAt;
        if(d && (!oldest || new Date(d) < new Date(oldest))) oldest=d;
      }
      next=pl.nextPageToken;
      if(!next || !items.length) break;
    }
    if(oldest){ ch.firstUploadDate=oldest; await idbPut('my_channels', ch); }
  }catch(e){ console.warn('firstUploadDate 계산 실패', e); }
  return ch;
}

async function getYesterdaySubCount(ch){
  const y=moment().subtract(1,'day').format('YYYY-MM-DD');
  const rec=await idbGet('dailySubs',[ch.id,y]); return rec? rec.subCount:null;
}
async function updateDailySubSnapshot(ch){
  const today=moment().format('YYYY-MM-DD');
  const ex=await idbGet('dailySubs',[ch.id,today]);
  if(!ex) await idbPut('dailySubs',{channelId:ch.id,date:today,subCount:parseInt(ch.subscriberCount||'0',10)});
}

/* 채널 등록 */
async function addChannelById(channelId){
  if(!channelId){ toast('올바른 채널 ID가 아닙니다.'); return false; }
  const exist=await idbGet('my_channels',channelId); if(exist){ toast('이미 등록된 채널입니다.'); return false; }
  const ch=await yt('channels',{part:'snippet,statistics,contentDetails',id:channelId});
  const it=ch.items?.[0]; if(!it) throw new Error('채널을 찾을 수 없습니다.');
  const uploads=it.contentDetails?.relatedPlaylists?.uploads||''; let latest=it.snippet.publishedAt; const country=it.snippet.country||'-';
  if(uploads){ try{ const pl=await yt('playlistItems',{part:'snippet',playlistId:uploads,maxResults:1}); if(pl.items && pl.items[0]) latest=pl.items[0].snippet.publishedAt||latest; }catch{} }
  const data={ id:it.id,title:it.snippet.title,thumbnail:it.snippet.thumbnails?.default?.url||'',subscriberCount:it.statistics.subscriberCount||'0',videoCount:it.statistics.videoCount||'0',uploadsPlaylistId:uploads,latestUploadDate:latest,country };
  await idbPut('my_channels',data);
toast(`✅ ${data.title} 채널이 등록되었습니다.`);
setTimeout(async ()=>{ const saved=await idbGet('my_channels', data.id); await ensureFirstUploadDate(saved); refreshAll('channels'); },50);
return true;
}

/* 채널 렌더(2단 구조, 링크 이동 + 삭제만 표시) */
async function refreshChannels(){
  const list=await getAllChannels();
  for (const ch of list){ await ensureUploadsAndLatest(ch); await ensureFirstUploadDate(ch); await updateDailySubSnapshot(ch); }
  sortChannels(list,qs('sort-channels').value);
  qs('channel-count').textContent=list.length;
  const wrap=qs('channel-list');
  if(!list.length){ wrap.innerHTML='<p class="muted">채널을 추가하세요.</p>'; return; }
  wrap.innerHTML='';
  for(const ch of list){
    const y=await getYesterdaySubCount(ch);
    const today=parseInt(ch.subscriberCount||'0',10);
    const diff=y==null? null : today-y;
    const diffStr=y==null? '<span class="v" style="color:#888">(전일 정보 없음)</span>'
      : diff>0? `<span class="v" style="color:#1db954">+${fmt(diff)}</span>`
      : diff<0? `<span class="v" style="color:#c4302b">${fmt(diff)}</span>`
      : `<span class="v" style="color:#888">0</span>`;
    const el=document.createElement('div');
    el.className='channel-card';
    el.innerHTML=`
      <a class="channel-thumb-link" href="https://www.youtube.com/channel/${ch.id}" target="_blank" rel="noopener">
        <img class="channel-thumb" src="${ch.thumbnail||''}" alt="${ch.title}">
      </a>
      <div class="channel-meta">
        <h3><a class="channel-title-link" href="https://www.youtube.com/channel/${ch.id}" target="_blank" rel="noopener">${ch.title}</a></h3>
        <div class="row">
          <span>구독자: <strong>${fmt(today)}</strong></span>
          <span>영상: <strong>${fmt(ch.videoCount)}</strong></span>
          <span>운영기간: <strong>${ch.firstUploadDate? moment().diff(moment(ch.firstUploadDate),'years')+'년 '+(moment().diff(moment(ch.firstUploadDate),'months')%12)+'개월':'-'}</strong></span>
        </div>
        <div class="latest">최신 업로드: ${ch.latestUploadDate? moment(ch.latestUploadDate).format('YYYY-MM-DD'):'-'} · 최초 업로드: ${ch.firstUploadDate? moment(ch.firstUploadDate).format('YYYY-MM-DD'):'-'}</div>
      </div>
      <div class="channel-actions">
        <button class="btn-danger" data-del="${ch.id}">삭제</button>
      </div>
      <div class="channel-insights">
        <div class="insights" id="ins-${ch.id}">
          <div><span class="k">전일대비</span> <span class="v">${diffStr}</span></div>
          <div><span class="k">평균조회</span> <span class="v">-</span></div>
          <div><span class="k">좋아요율</span> <span class="v">-</span></div>
          <div><span class="k">업로드빈도</span> <span class="v">-</span></div>
          <div><span class="k">평균길이</span> <span class="v">-</span></div>
          <div><span class="k">롱/숏</span> <span class="v">-</span></div>
          <div><span class="k">국가</span> <span class="v">${ch.country||'-'}</span></div>
          <div><span class="k">최다요일</span> <span class="v">-</span></div>
          <div style="grid-column:1/-1"><span class="k">카테고리</span> <span class="v">-</span></div>
        </div>
      </div>
    `;
    el.querySelector('[data-del]').onclick=async()=>{
      if(confirm('채널을 삭제할까요?')){
        await deleteChannel(ch.id);
        refreshAll('channels');
      }
    };
    wrap.appendChild(el);
    // 통계(인사이트) 업데이트
    updateChannelInsights(ch.id);
  }
}

/* 영상 리스트/키워드 분석(클라이언트 강화판) */
function renderVideoList(videos,listId,kwId){
  const wrap=qs(listId);
  if(!videos.length){
    if(wrap) wrap.innerHTML='<p class="muted">표시할 영상이 없습니다.</p>';
    if(kwId){ const k=qs(kwId); if(k) k.innerHTML=''; }
    return;
  }
  if(wrap) wrap.innerHTML='';
  videos.forEach(v=>{
    const card=document.createElement('div');
    card.className='video-card';
    const chTitle = v.__ch?.title || v.snippet?.channelTitle || '';
    const chId = v.__ch?.channelId || v.snippet?.channelId || '';
    const subs = v.__ch?.subscriberCount || 0;
    const views = v.viewCount || 0;
    const published = v.publishedAt;
    const mi = (v.mutantIndex!=null && v.mutantIndex!=='') ? String(v.mutantIndex) : '';
    card.innerHTML = `
      <a class="video-link" target="_blank" href="https://www.youtube.com/watch?v=${v.id}" aria-label="영상 열기: ${v.title}">
        <div class="thumb-wrap"><img class="thumb" src="${v.thumbnail}" alt=""></div>
        <div class="v-title">${v.title}</div>
        <div class="v-lines">
          <div class="v-line">
            <span class="ell" title="${chTitle}" aria-label="채널명 ${chTitle}">${chTitle}</span>
            <span>구독자: ${fmt(subs)}</span>
            <span>조회수: ${fmt(views)}</span>
          </div>
        </div>
      </a>
      <div class="v-lines">
        <div class="v-line between">
          <span>업로드: ${moment(published).format('YYYY-MM-DD')}</span>
          <label class="right"><input type="checkbox" data-done="${v.id}"/> 영상제작완료</label>
        </div>
        ${mi ? `<div class="v-line center"><div class="badge" title="돌연변이지수 ${mi}" aria-label="돌연변이지수 ${mi}"></div></div>` : ''}
      </div>
    `;
    // 체크박스 상태 복원
    idbGet('doneVideos', [chId, v.id]).then(row=>{
      if(row && row.done){
        const cb = card.querySelector(`[data-done='${v.id}']`);
        if(cb) cb.checked = true;
      }
    });

    // 체크박스 상태 저장/삭제
    card.addEventListener('change', async (e)=>{
      const t = e.target;
      if(!t || !t.matches(`[data-done='${v.id}']`)) return;
      if(t.checked){
        await idbPut('doneVideos',{channelId: chId, videoId: v.id, done:true, ts:Date.now()});
      }else{
        await idbDel('doneVideos',[chId, v.id]);
      }
    });
    if(wrap) wrap.appendChild(card);
  });
  if(kwId){
    const k=qs(kwId);
    if(k) k.innerHTML='';
  }
}

function sortVideoCards(list,mode){
  if(mode==='views') list.sort((a,b)=>b.viewCount-a.viewCount);
  else if(mode==='subscribers') list.sort((a,b)=>b.__ch.subscriberCount-a.__ch.subscriberCount);
  else if(mode==='latest') list.sort((a,b)=>new Date(b.publishedAt)-new Date(a.publishedAt));
  else list.sort((a,b)=>parseFloat(b.mutantIndex||0)-parseFloat(a.mutantIndex||0));
}

/* 돌연변이 */
async function refreshMutant(){
  const channels=await getAllChannels();
  let list=[];
  let minDate=null;
  if(currentMutantPeriod!=='all'){
    const n=currentMutantPeriod==='1m'?1:currentMutantPeriod==='3m'?3:6;
    minDate=moment().subtract(n,'months');
  }
  for(const ch of channels){
    await ensureUploadsAndLatest(ch);
    if(!ch.uploadsPlaylistId) continue;
    let ids=[], next=null, stop=false;
    while(!stop){
      const pl=await yt('playlistItems',{part:'snippet,contentDetails',playlistId:ch.uploadsPlaylistId,maxResults:50,pageToken:next||''});
      const items=pl.items||[];
      const filtered=minDate? items.filter(i=>moment(i.snippet.publishedAt).isAfter(minDate)):items;
      ids.push(...filtered.map(i=>i.contentDetails.videoId));
      next=pl.nextPageToken;
      if(!next || !items.length || (minDate && items.some(i=>moment(i.snippet.publishedAt).isBefore(minDate)))) stop=true;
    }
    if(ids.length){
      const vids=await yt('videos',{part:'snippet,statistics,contentDetails',id:ids.join(',')});
      for(const v of vids.items||[]){
        v.publishedAt=v.snippet.publishedAt;
        v.viewCount=parseInt(v.statistics.viewCount||0,10);
        v.likeCount=parseInt(v.statistics.likeCount||0,10);
        v.commentCount=parseInt(v.statistics.commentCount||0,10);
        v.durationSec=seconds(v.contentDetails.duration);
        v.title=v.snippet.title;
        v.thumbnail=v.snippet.thumbnails.medium.url;
        const days=moment().diff(moment(v.publishedAt),'days') || 1;
        v.velocity=v.viewCount/days;
        const subPerView=v.viewCount/(parseInt(ch.subscriberCount||0,10) || 1);
        v.mutantIndex=(v.viewCount > 100000 && subPerView > 10) ? (v.velocity * subPerView).toFixed(2) : '';
        v.__ch=ch;
        list.push(v);
      }
    }
  }
  sortVideoCards(list,qs('sort-mutant').value);
  renderVideoList(list,'mutant-list');
  renderKeywords(list,'mutant');
}

/* 최신 */
async function refreshLatest(){
  const channels=await getAllChannels();
  let list=[];
  for(const ch of channels){
    await ensureUploadsAndLatest(ch);
    if(!ch.uploadsPlaylistId) continue;
    const pl=await yt('playlistItems',{part:'snippet,contentDetails',playlistId:ch.uploadsPlaylistId,maxResults:50});
    const ids=pl.items?.map(i=>i.contentDetails.videoId)||[];
    if(ids.length){
      const vids=await yt('videos',{part:'snippet,statistics,contentDetails',id:ids.join(',')});
      for(const v of vids.items||[]){
        v.publishedAt=v.snippet.publishedAt;
        v.viewCount=parseInt(v.statistics.viewCount||0,10);
        v.likeCount=parseInt(v.statistics.likeCount||0,10);
        v.commentCount=parseInt(v.statistics.commentCount||0,10);
        v.durationSec=seconds(v.contentDetails.duration);
        v.title=v.snippet.title;
        v.thumbnail=v.snippet.thumbnails.medium.url;
        const days=moment().diff(moment(v.publishedAt),'days')||1;
        v.velocity=v.viewCount/days;
        const subPerView=v.viewCount/(parseInt(ch.subscriberCount||0,10) || 1);
        v.mutantIndex=(v.viewCount > 100000 && subPerView > 10) ? (v.velocity * subPerView).toFixed(2) : '';
        v.__ch=ch;
        list.push(v);
      }
    }
  }
  sortVideoCards(list,qs('sort-latest').value);
  renderVideoList(list,'latest-list');
  renderKeywords(list,'latest');
}

/* 키워드 분석 */
let videoData = { mutant: [], latest: [] };
async function renderKeywords(list,type){
  if(type==='mutant') videoData.mutant = list;
  if(type==='latest') videoData.latest = list;
  renderKeywordAnalysis();
}
async function renderKeywordAnalysis(){
  const tab = document.querySelector('.tabs .active');
  const type = tab ? tab.dataset.target : 'mutant';
  const videos = videoData[type];
  const kwLimit = parseInt(qs('kw-limit').value);
  const kwMinCount = parseInt(qs('kw-mincount').value);
  const keywordMap = new Map();
  videos.forEach(v=>{
    const kws = [...extractKeywords(v.title),...extractKeywords(v.snippet.description)];
    const uniqueKws = new Set(kws.map(k=>k[0]));
    uniqueKws.forEach(k=>{
      if(!keywordMap.has(k)) keywordMap.set(k,{count:0,views:0,velocity:0,mutantIndex:0,videos:[]});
      const data=keywordMap.get(k);
      data.count++;
      data.views+=v.viewCount;
      data.velocity+=v.velocity;
      data.mutantIndex+=(parseFloat(v.mutantIndex) || 0);
      data.videos.push(v);
    });
  });
  const rows = [...keywordMap.entries()]
    .filter(e=>e[1].count>=kwMinCount)
    .map(([k,v])=>({
      keyword:k,
      count:v.count,
      avgViews:Math.round(v.views/v.count),
      avgVelocity:Math.round(v.velocity/v.count),
      avgMutant:v.mutantIndex>0? (v.mutantIndex/v.count).toFixed(2) : '-'
    }));
  rows.sort((a,b)=>b.count-a.count || b.avgViews-a.avgViews || b.avgMutant-a.avgMutant || (a.keyword>b.keyword?1:-1));
  const top = rows.slice(0, kwLimit);
  const bEl = document.getElementById('kw-badges');
  const tBody = document.querySelector('#kw-table tbody');
  if (bEl) bEl.innerHTML = top.length
    ? top.map(r=>`<span class="kw" data-k="${r.keyword}" title="포함 ${r.count} · 평균조회 ${r.avgViews.toLocaleString()} · 평균지수 ${r.avgMutant}">${r.keyword} ${r.count}회</span>`).join('')
    : '<p class="muted">키워드를 계산할 영상이 없습니다.</p>';
  if (tBody) tBody.innerHTML = top.map(r=>`<tr><td>${r.keyword}</td><td>${r.count}</td><td>${r.avgViews.toLocaleString()}</td><td>${r.avgVelocity.toLocaleString()}/일</td><td>${r.avgMutant}</td></tr>`).join('');
}
function initKeywordAnalysis(){
  const t1 = document.getElementById('tab-mutant');
  const t2 = document.getElementById('tab-latest');
  function activate(btn){ [t1,t2].forEach(b=>b && b.classList.remove('active')); btn.classList.add('active'); renderKeywordAnalysis(); }
  if (t1 && t2){
    t1.onclick = ()=>activate(t1);
    t2.onclick = ()=>activate(t2);
    t1.classList.add('active');
  }
  const kwLimit = qs('kw-limit');
  const kwMinCount = qs('kw-mincount');
  if(kwLimit) kwLimit.onchange = renderKeywordAnalysis;
  if(kwMinCount) kwMinCount.onchange = renderKeywordAnalysis;
}

/* 채널 인사이트 업데이트 */
async function updateChannelInsights(channelId){
  const insightsEl = qs(`ins-${channelId}`);
  if(!insightsEl) return;
  const channel = await idbGet('my_channels', channelId);
  const cacheKey = `insight-${channelId}`;
  let data = await idbGet('insights', cacheKey);
  const now = Date.now();
  const CACHE_LIFETIME = 24 * 60 * 60 * 1000; // 24시간
  if(data && (now - data.timestamp) < CACHE_LIFETIME){
    renderInsights(insightsEl, data.data, channel);
    return;
  }
  // 캐시 없으면 계산 시작
  try{
    const videos = await fetchAllVideos(channel);
    const avgViews = videos.reduce((acc,v)=>acc+(parseInt(v.statistics.viewCount||0,10)),0) / (videos.length||1);
    const likeRate = videos.reduce((acc,v)=>acc+(parseInt(v.statistics.likeCount||0,10)/(parseInt(v.statistics.viewCount||0,10)||1)),0) / (videos.length||1);
    const uploadFreqs = videos.map(v=>moment(v.snippet.publishedAt)).sort((a,b)=>a-b).map((d,i,arr)=>i>0? d.diff(arr[i-1],'days'):null).filter(d=>d!==null);
    const avgUploadFreq = uploadFreqs.length? (uploadFreqs.reduce((a,b)=>a+b,0)/uploadFreqs.length).toFixed(1):'-';
    const avgDuration = videos.reduce((acc,v)=>acc+seconds(v.contentDetails.duration),0) / (videos.length||1);
    const durationFmt = avgDuration > 0 ? moment.utc(avgDuration*1000).format('HH:mm:ss'):'-';
    const longFormCount = videos.filter(v=>seconds(v.contentDetails.duration)>60).length;
    const shortsCount = videos.filter(v=>seconds(v.contentDetails.duration)<=60).length;
    const uploadDays = videos.map(v=>moment(v.snippet.publishedAt).day());
    const dayCounts = uploadDays.reduce((acc,d)=>{ acc[d]=(acc[d]||0)+1; return acc; },[]);
    const maxDay = dayCounts.indexOf(Math.max(...dayCounts));
    const dayNames=['일','월','화','수','목','금','토'];
    const mostUploadDay = maxDay > -1 ? dayNames[maxDay] : '-';
    const categories = [...new Set(videos.map(v=>v.snippet.categoryId))];
    const categoryNames = (await fetchCategoryNames(categories)).join(', ');
    const result={avgViews,likeRate,avgUploadFreq,durationFmt,longFormCount,shortsCount,mostUploadDay,categoryNames};
    await idbPut('insights',{channelId:cacheKey,data:result,timestamp:now});
    renderInsights(insightsEl,result,channel);
  }catch(e){
    console.error('인사이트 업데이트 실패', e);
  }
}
async function fetchAllVideos(channel){
  let videos=[]; let next=null;
  while(true){
    const pl=await yt('playlistItems',{part:'snippet,contentDetails',playlistId:channel.uploadsPlaylistId,maxResults:50,pageToken:next||''});
    const ids=pl.items?.map(i=>i.contentDetails.videoId)||[];
    if(!ids.length) break;
    const vids=await yt('videos',{part:'snippet,statistics,contentDetails',id:ids.join(',')});
    videos.push(...vids.items);
    next=pl.nextPageToken;
    if(!next) break;
  }
  return videos;
}
let categoryCache = {};
async function fetchCategoryNames(ids){
  const newIds = ids.filter(id => !categoryCache[id]);
  if(!newIds.length) return ids.map(id=>categoryCache[id]);
  const data = await yt('videoCategories',{part:'snippet',regionCode:'KR',id:newIds.join(',')});
  data.items?.forEach(cat=>{ categoryCache[cat.id]=cat.snippet.title; });
  return ids.map(id=>categoryCache[id]||'알 수 없음');
}
function renderInsights(el,data,channel){
  const y = getYesterdaySubCount(channel);
  const today = parseInt(channel.subscriberCount||'0',10);
  const diff=y==null? null : today-y;
  const diffStr=y==null? '<span class="v" style="color:#888">(전일 정보 없음)</span>'
      : diff>0? `<span class="v" style="color:#1db954">+${fmt(diff)}</span>`
      : diff<0? `<span class="v" style="color:#c4302b">${fmt(diff)}</span>`
      : `<span class="v" style="color:#888">0</span>`;
  el.innerHTML=`
    <div><span class="k">전일대비</span> <span class="v">${diffStr}</span></div>
    <div><span class="k">평균조회</span> <span class="v">${fmt(data.avgViews)}</span></div>
    <div><span class="k">좋아요율</span> <span class="v">${(data.likeRate*100).toFixed(2)}%</span></div>
    <div><span class="k">업로드빈도</span> <span class="v">${data.avgUploadFreq}일</span></div>
    <div><span class="k">평균길이</span> <span class="v">${data.durationFmt}</span></div>
    <div><span class="k">롱/숏</span> <span class="v">${data.longFormCount}/${data.shortsCount}</span></div>
    <div><span class="k">국가</span> <span class="v">${channel.country||'-'}</span></div>
    <div><span class="k">최다요일</span> <span class="v">${data.mostUploadDay}</span></div>
    <div style="grid-column:1/-1"><span class="k">카테고리</span> <span class="v">${data.categoryNames}</span></div>
  `;
}

/* 채널 분석 페이지 */
async function analyzeChannel(channelId){
  const main = qs('main-content');
  const ch = await idbGet('my_channels', channelId);
  main.style.display = 'none';
  qs('btn-analyze').style.display = 'none';
  let page = document.getElementById('analysis-page');
  if(!page){
    page = document.createElement('div');
    page.id = 'analysis-page';
    page.className = 'analysis-page';
    document.querySelector('.container').appendChild(page);
    page.innerHTML = `
      <div class="analysis-header">
        <img class="thumb" src="" alt="">
        <div>
          <h2 id="analysis-channel-title"></h2>
          <p>구독자: <span id="analysis-subscribers"></span> · 영상: <span id="analysis-videos-count"></span></p>
        </div>
      </div>
      <div class="analysis-content">
        <div class="analysis-card">
          <h3>일별 구독자 변화</h3>
          <div class="chart-container"><canvas id="daily-subs-chart"></canvas></div>
        </div>
        <div class="analysis-card">
          <h3>최신 영상 트렌드</h3>
          <div class="analysis-videos">
            <div id="analysis-videos-list" class="video-list"></div>
          </div>
        </div>
        <div class="analysis-card" style="grid-column:1/-1">
          <h3>평균 조회수, 좋아요, 댓글</h3>
          <div class="chart-container"><canvas id="video-stats-chart"></canvas></div>
        </div>
      </div>
    `;
  }
  qs('analysis-channel-title').textContent = ch.title;
  qs('analysis-subscribers').textContent = fmt(ch.subscriberCount);
  qs('analysis-videos-count').textContent = fmt(ch.videoCount);
  page.querySelector('.thumb').src = ch.thumbnail;
  page.style.display = 'flex';
  currentView = 'analysis';

  // 차트 데이터 로딩
  const videos = await fetchAllVideos(ch);
  const sortedVideos = videos.sort((a,b)=>new Date(b.snippet.publishedAt) - new Date(a.snippet.publishedAt)).slice(0,50);
  renderAnalysisVideos(sortedVideos);

  const dailySubs = await idbAll('dailySubs');
  const filteredSubs = dailySubs.filter(s=>s.channelId===ch.id).sort((a,b)=>moment(a.date).diff(moment(b.date))).map(s=>({date:s.date, count:s.subCount}));
  renderDailySubsChart(filteredSubs);
  renderVideoStatsChart(sortedVideos);
}
function renderAnalysisVideos(videos){
  const listEl = qs('analysis-videos-list');
  listEl.innerHTML = '';
  videos.forEach(v=>{
    const card = document.createElement('div');
    card.className = 'analysis-video-card';
    card.innerHTML = `
      <img src="${v.snippet.thumbnails.medium.url}" alt="">
      <div class="analysis-video-meta">
        <h4><a href="https://www.youtube.com/watch?v=${v.id}" target="_blank">${v.snippet.title}</a></h4>
        <p>조회수: ${fmt(v.statistics.viewCount)} · 좋아요: ${fmt(v.statistics.likeCount)} · 댓글: ${fmt(v.statistics.commentCount)}</p>
      </div>
    `;
    listEl.appendChild(card);
  });
}
function renderDailySubsChart(data){
  const ctx = qs('daily-subs-chart');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.map(d=>d.date),
      datasets: [{
        label: '구독자 수',
        data: data.map(d=>d.count),
        borderColor: 'rgb(75, 192, 192)',
        tension: 0.1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: { beginAtZero: false, ticks: { callback: v => fmt(v) } }
      }
    }
  });
}
function renderVideoStatsChart(videos){
  const ctx = qs('video-stats-chart');
  const labels = videos.map(v=>moment(v.snippet.publishedAt).format('MM-DD'));
  const views = videos.map(v=>parseInt(v.statistics.viewCount||0));
  const likes = videos.map(v=>parseInt(v.statistics.likeCount||0));
  const comments = videos.map(v=>parseInt(v.statistics.commentCount||0));
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: '조회수',
        data: views,
        backgroundColor: 'rgba(255, 99, 132, 0.5)'
      },{
        label: '좋아요',
        data: likes,
        backgroundColor: 'rgba(54, 162, 235, 0.5)'
      },{
        label: '댓글',
        data: comments,
        backgroundColor: 'rgba(255, 206, 86, 0.5)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: { beginAtZero: true, ticks: { callback: v=>fmt(v) } }
      }
    }
  });
}
function hideAnalysisPage(){
  const page = qs('analysis-page');
  if(page) page.style.display = 'none';
  qs('main-content').style.display = 'grid';
  qs('btn-analyze').style.display = 'inline-block';
  currentView = 'home';
}
document.addEventListener('DOMContentLoaded',()=>{
  // 드래그앤드롭
  new Sortable(qs('main-content'),{animation:150,draggable:'.col',handle:'.col-head',onEnd:e=>{
    const order=Array.from(qs('main-content').children).map(el=>el.dataset.col);
    localStorage.setItem('columnOrder',JSON.stringify(order));
  }});
  const savedOrder=JSON.parse(localStorage.getItem('columnOrder')||'[]');
  if(savedOrder.length){
    const main=qs('main-content');
    savedOrder.forEach(id=>{
      const el=document.querySelector(`.col[data-col="${id}"]`);
      if(el) main.appendChild(el);
    });
  }

  // 모달
  document.querySelectorAll('.modal .close').forEach(b=>b.onclick=()=>qs(b.dataset.close).style.display='none');
  qs('btn-api').onclick=()=>qs('modal-api').style.display='flex';
  qs('btn-add-channel').onclick=()=>qs('modal-add').style.display='flex';
  qs('btn-analyze').onclick=async()=>{
    const list=await getAllChannels();
    const wrap=qs('analyze-channel-list');
    if(!list.length){
      wrap.innerHTML='<p class="muted">먼저 채널을 추가하세요.</p>';
      return;
    }
    wrap.innerHTML='';
    list.forEach(ch=>{
      const el=document.createElement('div');
      el.className='result-row';
      el.innerHTML=`
        <img class="r-avatar" src="${ch.thumbnail}" alt="">
        <div><div class="r-title">${ch.title}</div><div class="r-sub">구독자: ${fmt(ch.subscriberCount)}</div></div>
        <button class="btn" data-id="${ch.id}">분석하기</button>
      `;
      el.querySelector('button').onclick=()=>analyzeChannel(ch.id);
      wrap.appendChild(el);
    });
    qs('modal-analyze').style.display='flex';
  };

  // API
  function renderApiKeys(){
    const wrap=qs('api-inputs');
    wrap.innerHTML='';
    [...apiKeys,'','','',''].slice(0,5).forEach((k,i)=>{
      const inp=document.createElement('input');
      inp.className='api-inp';
      inp.type='password';
      inp.placeholder=`API 키 ${i+1}`;
      inp.value=k||'';
      inp.dataset.index=i;
      wrap.appendChild(inp);
    });
  }
  renderApiKeys();
  qs('api-save').onclick=()=>{
    const keys=Array.from(qs('api-inputs').children).map(inp=>inp.value.trim()).filter(Boolean);
    setApiKeys(keys);
    qs('modal-api').style.display='none';
    toast('API 키가 저장되었습니다.');
  };
  qs('api-test').onclick=async()=>{
    const res=qs('api-test-result'); res.textContent='';
    if(!hasKeys()){ showError('api-test-result','API 키가 없습니다.'); return; }
    try{
      const r=await yt('channels',{part:'id',id:'UC-mO3-gA_s8y2r6_6I4-g3A'}); // Google Developers
      if(r.items && r.items[0]){
        showSuccess('api-test-result','✅ API 키가 정상적으로 작동합니다.');
      }else throw new Error('API 호출은 성공했으나 응답이 올바르지 않습니다.');
    }catch(e){
      showError('api-test-result',`❌ API 테스트 실패: ${e.message}`);
    }
  };
  qs('api-file-btn').onclick=()=>qs('api-file').click();
  qs('api-file').onchange=e=>{
    const file=e.target.files[0];
    if(!file) return;
    const reader=new FileReader();
    reader.onload=e=>{
      const keys=e.target.result.split('\n').map(l=>l.trim()).filter(Boolean);
      setApiKeys(keys);
      renderApiKeys();
      toast('API 키 파일 업로드 완료.');
    };
    reader.readAsText(file);
  };
  qs('api-download').onclick=()=>{
    const content = apiKeys.join('\n');
    const blob = new Blob([content], {type: 'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'api_keys.txt';
    document.body.appendChild(a);
    a.click();
    URL.revokeObjectURL(url);
    a.remove();
  };
  qs('btn-import-channels').onclick=()=>qs('file-import-channels').click();
  qs('file-import-channels').onchange=e=>importChannelsFromFile(e.target.files[0]);
  qs('btn-export-channels').onclick=exportChannels;

  // 채널 추가
  const search=async (endpoint,query,page,sort,listId,paginationId,type)=>{
    if(!hasKeys()){ toast('API 키를 먼저 입력해주세요.'); return; }
    if(!query){ toast('검색어를 입력해주세요.'); return; }
    let params={part:'snippet',q:query,maxResults:10,type:type,pageToken:page};
    if(endpoint==='search'){
      params.order=sort==='subs'?'relevance':sort==='videos'?'videoCount':'date';
    }else if(endpoint==='videos'){
      params.order='relevance'; params.videoDuration='long';
    }
    const data=await yt('search',params);
    const wrap=qs(listId); wrap.innerHTML='';
    if(!data.items?.length){ wrap.innerHTML='<p class="muted">검색 결과가 없습니다.</p>'; return; }
    data.items.forEach(item=>{
      const id=item.id.channelId||item.snippet.channelId;
      if(!id) return;
      const el=document.createElement('div');
      el.className='result-row';
      el.innerHTML=`
        <img class="${type==='channel'?'r-avatar':'r-thumb'}" src="${item.snippet.thumbnails.default.url}" alt="">
        <div><div class="r-title">${item.snippet.title}</div><div class="r-sub">${item.snippet.channelTitle||item.snippet.description}</div></div>
        <button class="btn" data-id="${id}">추가</button>
      `;
      el.querySelector('button').onclick=async()=>{
        try{
          await addChannelById(id);
          el.remove();
          qs('modal-add').style.display='none';
        }catch(e){
          toast('채널 추가 실패: '+e.message);
        }
      };
      wrap.appendChild(el);
    });
    const pag=qs(paginationId); pag.innerHTML='';
    if(data.prevPageToken) pag.innerHTML+='<button data-page="'+data.prevPageToken+'">이전</button>';
    if(data.nextPageToken) pag.innerHTML+='<button data-page="'+data.nextPageToken+'">다음</button>';
    pag.querySelectorAll('button').forEach(b=>b.onclick=()=>search(endpoint,query,b.dataset.page,sort,listId,paginationId,type));
  };
  qs('btn-ch-search').onclick=()=>search('search',qs('ch-query').value,null,qs('ch-sort').value,'ch-results','ch-pagination','channel');
  qs('ch-sort').onchange=()=>search('search',qs('ch-query').value,null,qs('ch-sort').value,'ch-results','ch-pagination','channel');
  qs('btn-vid-search').onclick=()=>search('search',qs('vid-query').value,null,null,'vid-results','vid-pagination','video');
  qs('btn-url-add').onclick=async()=>{
    const url=qs('url-input').value.trim();
    if(!url){ toast('URL 또는 ID를 입력해주세요.'); return; }
    const match=url.match(/(?:youtube\.com\/(?:channel|c|user)\/|youtu\.be\/|v=)([a-zA-Z0-9_-]{12,})/i);
    let id=match?.[1];
    if(url.length===24 && url.startsWith('UC')){ id=url; }
    if(url.length===11 && !id){ toast('채널 URL이 아닙니다.'); return; }
    if(id){
      try{ await addChannelById(id); qs('modal-add').style.display='none'; }
      catch(e){ toast('채널 추가 실패: '+e.message); }
    }else toast('올바른 채널 URL 또는 ID를 입력해주세요.');
  };
  document.querySelectorAll('.tabs .tab').forEach(t=>t.onclick=()=>{
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    t.classList.add('active');
    document.querySelectorAll('.tabpanel').forEach(p=>p.classList.remove('active'));
    qs(t.dataset.tab).classList.add('active');
  });

  // 새로고침 버튼
  qs('sort-channels').onchange=()=>refreshChannels();
  qs('sort-mutant').onchange=()=>refreshMutant();
  qs('sort-latest').onchange=()=>refreshLatest();
  document.querySelectorAll('.date-range button').forEach(b=>b.onclick=()=>{
    document.querySelectorAll('.date-range button').forEach(bb=>bb.classList.remove('active'));
    b.classList.add('active');
    currentMutantPeriod=b.dataset.period;
    refreshMutant();
  });
  
  // 키워드
  initKeywordAnalysis();
  
  // 테마 토글
  const themeBtn=qs('btn-toggle-theme');
  const savedTheme=localStorage.getItem('theme')||'light';
  document.body.classList.add(savedTheme);
  themeBtn.textContent=savedTheme==='dark'?'라이트 모드':'다크 모드';
  themeBtn.onclick=()=>{
    const newTheme=document.body.classList.contains('dark')?'light':'dark';
    document.body.classList.remove('light','dark');
    document.body.classList.add(newTheme);
    themeBtn.textContent=newTheme==='dark'?'라이트 모드':'다크 모드';
    localStorage.setItem('theme',newTheme);
  };

  // 초기 로드
  openDB().then(()=>{ refreshAll(); });
});

async function refreshAll(target='all'){
  if(target==='channels' || target==='all') refreshChannels();
  if(target==='mutant' || target==='all') refreshMutant();
  if(target==='latest' || target==='all') refreshLatest();
}

window.onpopstate = () => {
  if (currentView === 'analysis') {
    hideAnalysisPage();
  } else {
    // Other history states if any
  }
};
</script>
</body>
</html>
