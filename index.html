<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ìœ íŠœë¸Œ ë„ìš°ë¯¸ â€” ì±„ë„ ëª¨ë‹ˆí„°</title>
<link rel="icon" href="favicon.ico"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.45/moment-timezone-with-data.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<style>
:root{--brand:#c4302b;--bg:#f6f7fb;--card:#fff;--muted:#888;--shadow:0 6px 22px rgba(0,0,0,.07);--pastel1:#fff6f1;--pastel2:#f1fbff;--pastel3:#f8fff4}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:#333;font-family:Arial,Helvetica,sans-serif;line-height:1.55}
.container{max-width:1440px;margin:24px auto;background:#fff;padding:22px;border-radius:16px;box-shadow:0 0 24px rgba(0,0,0,.06)}
h1{margin:6px 0 14px;text-align:center;color:var(--brand)}
.single-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.api-btn{background:var(--brand);color:#fff;border:0;border-radius:8px;padding:8px 14px;cursor:pointer}
.three-col{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
@media (max-width:900px){.three-col{grid-template-columns:1fr}}
.col{background:var(--card);border-radius:14px;box-shadow:var(--shadow);padding:14px;display:flex;flex-direction:column;gap:10px}
.col-head{display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #f0f0f0;padding-bottom:8px;cursor:grab}
.col-actions{display:flex;gap:8px;align-items:center}
.sort-row{display:flex;justify-content:flex-end}
.sort-row select{padding:6px 10px;border:1px solid #ccc;border-radius:6px;background:#fff}
.muted{color:#aaa;text-align:center}
.channel-list{display:flex;flex-direction:column;gap:10px}
.channel-card{display:grid;grid-template-columns:56px 1.3fr auto 1.2fr;gap:10px;align-items:center;border:1px solid #eee;background:#fafafa;border-radius:12px;padding:10px}
.channel-thumb{width:56px;height:56px;border-radius:50%;object-fit:cover;background:#eee}
.channel-meta h3{margin:0 0 4px 0;color:var(--brand);font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.channel-meta .row{display:flex;gap:10px;flex-wrap:wrap;font-size:13px}
.channel-meta .latest{font-size:12px;color:#777}
.channel-actions{display:flex;gap:6px;justify-content:flex-end}
.btn{border:1px solid #e2e2e2;background:#eee;color:var(--brand);border-radius:6px;padding:6px 10px;cursor:pointer}
.btn:hover{background:var(--brand);color:#fff}
.btn-danger{background:#dc3545;color:#fff;border:none}
.insights{display:grid;grid-template-columns:1fr 1fr;gap:6px 10px;font-size:12px}
.insights .k{color:#666}.insights .v{font-weight:600}
.video-list{display:flex;flex-direction:column;gap:12px}
.video-card{border-radius:14px;box-shadow:var(--shadow);overflow:hidden}
.video-card:nth-child(3n+1){background:var(--pastel1)}
.video-card:nth-child(3n+2){background:var(--pastel2)}
.video-card:nth-child(3n+3){background:var(--pastel3)}
.video-link{display:block;color:inherit;text-decoration:none;padding:12px}
.thumb-wrap{padding:10px}
.thumb{width:100%;height:auto;object-fit:contain;aspect-ratio:16/9;display:block}
.v-title{font-weight:700;margin:8px 2px 6px}
.v-meta{font-size:13px;color:#555;display:flex;gap:12px;flex-wrap:wrap}
.badge{display:inline-block;background:linear-gradient(90deg,#e4002b 40%,#fdcf6f 100%);color:#fff;border-radius:14px;padding:4px 10px;font-weight:800;margin-top:8px}
.keywords{display:flex;flex-wrap:wrap;gap:6px}
.kw{font-size:12px;background:#f1f1f1;border-radius:999px;padding:4px 8px}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:10;align-items:center;justify-content:center}
.modal .content{background:#fff;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.25);padding:16px;max-width:720px;width:96%}
.modal .close{float:right;font-size:22px;color:#999;cursor:pointer}
.api-inputs{display:grid;grid-template-columns:1fr;gap:6px;margin:8px 0}
.api-inp{width:100%;padding:10px;border:1px solid #ddd;border-radius:8px}
.file-label{background:#6c757d;color:#fff;border-radius:8px;padding:8px 12px;display:inline-block;cursor:pointer}
.file-label input{display:none}
.tabs{display:flex;gap:6px;margin:8px 0 10px}
.tab{border:1px solid #ddd;background:#fafafa;border-radius:6px;padding:6px 10px;cursor:pointer}
.tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}
.tabpanel{display:none}.tabpanel.active{display:block}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.search-input{flex:1;padding:10px;border:1px solid #ddd;border-radius:8px}
.result-list{display:flex;flex-direction:column;gap:10px;max-height:420px;overflow:auto}
.result-row{display:grid;grid-template-columns:64px 1fr auto;gap:10px;align-items:center;border:1px solid #eee;border-radius:10px;padding:10px;cursor:pointer}
.result-row:hover{background:#f8f9fa}
.r-avatar{width:64px;height:64px;border-radius:50%;object-fit:contain;background:#fff;border:1px solid #eee}
.r-thumb{width:64px;height:64px;border-radius:8px;object-fit:contain;background:#fff;border:1px solid #eee}
.r-title{font-weight:700;margin-bottom:3px}.r-sub{font-size:12px;color:#666}
.pagination{display:flex;gap:6px;justify-content:center;margin-top:8px}
.pagination button{padding:6px 10px;border:1px solid #ddd;background:#fafafa;border-radius:6px;cursor:pointer}
.pagination button.active{background:var(--brand);color:#fff}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:.95;z-index:9999;display:none}
.small{font-size:12px;color:#666}
.test-ok{color:#1db954}.test-bad{color:#c4302b}
.date-range{display:flex;gap:4px}
.date-range button{padding:4px 8px;border:1px solid #ddd;background:#fafafa;border-radius:4px;cursor:pointer;font-size:12px}
.date-range button.active{background:var(--brand);color:#fff;border-color:var(--brand)}
.error-message{color:#c4302b;background:#ffebee;padding:8px;border-radius:6px;margin:8px 0;font-size:14px}
.success-message{color:#1db954;background:#e8f5e8;padding:8px;border-radius:6px;margin:8px 0;font-size:14px}
</style>
</head>
<body>
<div class="container">
  <h1>ìœ íŠœë¸Œ ë„ìš°ë¯¸</h1>
  <div class="single-header">
    <div><strong>ì±„ë„ ëª¨ë‹ˆí„°</strong><div class="small">ì„¹ì…˜ ì œëª©ì„ ê¸¸ê²Œ ëˆŒëŸ¬ ë“œë˜ê·¸í•˜ë©´ ìˆœì„œë¥¼ ë°”ê¿€ ìˆ˜ ìˆì–´ìš”.</div></div>
    <button id="btn-api" class="api-btn">API í‚¤ ì…ë ¥</button>
  </div>

  <div id="columns" class="three-col">
    <section class="col" data-col="channels">
      <div class="col-head" draggable="true">
        <h2>ì±„ë„ ì¶”ê°€</h2>
        <div class="col-actions">
          <button id="btn-add-channel" class="btn">+ ì±„ë„ ì¶”ê°€</button>
          <span>ë“±ë¡: <span id="channel-count">0</span></span>
        </div>
      </div>
      <div class="sort-row">
        <label>ì •ë ¬:
          <select id="sort-channels">
            <option value="subscribers" selected>êµ¬ë…ììˆ˜</option>
            <option value="videos">ì˜ìƒê°¯ìˆ˜</option>
            <option value="latest">ìµœê·¼ì—…ë¡œë“œ</option>
          </select>
        </label>
      </div>
      <div id="channel-list" class="channel-list"><p class="muted">ì±„ë„ì„ ì¶”ê°€í•˜ì„¸ìš”.</p></div>
    </section>

    <section class="col" data-col="mutant">
      <div class="col-head" draggable="true">
        <h2>ëŒì—°ë³€ì´ ì˜ìƒ</h2>
        <div class="col-actions">
          <div class="date-range">
            <button data-period="1m">1ê°œì›”</button>
            <button data-period="3m">3ê°œì›”</button>
            <button class="active" data-period="6m">6ê°œì›”</button>
            <button data-period="all">ì „ì²´</button>
          </div>
        </div>
      </div>
      <div class="sort-row">
        <label>ì •ë ¬:
          <select id="sort-mutant">
            <option value="mutantIndex" selected>ëŒì—°ë³€ì´ì§€ìˆ˜</option>
            <option value="views">ì¡°íšŒìˆ˜</option>
            <option value="subscribers">êµ¬ë…ììˆ˜</option>
            <option value="latest">ìµœê·¼ì—…ë¡œë“œ</option>
          </select>
        </label>
      </div>
      <div id="mutant-keywords" class="keywords"></div>
      <div id="mutant-list" class="video-list"><p class="muted">ì±„ë„ì„ ì¶”ê°€í•˜ì—¬ ì˜ìƒì„ ë¶„ì„í•´ì£¼ì„¸ìš”.</p></div>
    </section>

    <section class="col" data-col="latest">
      <div class="col-head" draggable="true"><h2>ìµœì‹  ì˜ìƒ</h2></div>
      <div class="sort-row">
        <label>ì •ë ¬:
          <select id="sort-latest">
            <option value="views" selected>ì¡°íšŒìˆ˜</option>
            <option value="subscribers">êµ¬ë…ììˆ˜</option>
            <option value="latest">ìµœê·¼ì—…ë¡œë“œ</option>
            <option value="mutantIndex">ëŒì—°ë³€ì´ì§€ìˆ˜</option>
          </select>
        </label>
      </div>
      <div id="latest-keywords" class="keywords"></div>
      <div id="latest-list" class="video-list"><p class="muted">ì±„ë„ì„ ì¶”ê°€í•˜ì—¬ ì˜ìƒì„ ë¶„ì„í•´ì£¼ì„¸ìš”.</p></div>
    </section>
  </div>
</div>

<div id="modal-api" class="modal">
  <div class="content">
    <span class="close" data-close="modal-api">Ã—</span>
    <h3>API í‚¤ ì…ë ¥</h3>
    <p>ìµœëŒ€ 5ê°œê¹Œì§€ ì €ì¥í•˜ê³  ìë™ ìˆœí™˜ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>
    <div id="api-inputs" class="api-inputs"></div>
    <div class="row" style="margin-top:8px">
      <input type="file" id="api-file" accept=".txt" style="display:none"/>
      <button id="api-file-btn" class="file-label" type="button">API í‚¤ ì—…ë¡œë“œ(.txt)</button>
      <button id="api-save" class="btn" type="button">ì €ì¥</button>
      <button id="api-download" class="btn" type="button">ë‹¤ìš´ë¡œë“œ</button>
      <button id="api-test" class="btn" type="button">API í‚¤ í…ŒìŠ¤íŠ¸</button>
    </div>
    <div id="api-test-result" class="small"></div>
  </div>
</div>

<div id="modal-add" class="modal">
  <div class="content">
    <span class="close" data-close="modal-add">Ã—</span>
    <h3>ì±„ë„ ì¶”ê°€</h3>
    <div class="tabs">
      <button class="tab active" data-tab="tab-ch-search">ì±„ë„ëª… ê²€ìƒ‰</button>
      <button class="tab" data-tab="tab-vid-search">ì˜ìƒ ê²€ìƒ‰(ë¡±í¼ë§Œ)</button>
      <button class="tab" data-tab="tab-url-add">URL ì§ì ‘ ì…ë ¥</button>
    </div>
    <div id="tab-ch-search" class="tabpanel active">
      <div class="row"><input id="ch-query" class="search-input" placeholder="ì±„ë„ëª…ìœ¼ë¡œ ê²€ìƒ‰"/><button id="btn-ch-search" class="btn">ê²€ìƒ‰</button></div>
      <div id="ch-results" class="result-list"></div>
      <div id="ch-pagination" class="pagination"></div>
    </div>
    <div id="tab-vid-search" class="tabpanel">
      <div class="row"><input id="vid-query" class="search-input" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥(ë¡±í¼ë§Œ í‘œì‹œ)"/><button id="btn-vid-search" class="btn">ê²€ìƒ‰</button></div>
      <div id="vid-results" class="result-list"></div>
      <div id="vid-pagination" class="pagination"></div>
    </div>
    <div id="tab-url-add" class="tabpanel">
      <div class="row">
        <input id="url-input" class="search-input" placeholder="ì±„ë„ URL ë˜ëŠ” ì±„ë„ ID, í•¸ë“¤ ì…ë ¥"/>
        <button id="btn-url-add" class="btn">ì¶”ê°€</button>
      </div>
      <div id="url-result"></div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
moment.tz.setDefault('Asia/Seoul');
const API='https://www.googleapis.com/youtube/v3/';
let currentMutantPeriod='6m';

/* API í‚¤ ê´€ë¦¬ */
let apiKeys = JSON.parse(localStorage.getItem('youtubeApiKeys') || localStorage.getItem('apiKeys') || '[]');
if (!localStorage.getItem('youtubeApiKeys') && localStorage.getItem('apiKeys')) {
  localStorage.setItem('youtubeApiKeys', localStorage.getItem('apiKeys'));
}
let keyIdx=0;

function setApiKeys(keys){
  apiKeys = keys.filter(Boolean);
  keyIdx = 0;
  localStorage.setItem('youtubeApiKeys', JSON.stringify(apiKeys));
  localStorage.setItem('apiKeys', JSON.stringify(apiKeys));
}

function nextKey(){ 
  if(apiKeys.length > 1) keyIdx=(keyIdx+1)%apiKeys.length; 
}

function hasKeys(){ return apiKeys.length>0; }

/* IndexedDB */
let db=null;
function openDB(){ 
  return new Promise((res,rej)=>{ 
    if(db) return res(db); 
    const r=indexedDB.open('myChannelDB',3);
    r.onupgradeneeded=e=>{ 
      db=e.target.result; 
      if(!db.objectStoreNames.contains('my_channels')) 
        db.createObjectStore('my_channels',{keyPath:'id'});
      if(!db.objectStoreNames.contains('insights')) 
        db.createObjectStore('insights',{keyPath:'channelId'});
      if(!db.objectStoreNames.contains('dailySubs')) 
        db.createObjectStore('dailySubs',{keyPath:['channelId','date']}); 
    };
    r.onsuccess=e=>{ db=e.target.result; res(db); }; 
    r.onerror=e=>rej(e); 
  }); 
}

function idbAll(store){ 
  return openDB().then(db=>new Promise((res,rej)=>{ 
    const tx=db.transaction(store,'readonly'); 
    const s=tx.objectStore(store); 
    const q=s.getAll(); 
    q.onsuccess=()=>res(q.result); 
    q.onerror=()=>rej(q.error);
  })); 
}

function idbGet(store,key){ 
  return openDB().then(db=>new Promise((res,rej)=>{ 
    const tx=db.transaction(store,'readonly'); 
    const s=tx.objectStore(store); 
    const q=s.get(key); 
    q.onsuccess=()=>res(q.result); 
    q.onerror=()=>rej(q.error);
  })); 
}

/* IndexedDB ê°œì„  */
async function idbPut(store,obj){ 
  return openDB().then(db=>new Promise((res,rej)=>{ 
    try {
      const tx=db.transaction(store,'readwrite'); 
      const s=tx.objectStore(store); 
      const q=s.put(obj); 
      q.onsuccess=()=>{
        console.log(`IndexedDB ì €ì¥ ì„±ê³µ: ${store}`, obj);
        res();
      }; 
      q.onerror=()=>{
        console.error(`IndexedDB ì €ì¥ ì˜¤ë¥˜: ${store}`, q.error);
        rej(q.error);
      };
      tx.onerror=()=>{
        console.error(`IndexedDB íŠ¸ëœì­ì…˜ ì˜¤ë¥˜: ${store}`, tx.error);
        rej(tx.error);
      };
    } catch(e) {
      console.error(`IndexedDB ì˜ˆì™¸: ${store}`, e);
      rej(e);
    }
  })); 
}

function idbDel(store,key){ 
  return openDB().then(db=>new Promise((res,rej)=>{ 
    const tx=db.transaction(store,'readwrite'); 
    const s=tx.objectStore(store); 
    const q=s.delete(key); 
    q.onsuccess=()=>res(); 
    q.onerror=()=>rej(q.error);
  })); 
}

/* ìœ í‹¸ë¦¬í‹° */
const qs=id=>document.getElementById(id);
const fmt=n=>{ const x=parseInt(n||'0',10); return isNaN(x)?'0':x.toLocaleString(); };
const seconds=iso=>moment.duration(iso).asSeconds();

function toast(msg,ms=1800){ 
  const t=qs('toast'); 
  t.textContent=msg; 
  t.style.display='block'; 
  setTimeout(()=>t.style.display='none',ms); 
}

function showError(elementId, message) {
  const el = qs(elementId);
  el.innerHTML = `<div class="error-message">${message}</div>`;
}

function showSuccess(elementId, message) {
  const el = qs(elementId);
  el.innerHTML = `<div class="success-message">${message}</div>`;
}

/* API í˜¸ì¶œ */
async function yt(endpoint,params,attempt=0){
  if(!apiKeys.length){ 
    throw new Error('API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.'); 
  }
  
  const ctrl=new AbortController(); 
  const t=setTimeout(()=>ctrl.abort('timeout'),30000); // íƒ€ì„ì•„ì›ƒ ì—°ì¥
  const p=new URLSearchParams(params); 
  p.set('key',apiKeys[keyIdx]);
  
  const url = API+endpoint+'?'+p.toString();
  console.log(`API í˜¸ì¶œ: ${url}`); // ë””ë²„ê¹…ìš©
  
  try{
    const r=await fetch(url,{signal:ctrl.signal});
    console.log(`API ì‘ë‹µ ìƒíƒœ: ${r.status}`); // ë””ë²„ê¹…ìš©
    
    const data=await r.json(); 
    clearTimeout(t);
    
    console.log('API ì‘ë‹µ ë°ì´í„°:', data); // ë””ë²„ê¹…ìš©
    
    if(data.error){ 
      console.error('API Error:', data.error);
      const errorMsg = `API ì˜¤ë¥˜ (${data.error.code}): ${data.error.message}`;
      
      // í• ë‹¹ëŸ‰ ì´ˆê³¼ ì²´í¬
      if(data.error.code === 403 && data.error.message.includes('quota')){
        throw new Error('API í• ë‹¹ëŸ‰ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë‚´ì¼ ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ ë‹¤ë¥¸ API í‚¤ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
      }
      
      // ê¶Œí•œ ì˜¤ë¥˜ ì²´í¬
      if(data.error.code === 403){
        throw new Error('API í‚¤ ê¶Œí•œ ì˜¤ë¥˜ì…ë‹ˆë‹¤. Google Cloud Consoleì—ì„œ YouTube Data API v3ì´ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
      }
      
      if(attempt<apiKeys.length-1){ 
        nextKey(); 
        return yt(endpoint,params,attempt+1);
      } 
      throw new Error(errorMsg); 
    }
    return data;
  }catch(e){
    clearTimeout(t);
    console.error('Fetch Error:', e);
    
    if(e.name === 'AbortError'){
      throw new Error('API í˜¸ì¶œ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
    }
    
    if(attempt<apiKeys.length-1){ 
      nextKey(); 
      return yt(endpoint,params,attempt+1); 
    }
    throw e;
  }
}

/* ì±„ë„ ID ì¶”ì¶œ ê°œì„  */
function extractChannelId(url) {
  if (!url) return null;
  
  url = url.trim();
  
  // ì´ë¯¸ ì±„ë„ IDì¸ ê²½ìš° (UCë¡œ ì‹œì‘í•˜ëŠ” 24ìë¦¬)
  if (/^UC[a-zA-Z0-9_-]{22}$/.test(url)) {
    return { type: 'id', value: url };
  }
  
  // URLì—ì„œ ì±„ë„ ID, ì‚¬ìš©ìëª…, í•¸ë“¤ ì¶”ì¶œ
  const patterns = [
    /(?:youtube\.com|youtu\.be)\/channel\/([a-zA-Z0-9_-]+)/, // ê¸°ë³¸ ì±„ë„ URL
    /(?:youtube\.com|youtu\.be)\/c\/([a-zA-Z0-9_-]+)/,      // ì»¤ìŠ¤í…€ URL
    /(?:youtube\.com|youtu\.be)\/user\/([a-zA-Z0-9_-]+)/,    // ì‚¬ìš©ì URL
    /(?:youtube\.com|youtu\.be)\/@([a-zA-Z0-9_-]+)/,         // ìƒˆë¡œìš´ í•¸ë“¤ í˜•ì‹
    /^@([a-zA-Z0-9_-]+)$/                                   // ë‹¨ìˆœ í•¸ë“¤
  ];
  
  for (const pattern of patterns) {
    const match = url.match(pattern);
    if (match) {
      const extracted = match[1];
      // UCë¡œ ì‹œì‘í•˜ëŠ” ì‹¤ì œ ì±„ë„ IDì¸ ê²½ìš°
      if (extracted.startsWith('UC') && extracted.length === 24) {
        return { type: 'id', value: extracted };
      }
      // í•¸ë“¤ì´ë‚˜ ì‚¬ìš©ìëª…ì¸ ê²½ìš°
      return { type: 'handleOrUsername', value: extracted };
    }
  }
  
  // ì–´ë–¤ íŒ¨í„´ì—ë„ ë§ì§€ ì•ŠëŠ” ê²½ìš°, ì±„ë„ëª…ìœ¼ë¡œ ê°„ì£¼í•˜ê³  ê²€ìƒ‰í•˜ë„ë¡ í•¨
  return { type: 'channelName', value: url };
}

/* ì±„ë„ ê´€ë¦¬ */
async function getAllChannels(){ return idbAll('my_channels'); }

async function saveChannel(c){ return idbPut('my_channels',c); }

async function deleteChannel(id){ 
  await idbDel('my_channels',id); 
  await idbDel('insights',id); 
}

function sortChannels(list,mode){
  if(mode==='videos') list.sort((a,b)=>parseInt(b.videoCount||'0')-parseInt(a.videoCount||'0'));
  else if(mode==='latest') list.sort((a,b)=>new Date(b.latestUploadDate||0)-new Date(a.latestUploadDate||0));
  else list.sort((a,b)=>parseInt(b.subscriberCount||'0')-parseInt(a.subscriberCount||'0'));
}

async function ensureUploadsAndLatest(ch){
  if(ch.uploadsPlaylistId && ch.latestUploadDate) return ch;
  
  try {
    const info=await yt('channels',{part:'contentDetails',id:ch.id});
    ch.uploadsPlaylistId=info.items?.[0]?.contentDetails?.relatedPlaylists?.uploads||'';
    
    if(ch.uploadsPlaylistId){
      const pl=await yt('playlistItems',{part:'snippet',playlistId:ch.uploadsPlaylistId,maxResults:1});
      if(pl.items && pl.items[0]) ch.latestUploadDate=pl.items[0].snippet.publishedAt;
    }
    await saveChannel(ch); 
  } catch(e) {
    console.error('Error updating channel info:', e);
  }
  
  return ch;
}

async function getYesterdaySubCount(ch){
  const y=moment().subtract(1,'day').format('YYYY-MM-DD');
  const rec=await idbGet('dailySubs',[ch.id,y]); 
  return rec? rec.subCount:null;
}

async function updateDailySubSnapshot(ch){
  const today=moment().format('YYYY-MM-DD');
  const ex=await idbGet('dailySubs',[ch.id,today]);
  if(!ex) await idbPut('dailySubs',{
    channelId:ch.id,
    date:today,
    subCount:parseInt(ch.subscriberCount||'0',10)
  });
}

/* ì±„ë„ ë“±ë¡ ê°œì„  */
async function addChannelById(channelId){
  if(!channelId) {
    console.error('ì±„ë„ IDê°€ ì—†ìŠµë‹ˆë‹¤:', channelId);
    toast('ì˜¬ë°”ë¥¸ ì±„ë„ IDê°€ ì•„ë‹™ë‹ˆë‹¤.');
    return false;
  }
  
  console.log('ğŸ”µ ì±„ë„ ì¶”ê°€ ì‹œì‘:', channelId);
  
  try {
    // 1. ì´ë¯¸ ë“±ë¡ëœ ì±„ë„ì¸ì§€ í™•ì¸
    console.log('ğŸ“‹ ê¸°ì¡´ ì±„ë„ í™•ì¸ ì¤‘...');
    const exist=await idbGet('my_channels',channelId);
    if(exist){ 
      console.log('âŒ ì´ë¯¸ ë“±ë¡ëœ ì±„ë„:', exist.title);
      toast('ì´ë¯¸ ë“±ë¡ëœ ì±„ë„ì…ë‹ˆë‹¤: ' + exist.title); 
      return false;
    }
    
    // 2. ì±„ë„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    console.log('ğŸ” ì±„ë„ ì •ë³´ ìš”ì²­ ì¤‘...');
    const ch=await yt('channels',{
      part:'snippet,statistics,contentDetails',
      id:channelId
    });
    
    console.log('ğŸ“¥ ì±„ë„ ì •ë³´ ì‘ë‹µ:', ch);
    
    const it=ch.items?.[0]; 
    
    if(!it) {
      console.error('âŒ ì±„ë„ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
      throw new Error('ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì±„ë„ IDë‚˜ URLì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
    }
    
    console.log('âœ… ì±„ë„ ì°¾ìŒ:', it.snippet.title);
    
    // 3. ì—…ë¡œë“œ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ë° ìµœì‹  ì˜ìƒ ì •ë³´
    const uploads=it.contentDetails?.relatedPlaylists?.uploads||'';
    let latest=it.snippet.publishedAt;
    let country=it.snippet.country||'-';
    
    console.log('ğŸ“º ì—…ë¡œë“œ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ID:', uploads);
    
    // 4. ìµœì‹  ì—…ë¡œë“œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    if(uploads){
      try{
        console.log('â° ìµœì‹  ì—…ë¡œë“œ í™•ì¸ ì¤‘...');
        const pl=await yt('playlistItems',{
          part:'snippet',
          playlistId:uploads,
          maxResults:1
        });
        if(pl.items && pl.items[0]) {
          latest=pl.items[0].snippet.publishedAt||latest;
          console.log('ğŸ“… ìµœì‹  ì—…ë¡œë“œ ë‚ ì§œ:', latest);
        }
      }catch(e){
        console.warn('âš ï¸ ìµœì‹  ì—…ë¡œë“œ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', e.message);
      }
    }
    
    // 5. ì±„ë„ ë°ì´í„° ì¤€ë¹„
    const data={ 
      id:it.id,
      title:it.snippet.title,
      thumbnail:it.snippet.thumbnails?.default?.url||'',
      subscriberCount:it.statistics.subscriberCount||'0',
      videoCount:it.statistics.videoCount||'0',
      uploadsPlaylistId:uploads,
      latestUploadDate:latest,
      country 
    };
    
    console.log('ğŸ’¾ ì €ì¥í•  ì±„ë„ ë°ì´í„°:', data);
    
    // 6. IndexedDBì— ì €ì¥
    console.log('ğŸ’¾ IndexedDBì— ì €ì¥ ì¤‘...');
    await idbPut('my_channels',data);
    
    console.log('âœ… ì±„ë„ ì €ì¥ ì™„ë£Œ!');
    toast(`âœ… ${data.title} ì±„ë„ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!`);
    
    // 7. ì±„ë„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ (ë°±ê·¸ë¼ìš´ë“œì—ì„œ)
    console.log('ğŸ”„ ì±„ë„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨...');
    setTimeout(() => {
      refreshAll('channels').catch(e => {
        console.error('ìƒˆë¡œê³ ì¹¨ ì˜¤ë¥˜:', e);
      });
    }, 100);
    
    return true;
    
  } catch(e) {
    console.error('âŒ ì±„ë„ ì¶”ê°€ ì˜¤ë¥˜:', e);
    
    let errorMessage = e.message;
    
    // íŠ¹ì • ì˜¤ë¥˜ ë©”ì‹œì§€ ê°œì„ 
    if(e.message.includes('quota')){
      errorMessage = 'âš ï¸ API í• ë‹¹ëŸ‰ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
    } else if(e.message.includes('403')){
      errorMessage = 'ğŸ”’ API í‚¤ ê¶Œí•œ ì˜¤ë¥˜ì…ë‹ˆë‹¤. Google Cloud Console ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
    } else if(e.message.includes('404')){
      errorMessage = 'ğŸ” ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì±„ë„ IDë‚˜ URLì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
    } else if(e.message.includes('timeout') || e.message.includes('AbortError')){
      errorMessage = 'ğŸŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì´ ë¶ˆì•ˆì •í•©ë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
    }
    
    toast('âŒ ì±„ë„ ë“±ë¡ ì‹¤íŒ¨: ' + errorMessage);
    return false;
  }
}

/* ì±„ë„ ë Œë”ë§ */
async function refreshChannels(){
  try {
    const list=await getAllChannels();
    
    for(const ch of list){ 
      await ensureUploadsAndLatest(ch); 
      await updateDailySubSnapshot(ch); 
    }
    
    sortChannels(list,qs('sort-channels').value);
    qs('channel-count').textContent=list.length;
    
    const wrap=qs('channel-list');
    if(!list.length){ 
      wrap.innerHTML='<p class="muted">ì±„ë„ì„ ì¶”ê°€í•˜ì„¸ìš”.</p>'; 
      return; 
    }
    
    wrap.innerHTML='';
    for(const ch of list){
      const y=await getYesterdaySubCount(ch);
      const today=parseInt(ch.subscriberCount||'0',10);
      const diff=y==null? null : today-y;
      const diffStr=y==null? '<small class="k">(ì „ì¼ ì •ë³´ ì—†ìŒ)</small>'
        : diff>0? `<span class="v" style="color:#1db954">+${fmt(diff)}</span>`
        : diff<0? `<span class="v" style="color:#c4302b">${fmt(diff)}</span>`
        : `<span class="v" style="color:#888">0</span>`;
        
      const el=document.createElement('div');
      el.className='channel-card';
      el.innerHTML=`
        <img class="channel-thumb" src="${ch.thumbnail||''}" alt="">
        <div class="channel-meta">
          <h3 title="${ch.title}">${ch.title}</h3>
          <div class="row">
            <span>êµ¬ë…ì: <strong>${fmt(today)}</strong></span>
            <span>ì˜ìƒ: <strong>${fmt(ch.videoCount)}</strong></span>
          </div>
          <div class="latest">ìµœì‹  ì—…ë¡œë“œ: ${ch.latestUploadDate? moment(ch.latestUploadDate).format('YYYY-MM-DD'):'-'}</div>
        </div>
        <div class="channel-actions">
          <a class="btn" target="_blank" href="https://www.youtube.com/channel/${ch.id}">ì±„ë„</a>
          <a class="btn" target="_blank" href="https://www.youtube.com/playlist?list=${ch.uploadsPlaylistId||''}">ì—…ë¡œë“œ</a>
          <a class="btn" target="_blank" href="https://www.youtube.com/channel/${ch.id}/community">ì»¤ë®¤ë‹ˆí‹°</a>
          <button class="btn-danger" data-del="${ch.id}">ì‚­ì œ</button>
        </div>
        <div class="insights" id="ins-${ch.id}">
          <div><span class="k">ì „ì¼ëŒ€ë¹„</span> <span class="v">${diffStr}</span></div>
          <div><span class="k">í‰ê· ì¡°íšŒ</span> <span class="v">-</span></div>
          <div><span class="k">ì¢‹ì•„ìš”ìœ¨</span> <span class="v">-</span></div>
          <div><span class="k">ì—…ë¡œë“œë¹ˆë„</span> <span class="v">-</span></div>
          <div><span class="k">í‰ê· ê¸¸ì´</span> <span class="v">-</span></div>
          <div><span class="k">ë¡±/ìˆ</span> <span class="v">-</span></div>
          <div><span class="k">êµ­ê°€</span> <span class="v">${ch.country||'-'}</span></div>
          <div><span class="k">ìµœë‹¤ìš”ì¼</span> <span class="v">-</span></div>
          <div style="grid-column:1/-1"><span class="k">ì¹´í…Œê³ ë¦¬</span> <span class="v">-</span></div>
        </div>`;
      
      el.querySelector('[data-del]').onclick=async()=>{ 
        if(confirm('ì±„ë„ì„ ì‚­ì œí• ê¹Œìš”?')){ 
          await deleteChannel(ch.id); 
          refreshAll('channels'); 
        } 
      };
      wrap.appendChild(el);
    }
  } catch(e) {
    console.error('Error refreshing channels:', e);
    const wrap=qs('channel-list');
    wrap.innerHTML=`<div class="error-message">ì±„ë„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${e.message}</div>`;
  }
}

/* ì˜ìƒ ë Œë”ë§ */
function renderVideoList(videos, listId, kwId){
  const wrap=qs(listId);
  if(!videos.length){ 
    wrap.innerHTML='<p class="muted">í‘œì‹œí•  ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>'; 
    if(kwId) qs(kwId).innerHTML=''; 
    return; 
  }
  
  wrap.innerHTML='';
  videos.forEach(v=>{
    const card=document.createElement('div');
    card.className='video-card';
    card.innerHTML=`
      <a class="video-link" target="_blank" href="https://www.youtube.com/watch?v=${v.id}">
        <div class="thumb-wrap"><img class="thumb" src="${v.thumbnail}" alt=""></div>
        <div class="v-title">${v.title}</div>
        <div class="v-meta">
          <span>ì¡°íšŒìˆ˜: ${fmt(v.viewCount)}</span>
          <span>ì—…ë¡œë“œ: ${moment(v.publishedAt).format('YYYY-MM-DD')}</span>
          <span>êµ¬ë…ì: ${fmt(v.__ch.subscriberCount)}</span>
          ${v.mutantIndex? `<span>ëŒì—°ë³€ì´ì§€ìˆ˜: <strong>${v.mutantIndex}</strong></span>`:''}
        </div>
        ${v.mutantIndex? `<div class="badge">${v.mutantIndex}</div>`:''}
      </a>`;
    wrap.appendChild(card);
  });
  
  if(kwId){
    const stop=new Set(['ì€','ëŠ”','ì´','ê°€','ì„','ë¥¼','ì—','ì˜','ì™€','ê³¼','ë„','ë¡œ','ìœ¼ë¡œ','the','a','an','of','to','in','on','for','and','or','but','with','about','into','ì—ì„œ','ìœ¼ë¡œ','ê°™ì€','ë¿','ìœ„í•´','í•©ë‹ˆë‹¤','í–ˆë‹¤','í•˜ëŠ”','í•˜ê¸°','ì§„ì§œ','ë¬´ë„ˆì¡Œë‹¤']);
    const f=new Map();
    videos.map(v=>v.title||'').forEach(t=>{
      t.replace(/[#"'.!?()/\-:;[\]{}|<>~^%$@*&+=]/g,' ').split(/\s+/).forEach(w=>{
        w=w.trim().toLowerCase(); 
        const hasKo=/[ê°€-í£]/.test(w);
        if(!w) return; 
        if((hasKo && w.length<2)||(!hasKo && w.length<3)) return; 
        if(stop.has(w)) return;
        f.set(w,(f.get(w)||0)+1);
      });
    });
    const top=[...f.entries()].sort((a,b)=>b[1]-a[1]).slice(0,12);
    qs(kwId).innerHTML=top.map(([w,c])=>`<span class="kw">${w} ${c}íšŒ</span>`).join('');
  }
}

function sortVideoCards(list,mode){
  if(mode==='views') list.sort((a,b)=>b.viewCount-a.viewCount);
  else if(mode==='subscribers') list.sort((a,b)=>b.__ch.subscriberCount-a.__ch.subscriberCount);
  else if(mode==='latest') list.sort((a,b)=>new Date(b.publishedAt)-new Date(a.publishedAt));
  else list.sort((a,b)=>parseFloat(b.mutantIndex||0)-parseFloat(a.mutantIndex||0));
}

/* ëŒì—°ë³€ì´ ì˜ìƒ */
async function refreshMutant(){
  try {
    const channels=await getAllChannels();
    let list=[]; 
    let minDate=null;
    
    if(currentMutantPeriod!=='all'){
      const n=currentMutantPeriod==='1m'?1:currentMutantPeriod==='3m'?3:6;
      minDate=moment().subtract(n,'months');
    }
    
    for(const ch of channels){
      await ensureUploadsAndLatest(ch);
      if(!ch.uploadsPlaylistId) continue;
      
      let ids=[], next=null, stop=false;
      while(!stop){
        try {
          const pl=await yt('playlistItems',{
            part:'snippet,contentDetails',
            playlistId:ch.uploadsPlaylistId,
            maxResults:50,
            pageToken:next||''
          });
          const items=pl.items||[];
          const filtered=minDate? items.filter(i=>moment(i.snippet.publishedAt).isAfter(minDate)):items;
          ids.push(...filtered.map(i=>i.contentDetails.videoId));
          next=pl.nextPageToken; 
          if(!next || (minDate && filtered.length<items.length)) stop=true;
        } catch(e) {
          console.error('Error fetching playlist items:', e);
          break;
        }
      }
      
      for(let i=0;i<ids.length;i+=50){
        try {
          const d=await yt('videos',{
            part:'snippet,statistics,contentDetails',
            id:ids.slice(i,i+50).join(',')
          });
          (d.items||[]).forEach(v=>{
            const dur=seconds(v.contentDetails.duration); 
            if(dur<=180) return;
            const views=parseInt(v.statistics.viewCount||'0',10);
            const subs=parseInt(ch.subscriberCount||'1',10);
            if(views<subs*2) return;
            list.push({
              id:v.id,
              title:v.snippet.title,
              thumbnail:v.snippet.thumbnails?.medium?.url||`https://i.ytimg.com/vi/${v.id}/mqdefault.jpg`,
              viewCount:views,
              publishedAt:v.snippet.publishedAt,
              mutantIndex:(subs>0?(views/subs).toFixed(2):'0.00'),
              __ch:{subscriberCount:subs}
            });
          });
        } catch(e) {
          console.error('Error fetching video details:', e);
        }
      }
    }
    
    sortVideoCards(list,qs('sort-mutant').value);
    renderVideoList(list,'mutant-list','mutant-keywords');
  } catch(e) {
    console.error('Error refreshing mutant videos:', e);
    qs('mutant-list').innerHTML=`<div class="error-message">ëŒì—°ë³€ì´ ì˜ìƒì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${e.message}</div>`;
  }
}

/* ìµœì‹  ì˜ìƒ */
async function refreshLatest(){
  try {
    const channels=await getAllChannels();
    const out=[];
    
    for(const ch of channels){
      await ensureUploadsAndLatest(ch);
      if(!ch.uploadsPlaylistId) continue;
      
      let next=null, found=null;
      while(!found){
        try {
          const pl=await yt('playlistItems',{
            part:'snippet,contentDetails',
            playlistId:ch.uploadsPlaylistId,
            maxResults:10,
            pageToken:next||''
          });
          const ids=(pl.items||[]).map(i=>i.contentDetails.videoId); 
          if(!ids.length) break;
          
          const d=await yt('videos',{
            part:'snippet,statistics,contentDetails',
            id:ids.join(',')
          });
          
          for(const v of (d.items||[])){
            if(seconds(v.contentDetails.duration)>180){
              const views=parseInt(v.statistics.viewCount||'0',10);
              const subs=parseInt(ch.subscriberCount||'1',10);
              out.push({
                id:v.id,
                title:v.snippet.title,
                thumbnail:v.snippet.thumbnails?.medium?.url||`https://i.ytimg.com/vi/${v.id}/mqdefault.jpg`,
                viewCount:views,
                publishedAt:v.snippet.publishedAt,
                mutantIndex:subs>0?(views/subs).toFixed(2):'0.00',
                __ch:{subscriberCount:subs}
              });
              found=true; 
              break;
            }
          }
          next=pl.nextPageToken; 
          if(!next) break;
        } catch(e) {
          console.error('Error fetching latest videos:', e);
          break;
        }
      }
    }
    
    sortVideoCards(out,qs('sort-latest').value);
    renderVideoList(out,'latest-list','latest-keywords');
  } catch(e) {
    console.error('Error refreshing latest videos:', e);
    qs('latest-list').innerHTML=`<div class="error-message">ìµœì‹  ì˜ìƒì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${e.message}</div>`;
  }
}

/* ì„¹ì…˜ ê°±ì‹  */
async function refreshAll(which){
  if(!hasKeys()) {
    toast('API í‚¤ë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  try {
    if(!which || which==='channels') await refreshChannels();
    if(!which || which==='mutant') await refreshMutant();
    if(!which || which==='latest') await refreshLatest();
  } catch(e) {
    console.error('Error in refreshAll:', e);
    toast('ë°ì´í„° ê°±ì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message);
  }
}

/* ëª¨ë‹¬ ê´€ë¦¬ */
function openModal(id){ qs(id).style.display='flex'; }
function closeModal(id){ qs(id).style.display='none'; }

/* ë“œë˜ê·¸ ê¸°ëŠ¥ */
function initDrag(){ 
  const el=qs('columns'); 
  const saved=localStorage.getItem('colOrder'); 
  if(saved){ 
    saved.split(',').forEach(k=>{ 
      const sec=el.querySelector(`[data-col="${k}"]`); 
      if(sec) el.appendChild(sec); 
    }); 
  } 
  Sortable.create(el,{
    animation:150,
    handle:'.col-head',
    onSort:()=>{
      const keys=[...el.children].map(n=>n.getAttribute('data-col')); 
      localStorage.setItem('colOrder',keys.join(','));
    }
  }); 
}

/* ì±„ë„ ê²€ìƒ‰ */
const CH_PSIZE=5; 
let chCache=[], chPage=1;

const daysAgoStr=iso=>{ 
  if(!iso) return '-'; 
  const d=moment(iso); 
  const diff=moment().diff(d,'days'); 
  if(diff<=0) return 'ì˜¤ëŠ˜'; 
  if(diff===1) return '1ì¼ ì „'; 
  return `${diff}ì¼ ì „`; 
};

async function renderChPage(){
  const list=qs('ch-results'); 
  list.innerHTML='';
  const items=chCache.slice((chPage-1)*CH_PSIZE, chPage*CH_PSIZE);
  
  if(!items.length){ 
    list.innerHTML='<div class="muted">ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; 
    qs('ch-pagination').innerHTML='';
    return;
  }
  
  items.forEach(ch=>{
    const row=document.createElement('div');
    row.className='result-row';
    row.innerHTML=`
      <img class="r-avatar" src="${ch.snippet.thumbnails?.default?.url||''}" alt="">
      <div>
        <div class="r-title">${ch.snippet.title}</div>
        <div class="r-sub">${ch.snippet.description ? ch.snippet.description.substring(0,100)+'...' : 'ì„¤ëª… ì—†ìŒ'}</div>
        <div class="r-sub">êµ¬ë…ì: ${fmt(ch.statistics?.subscriberCount||'0')} | ì˜ìƒ: ${fmt(ch.statistics?.videoCount||'0')}</div>
      </div>
      <button class="btn" data-add-ch="${ch.id}">ì¶”ê°€</button>
    `;
    
    row.querySelector('[data-add-ch]').onclick=async()=>{
      const button = row.querySelector('[data-add-ch]');
      const originalText = button.textContent;
      
      try {
        button.textContent = 'ì¶”ê°€ ì¤‘...';
        button.disabled = true;
        
        const success = await addChannelById(ch.id);
        if(success) {
          button.textContent = 'ì™„ë£Œ!';
          button.style.background = '#1db954';
          setTimeout(() => closeModal('modal-add'), 1000);
        } else {
          button.textContent = originalText;
          button.disabled = false;
        }
      } catch(e) {
        console.error('ì±„ë„ ì¶”ê°€ ë²„íŠ¼ ì˜¤ë¥˜:', e);
        button.textContent = originalText;
        button.disabled = false;
        toast('ì±„ë„ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    };
    
    list.appendChild(row);
  });
  
  // í˜ì´ì§€ë„¤ì´ì…˜
  const totalPages=Math.ceil(chCache.length/CH_PSIZE);
  const pg=qs('ch-pagination');
  pg.innerHTML='';
  
  if(totalPages>1){
    for(let i=1;i<=totalPages;i++){
      const btn=document.createElement('button');
      btn.textContent=i;
      btn.className = i===chPage ? 'active' : '';
      btn.onclick=()=>{chPage=i; renderChPage();};
      pg.appendChild(btn);
    }
  }
}

/* ì±„ë„ ê²€ìƒ‰ */
async function searchChannels(){
  const q=qs('ch-query').value.trim();
  if(!q) {
    showError('ch-results', 'ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  if(!hasKeys()) {
    showError('ch-results', 'API í‚¤ë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  // ë¡œë”© í‘œì‹œ
  qs('ch-results').innerHTML = '<div class="muted">ê²€ìƒ‰ ì¤‘...</div>';
  qs('ch-pagination').innerHTML = '';
  
  try {
    console.log('ì±„ë„ ê²€ìƒ‰ ì‹œì‘:', q);
    
    const res=await yt('search',{
      part:'snippet',
      q:q,
      type:'channel',
      maxResults:25
    });
    
    console.log('ì±„ë„ ê²€ìƒ‰ ê²°ê³¼:', res);
    
    if(!res.items || res.items.length===0){
      qs('ch-results').innerHTML='<div class="muted">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      qs('ch-pagination').innerHTML='';
      return;
    }
    
    // ì±„ë„ ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const channelIds = res.items.map(item => item.snippet.channelId).filter(Boolean);
    console.log('ì±„ë„ ID ëª©ë¡:', channelIds);
    
    if(channelIds.length === 0) {
      qs('ch-results').innerHTML='<div class="muted">ìœ íš¨í•œ ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }
    
    const details = await yt('channels',{
      part:'snippet,statistics',
      id:channelIds.join(',')
    });
    
    console.log('ì±„ë„ ìƒì„¸ ì •ë³´:', details);
    
    chCache = details.items || [];
    chPage = 1;
    renderChPage();
    
  } catch(e) {
    console.error('Error searching channels:', e);
    showError('ch-results', `ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${e.message}`);
  }
}

/* ì˜ìƒ ê²€ìƒ‰ */
const VID_PSIZE=5;
let vidCache=[], vidPage=1;

async function renderVidPage(){
  const list=qs('vid-results'); 
  list.innerHTML='';
  const items=vidCache.slice((vidPage-1)*VID_PSIZE, vidPage*VID_PSIZE);
  
  if(!items.length){ 
    list.innerHTML='<div class="muted">ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; 
    qs('vid-pagination').innerHTML='';
    return;
  }
  
  items.forEach(v=>{
    const row=document.createElement('div');
    row.className='result-row';
    row.innerHTML=`
      <img class="r-thumb" src="${v.snippet.thumbnails?.default?.url||''}" alt="">
      <div>
        <div class="r-title">${v.snippet.title}</div>
        <div class="r-sub">ì±„ë„: ${v.snippet.channelTitle}</div>
        <div class="r-sub">ì—…ë¡œë“œ: ${daysAgoStr(v.snippet.publishedAt)}</div>
      </div>
      <button class="btn" data-add-ch-from-vid="${v.snippet.channelId}">ì±„ë„ ì¶”ê°€</button>
    `;
    
    row.querySelector('[data-add-ch-from-vid]').onclick=async()=>{
      const button = row.querySelector('[data-add-ch-from-vid]');
      const originalText = button.textContent;
      
      try {
        button.textContent = 'ì¶”ê°€ ì¤‘...';
        button.disabled = true;
        
        const success = await addChannelById(v.snippet.channelId);
        if(success) {
          button.textContent = 'ì™„ë£Œ!';
          button.style.background = '#1db954';
          setTimeout(() => closeModal('modal-add'), 1000);
        } else {
          button.textContent = originalText;
          button.disabled = false;
        }
      } catch(e) {
        console.error('ì˜ìƒì—ì„œ ì±„ë„ ì¶”ê°€ ì˜¤ë¥˜:', e);
        button.textContent = originalText;
        button.disabled = false;
        toast('ì±„ë„ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    };
    
    list.appendChild(row);
  });
  
  // í˜ì´ì§€ë„¤ì´ì…˜
  const totalPages=Math.ceil(vidCache.length/VID_PSIZE);
  const pg=qs('vid-pagination');
  pg.innerHTML='';
  
  if(totalPages>1){
    for(let i=1;i<=totalPages;i++){
      const btn=document.createElement('button');
      btn.textContent=i;
      btn.className = i===vidPage ? 'active' : '';
      btn.onclick=()=>{vidPage=i; renderVidPage();};
      pg.appendChild(btn);
    }
  }
}

async function searchVideos(){
  const q=qs('vid-query').value.trim();
  if(!q) return;
  
  try {
    const res=await yt('search',{
      part:'snippet',
      q:q,
      type:'video',
      videoDuration:'long',
      maxResults:25
    });
    
    if(!res.items || res.items.length===0){
      qs('vid-results').innerHTML='<div class="muted">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      qs('vid-pagination').innerHTML='';
      return;
    }
    
    vidCache = res.items;
    vidPage = 1;
    renderVidPage();
    
  } catch(e) {
    console.error('Error searching videos:', e);
    qs('vid-results').innerHTML=`<div class="error-message">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${e.message}</div>`;
  }
}

/* ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ */
document.addEventListener('click',e=>{
  // íƒ­ ì „í™˜
  if(e.target.classList.contains('tab')){
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tabpanel').forEach(p=>p.classList.remove('active'));
    e.target.classList.add('active'); 
    qs(e.target.dataset.tab).classList.add('active');
  }
  
  // ëŒì—°ë³€ì´ ê¸°ê°„ ë²„íŠ¼
  if(e.target.dataset.period){
    document.querySelectorAll('[data-period]').forEach(b=>b.classList.remove('active'));
    e.target.classList.add('active');
    currentMutantPeriod = e.target.dataset.period;
    refreshAll('mutant');
  }
});

document.addEventListener('DOMContentLoaded',()=>{
  // ì´ˆê¸°í™”
  initDrag();
  
  // API í‚¤ ëª¨ë‹¬
  qs('btn-api').onclick=()=>{ 
    const box=qs('api-inputs'); 
    box.innerHTML=''; 
    for(let i=0;i<5;i++){ 
      box.insertAdjacentHTML('beforeend',`<input class="api-inp" placeholder="API Key ${i+1}" value="${apiKeys[i]||''}">`);
    } 
    qs('api-test-result').textContent=''; 
    openModal('modal-api'); 
  };
  
  // ëª¨ë‹¬ ë‹«ê¸°
  document.querySelectorAll('.close').forEach(x=>x.onclick=e=>closeModal(e.target.dataset.close));
  
  // API í‚¤ íŒŒì¼ ì—…ë¡œë“œ
  qs('api-file-btn').onclick=()=>qs('api-file').click();
  qs('api-file').onchange=e=>{
    const f=e.target.files[0]; 
    if(!f) return;
    const r=new FileReader();
    r.onload=()=>{ 
      const keys=r.result.split(/\r?\n/).map(s=>s.trim()).filter(Boolean).slice(0,5);
      const box=qs('api-inputs'); 
      box.innerHTML='';
      for(let i=0;i<5;i++){ 
        box.insertAdjacentHTML('beforeend',`<input class="api-inp" placeholder="API Key ${i+1}" value="${keys[i]||''}">`); 
      }
      qs('api-test-result').textContent='íŒŒì¼ì—ì„œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. [ì €ì¥]ì„ ëˆŒëŸ¬ ë°˜ì˜í•˜ì„¸ìš”.';
    };
    r.readAsText(f);
  };
  
  // API í‚¤ ì €ì¥
  qs('api-save').onclick=()=>{
    const keys=[...document.querySelectorAll('.api-inp')].map(i=>i.value.trim()).filter(Boolean);
    setApiKeys(keys);
    toast('API í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    qs('api-test-result').textContent='';
    closeModal('modal-api');
    refreshAll();
  };
  
  // API í‚¤ ë‹¤ìš´ë¡œë“œ
  qs('api-download').onclick=()=>{
    if(!apiKeys.length){ 
      toast('ì €ì¥ëœ í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.'); 
      return; 
    }
    const blob=new Blob([apiKeys.join('\n')],{type:'text/plain'}); 
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); 
    a.href=url; 
    a.download='api_keys.txt'; 
    document.body.appendChild(a); 
    a.click(); 
    a.remove(); 
    URL.revokeObjectURL(url);
  };
  
  // API í‚¤ í…ŒìŠ¤íŠ¸
  qs('api-test').onclick=async()=>{
    const keys=[...document.querySelectorAll('.api-inp')].map(i=>i.value.trim()).filter(Boolean);
    const testKeys = keys.length? keys : apiKeys;
    if(!testKeys.length){ 
      qs('api-test-result').innerHTML='<span class="test-bad">ì €ì¥ëœ í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.</span>'; 
      return; 
    }
    
    qs('api-test-result').textContent = 'API í‚¤ í…ŒìŠ¤íŠ¸ ì¤‘...';
    
    let ok=false, lastErr='';
    for(const k of testKeys){
      try{
        const u=`${API}channels?part=id&id=UC_x5XG1OV2P6uZZ5FSM9Ttw&key=${encodeURIComponent(k)}`;
        const r=await fetch(u); 
        const j=await r.json();
        if(!j.error){ 
          ok=true; 
          break; 
        }
        lastErr = j.error.message||JSON.stringify(j.error);
      }catch(e){ 
        lastErr=e.message||String(e); 
      }
    }
    
    qs('api-test-result').innerHTML = ok
      ? '<span class="test-ok">âœ“ API í‚¤ê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤!</span>'
      : `<span class="test-bad">âœ— API í‚¤ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${lastErr}<br><small>Google Cloud Consoleì—ì„œ YouTube Data API v3 í™œì„±í™” ë° ë¦¬í¼ëŸ¬ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</small></span>`;
  };
  
  // ì±„ë„ ì¶”ê°€ ëª¨ë‹¬
  qs('btn-add-channel').onclick=()=>{
    if(!hasKeys()) {
      toast('ë¨¼ì € API í‚¤ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.');
      return;
    }
    openModal('modal-add');
  };
  
  // ì±„ë„ ê²€ìƒ‰
  qs('btn-ch-search').onclick=searchChannels;
  qs('ch-query').onkeydown=e=>{if(e.key==='Enter') searchChannels();};
  
  // ì˜ìƒ ê²€ìƒ‰
  qs('btn-vid-search').onclick=searchVideos;
  qs('vid-query').onkeydown=e=>{if(e.key==='Enter') searchVideos();};
  
  // URL ì§ì ‘ ì¶”ê°€
  qs('btn-url-add').onclick=async()=>{
    const input = qs('url-input').value.trim();
    if(!input) {
      showError('url-result', 'ì±„ë„ URL ë˜ëŠ” IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    if(!hasKeys()) {
      showError('url-result', 'API í‚¤ë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    console.log('URL ì…ë ¥ ì²˜ë¦¬:', input);
    
    let channelId = null;
    let extracted = extractChannelId(input);
    
    if (extracted) {
      if (extracted.type === 'id') {
        channelId = extracted.value;
      } else {
        // í•¸ë“¤ì´ë‚˜ ì±„ë„ëª…ì¸ ê²½ìš°, ê²€ìƒ‰ APIë¥¼ í†µí•´ ì±„ë„ IDë¥¼ ì°¾ìŒ
        try {
          showSuccess('url-result', `"${extracted.value}" ì±„ë„ ì •ë³´ë¥¼ ê²€ìƒ‰í•˜ëŠ” ì¤‘...`);
          
          const searchRes = await yt('search', {
            part: 'snippet',
            q: extracted.value,
            type: 'channel',
            maxResults: 1
          });
          
          if(searchRes.items && searchRes.items[0]) {
            channelId = searchRes.items[0].snippet.channelId;
            console.log('ê²€ìƒ‰ìœ¼ë¡œ ì°¾ì€ ì±„ë„ ID:', channelId);
          } else {
            throw new Error('ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          }
        } catch(e) {
          showError('url-result', `ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. URLì´ë‚˜ ì±„ë„ëª…ì„ í™•ì¸í•´ì£¼ì„¸ìš”. (${e.message})`);
          return;
        }
      }
    } else {
      showError('url-result', 'ìœ íš¨í•˜ì§€ ì•Šì€ ì±„ë„ URL ë˜ëŠ” IDì…ë‹ˆë‹¤.');
      return;
    }
    
    if(!channelId) {
      showError('url-result', 'ì±„ë„ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    try {
      showSuccess('url-result', 'ì±„ë„ì„ ì¶”ê°€í•˜ëŠ” ì¤‘...');
      const success = await addChannelById(channelId);
      if(success) {
        closeModal('modal-add');
        qs('url-input').value = '';
        qs('url-result').innerHTML = '';
      } else {
        // addChannelByIdì—ì„œ ì´ë¯¸ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ì¶”ê°€ ì²˜ë¦¬ ë¶ˆí•„ìš”
      }
    } catch(e) {
      showError('url-result', 'ì±„ë„ ì¶”ê°€ ì‹¤íŒ¨: ' + e.message);
    }
  };
  
  // ì •ë ¬ ë³€ê²½
  qs('sort-channels').onchange=()=>refreshAll('channels');
  qs('sort-mutant').onchange=()=>refreshAll('mutant');
  qs('sort-latest').onchange=()=>refreshAll('latest');
  
  // ì´ˆê¸° ë¡œë“œ
  if(hasKeys()) {
    refreshAll();
  } else {
    toast('API í‚¤ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.');
  }
});
</script>
</body>
</html>
